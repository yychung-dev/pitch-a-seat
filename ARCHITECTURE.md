# Architecture Notes

æœ¬æ–‡ä»¶è¨˜éŒ„ Pitch-A-Seat å°ˆæ¡ˆçš„æ¶æ§‹è¨­è¨ˆæ±ºç­–ã€æŠ€è¡“å¯¦ä½œç´°ç¯€ã€ä»¥åŠé–‹ç™¼éç¨‹ä¸­çš„å•é¡Œè§£æ±ºæ–¹æ¡ˆã€‚

**æ–‡ä»¶ç›®çš„**ï¼š

- è¨˜éŒ„ã€Œç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆã€çš„æ±ºç­–éç¨‹
- æ•´ç†é–‹ç™¼ä¸­é‡åˆ°çš„å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ
- ä½œç‚ºæŠ€è¡“é¢è©¦æ™‚çš„åƒè€ƒè³‡æ–™

**é©åˆé–±è®€è€…**ï¼š

- æƒ³äº†è§£å°ˆæ¡ˆæŠ€è¡“ç´°ç¯€çš„é¢è©¦å®˜
- æœªä¾†æ¥æ‰‹å°ˆæ¡ˆçš„é–‹ç™¼è€…
- è¤‡ç¿’ç”¨çš„è‡ªå·±

---

## Table of Contents

1. [System Design & Architecture](#1-system-design--architecture)
2. [Security Design](#2-security-design)
3. [Database Design](#3-database-design)
4. [Caching & Performance](#4-caching--performance)
5. [API Design](#5-api-design)
6. [CI/CD & DevOps](#6-cicd--devops)
7. [AWS Cloud Services](#7-aws-cloud-services)
8. [Design Patterns](#8-design-patterns)
9. [Future Improvements](#9-future-improvements)
10. [Development Notes](#10-development-notes)
    - [10.1 SQL Design & Tips](#101-sql-design--tips)
    - [10.2 API Design Details](#102-api-design-details)
    - [10.3 Model Layer Design](#103-model-layer-design)
    - [10.4 Python Fundamentals](#104-python-fundamentals)
    - [10.5 MySQL Fundamentals](#105-mysql-fundamentals)
    - [10.6 FastAPI Internals](#106-fastapi-internals)

---

## 1. System Design & Architecture

### ğŸ¯ æ¨è–¦æ¼”ç®—æ³•

### æ¼”ç®—æ³•æ¦‚è¿°

åŸºæ–¼æœƒå“¡çš„æ­·å²è¡Œç‚ºï¼ˆäº¤æ˜“ã€é ç´„ã€å–œæ„›çƒéšŠï¼‰è¨ˆç®—æ¯æ”¯çƒéšŠçš„åå¥½åˆ†æ•¸ï¼Œå†æ¨è–¦åŒ…å«é€™äº›çƒéšŠçš„æ¯”è³½ã€‚

### Step 1: åˆå§‹åŒ–çƒéšŠåˆ†æ•¸

```python
favorite_teams = get_member_favorite_teams(user_id)
team_scores = {team: 2.0 for team in favorite_teams}
# ä¾‹å¦‚ï¼š{"ä¸­ä¿¡å…„å¼Ÿ": 2.0, "çµ±ä¸€ç…": 2.0}
```

### Step 2: è¨ˆç®—äº¤æ˜“è²¢ç»

```python
for trade in trades:
    # days_diff: é€™ç­†äº¤æ˜“è·é›¢ä»Šå¤©å¹¾å¤©
    days_diff = (today - trade["created_at"].date()).days
    # ä¾‹å¦‚ï¼šä»Šå¤© 2/12ï¼Œäº¤æ˜“æ—¥ 2/10 â†’ days_diff = 2

    # weight: æŒ‡æ•¸è¡°æ¸›æ¬Šé‡ï¼ˆè¶Šè¿‘æœŸçš„äº¤æ˜“æ¬Šé‡è¶Šé«˜ï¼‰
    weight = 1.2 * math.exp(-0.01 * days_diff)
    # days_diff=0  â†’ weight â‰ˆ 1.2ï¼ˆæœ€é«˜ï¼‰
    # days_diff=30 â†’ weight â‰ˆ 0.89
    # days_diff=90 â†’ weight â‰ˆ 0.49

    # ç‚ºé€™ç­†äº¤æ˜“æ¶‰åŠçš„å…©æ”¯çƒéšŠåŠ åˆ†
    for team in [trade["team_home"], trade["team_away"]]:
        team_scores[team] = team_scores.get(team, 0) + weight
```

### Step 3: æ­£è¦åŒ–äº¤æ˜“å¾—åˆ†

```python
if trade_contributions:
    mean_trade = sum(trade_contributions) / len(trade_contributions)
    for team in team_scores:
        if team not in favorite_teams:
            # éå–œæ„›çƒéšŠï¼šæ¸›å»å¹³å‡å€¼ï¼Œé¿å…æ‰€æœ‰çƒéšŠåˆ†æ•¸éƒ½å¾ˆé«˜
            team_scores[team] = max(0, team_scores[team] - mean_trade)
```

**ç‚ºä»€éº¼è¦æ­£è¦åŒ–ï¼Ÿ**

- å¦‚æœä½¿ç”¨è€…æœ‰ 50 ç­†äº¤æ˜“ï¼Œæ‰€æœ‰çƒéšŠéƒ½æœƒç´¯ç©å¾ˆé«˜åˆ†æ•¸
- æ¸›å»å¹³å‡å€¼å¾Œï¼Œåªæœ‰ã€ŒçœŸæ­£åå¥½ã€çš„çƒéšŠæ‰æœƒä¿æŒé«˜åˆ†
- å–œæ„›çƒéšŠä¸æ¸›åˆ†ï¼Œç¢ºä¿å®ƒå€‘å§‹çµ‚æœ‰å„ªå‹¢

### Step 4: é ç´„è²¢ç»ï¼ˆåŒäº¤æ˜“é‚è¼¯ï¼‰

```python
weight = 1.0 * math.exp(-0.01 * days_diff)  # é ç´„æ¬Šé‡ç•¥ä½æ–¼äº¤æ˜“
```

### Step 5: è¨ˆç®—æ¨è–¦åˆ†æ•¸

```python
for game in games:
    # åŸºç¤åˆ†æ•¸ï¼šä¸»å®¢éšŠçš„çƒéšŠåˆ†æ•¸åŠ ç¸½
    score = team_scores.get(game["team_home"], 0) + team_scores.get(game["team_away"], 0)

    # ç†±é–€åŠ æ¬Šï¼šäº¤æ˜“é‡å¤§çš„æ¯”è³½é¡å¤–åŠ åˆ†
    score += 0.1 * game["trade_count"]
```

### Step 6: å†·å•Ÿå‹•è™•ç†

ç•¶æ¨è–¦ä¸è¶³ 5 å ´æ™‚ï¼Œè£œå……ç†±é–€æ¯”è³½ï¼š

```python
if len(top_games) < 5:
    needed = 5 - len(top_games)
    hot_games = get_hot_games_in_period(today, future_60_days, needed + 10)
    # å¤šæ’ˆ 10 ç­†ï¼Œç¢ºä¿éæ¿¾é‡è¤‡å¾Œé‚„å¤ 

    existing_ids = {g["game_id"] for g in top_games}
    for game in hot_games:
        if len(top_games) >= 5:
            break
        if game["game_id"] not in existing_ids:
            top_games.append({...})
            existing_ids.add(game["game_id"])
```

### æ¬Šé‡è¨­è¨ˆåœ–è§£

```
                    æ¬Šé‡
                      â”‚
                 1.2 â”€â”¼â”€ â˜… äº¤æ˜“ï¼ˆä»Šå¤©ï¼‰
                      â”‚    â•²
                 1.0 â”€â”¼â”€    â•²â”€ â˜… é ç´„ï¼ˆä»Šå¤©ï¼‰
                      â”‚       â•²
                 0.8 â”€â”¼â”€        â•²
                      â”‚          â•²
                 0.6 â”€â”¼â”€           â•²
                      â”‚             â•²
                 0.4 â”€â”¼â”€              â•²â”€ â˜… äº¤æ˜“ï¼ˆ90å¤©å‰ï¼‰
                      â”‚
                 0.2 â”€â”¼â”€
                      â”‚
                    0 â”¼â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â–º
                      0  15  30  45  60  75  90  å¤©æ•¸
```

### é‡é»æ•´ç†

| å•é¡Œ                     | å›ç­”è¦é»                                           |
| ------------------------ | -------------------------------------------------- |
| ç‚ºä»€éº¼ç”¨æŒ‡æ•¸è¡°æ¸›ï¼Ÿ       | è¿‘æœŸè¡Œç‚ºæ›´èƒ½ä»£è¡¨ç•¶å‰åå¥½ï¼Œé æœŸè¡Œç‚ºå½±éŸ¿æ‡‰è©²éæ¸›     |
| ç‚ºä»€éº¼è¦æ­£è¦åŒ–ï¼Ÿ         | é¿å…ç™¼ç”Ÿã€Œé«˜æ´»èºæœƒå“¡çš„æ‰€æœ‰çƒéšŠéƒ½é«˜åˆ†ã€ï¼Œä¿æŒå€åˆ†åº¦ |
| å–œæ„›çƒéšŠç‚ºä»€éº¼ä¸æ­£è¦åŒ–ï¼Ÿ | ç¢ºä¿æ˜ç¢ºè¡¨æ…‹çš„åå¥½ä¸æœƒè¢«ç¨€é‡‹                       |
| å†·å•Ÿå‹•å¦‚ä½•è™•ç†ï¼Ÿ         | è£œå……ç†±é–€æ¯”è³½ï¼Œç¢ºä¿æ–°æœƒå“¡ä¹Ÿæœ‰æ¨è–¦å…§å®¹               |
| ç‚ºä»€éº¼å¤šæ’ˆ 10 ç­†ï¼Ÿ       | éæ¿¾é‡è¤‡å¾Œå¯èƒ½ä¸å¤ ï¼Œé ç•™ç·©è¡                       |

---

### ğŸ¯ éåŒæ­¥å¯„ä¿¡æ¶æ§‹ï¼ˆSQS + Lambdaï¼‰

### æ¶æ§‹æ¦‚è¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              éåŒæ­¥å¯„ä¿¡æ¶æ§‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   FastAPI   â”‚      â”‚  SQS Queue  â”‚      â”‚   Lambda    â”‚      â”‚   SMTP    â”‚  â”‚
â”‚  â”‚  (EC2 ä¸Š)   â”‚ â”€â”€â”€â”€ â”‚  (AWS ä¸Š)   â”‚ â”€â”€â”€â”€ â”‚  (AWS ä¸Š)   â”‚ â”€â”€â”€â”€ â”‚  Server   â”‚  â”‚
â”‚  â”‚             â”‚      â”‚             â”‚      â”‚             â”‚      â”‚  (Gmail)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                                                        â”‚
â”‚        â”‚ SQS å¤±æ•—æ™‚ fallback                                                    â”‚
â”‚        â–¼                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                â”‚
â”‚  â”‚  åŒæ­¥å¯„ä¿¡   â”‚                                                                â”‚
â”‚  â”‚  (ç›´æ¥å‘¼å«  â”‚                                                                â”‚
â”‚  â”‚   SMTP)    â”‚                                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸‰å€‹æª”æ¡ˆçš„è·è²¬

| æª”æ¡ˆ              | ä½ç½®          | è·è²¬                                  |
| ----------------- | ------------- | ------------------------------------- |
| `email_utils.py`  | FastAPI (EC2) | å°å¤–çµ±ä¸€ä»‹é¢ï¼Œæ±ºå®šç”¨ SQS æˆ–åŒæ­¥å¯„ä¿¡   |
| `sqs_utils.py`    | FastAPI (EC2) | ç™¼é€ä»»å‹™åˆ° SQS Queueï¼ˆProducerï¼‰      |
| `email_sender.py` | AWS Lambda    | å¾ SQS å–å‡ºä»»å‹™ä¸¦å¯¦éš›å¯„ä¿¡ï¼ˆConsumerï¼‰ |

---

### å®Œæ•´æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®Œæ•´å¯„ä¿¡æµç¨‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  Model å±¤ (eg. commit_payment_success_tx)                                       â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”‚ 1. è³‡æ–™åº«æ“ä½œå®Œæˆ                                                        â”‚
â”‚       â”‚ 2. conn.commit()                                                        â”‚
â”‚       â”‚ 3. å‘¼å« send_email_async()                                              â”‚
â”‚       â–¼                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚         email_utils.py                  â”‚                                    â”‚
â”‚  â”‚         send_email_async()              â”‚                                    â”‚
â”‚  â”‚              â”‚                          â”‚                                    â”‚
â”‚  â”‚              â”‚ å‘¼å« send_email_to_queue()                                    â”‚
â”‚  â”‚              â–¼                          â”‚                                    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                                    â”‚
â”‚  â”‚  â”‚       sqs_utils.py              â”‚    â”‚                                    â”‚
â”‚  â”‚  â”‚       send_email_to_queue()     â”‚    â”‚                                    â”‚
â”‚  â”‚  â”‚            â”‚                    â”‚    â”‚                                    â”‚
â”‚  â”‚  â”‚            â”œâ”€â”€ æª¢æŸ¥ SQS_URL     â”‚    â”‚                                    â”‚
â”‚  â”‚  â”‚            â”œâ”€â”€ å–å¾— SQS Client  â”‚    â”‚                                    â”‚
â”‚  â”‚  â”‚            â”œâ”€â”€ ç™¼é€è¨Šæ¯åˆ° Queue â”‚    â”‚                                    â”‚
â”‚  â”‚  â”‚            â”‚                    â”‚    â”‚                                    â”‚
â”‚  â”‚  â”‚            â–¼                    â”‚    â”‚                                    â”‚
â”‚  â”‚  â”‚     return True / False         â”‚    â”‚                                    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                                    â”‚
â”‚  â”‚              â”‚                          â”‚                                    â”‚
â”‚  â”‚              â–¼                          â”‚                                    â”‚
â”‚  â”‚     if not success:                     â”‚                                    â”‚
â”‚  â”‚         send_email() â† Fallback åŒæ­¥å¯„ä¿¡â”‚                                    â”‚
â”‚  â”‚                                         â”‚                                    â”‚
â”‚  â”‚     å‡½æ•¸çµæŸï¼Œè¿”å› Model å±¤             â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  Model å±¤å‡½æ•¸çµæŸï¼Œè¿”å› Router å±¤                                                â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  API å›å‚³ {"status": "success"} çµ¦å‰ç«¯                                          â”‚
â”‚                                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                 â”‚
â”‚  ã€èˆ‡æ­¤åŒæ™‚ï¼Œåœ¨ AWS èƒŒæ™¯ã€‘                                                       â”‚
â”‚                                                                                 â”‚
â”‚  SQS Queue æœ‰æ–°è¨Šæ¯                                                             â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”‚ AWS è‡ªå‹•è§¸ç™¼                                                            â”‚
â”‚       â–¼                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚       email_sender.py (Lambda)          â”‚                                    â”‚
â”‚  â”‚       lambda_handler()                  â”‚                                    â”‚
â”‚  â”‚            â”‚                            â”‚                                    â”‚
â”‚  â”‚            â”œâ”€â”€ è§£æ SQS è¨Šæ¯            â”‚                                    â”‚
â”‚  â”‚            â”œâ”€â”€ æª¢æŸ¥è¨Šæ¯é¡å‹             â”‚                                    â”‚
â”‚  â”‚            â”œâ”€â”€ å–å‡º Email è³‡è¨Š          â”‚                                    â”‚
â”‚  â”‚            â”œâ”€â”€ å‘¼å« send_email()        â”‚                                    â”‚
â”‚  â”‚            â”‚                            â”‚                                    â”‚
â”‚  â”‚            â–¼                            â”‚                                    â”‚
â”‚  â”‚     å¯¦éš›å¯„å‡º Email                      â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  Lambda æ­£å¸¸çµæŸ â†’ SQS è‡ªå‹•åˆªé™¤è¨Šæ¯                                              â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ç”Ÿç”¢è€…/æ¶ˆè²»è€…æ¨¡å¼

| è§’è‰²               | èªªæ˜                  | åœ¨æœ¬å°ˆæ¡ˆä¸­              |
| ------------------ | --------------------- | ----------------------- |
| ç”Ÿç”¢è€…ï¼ˆProducerï¼‰ | æŠŠä»»å‹™æ”¾é€² Queue      | `send_email_to_queue()` |
| æ¶ˆè²»è€…ï¼ˆConsumerï¼‰ | å¾ Queue å–å‡ºä»»å‹™è™•ç† | `lambda_handler()`      |
| Queue              | æš«å­˜ä»»å‹™çš„ç·©è¡å€      | AWS SQS                 |

```
Producer                    Queue                     Consumer
(FastAPI)                   (SQS)                     (Lambda)
    â”‚                         â”‚                          â”‚
    â”‚  send_message()         â”‚                          â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
    â”‚                         â”‚                          â”‚
    â”‚                         â”‚  AWS è‡ªå‹•è§¸ç™¼            â”‚
    â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                         â”‚                          â”‚
    â”‚                         â”‚                          â”œâ”€â”€ è™•ç†ä»»å‹™
    â”‚                         â”‚                          â”‚
    â”‚                         â”‚  è™•ç†å®Œæˆï¼Œåˆªé™¤è¨Šæ¯      â”‚
    â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                         â”‚                          â”‚
```

---

### ã€ŒéåŒæ­¥å¯„ä¿¡ã€çš„çœŸæ­£å«ç¾©

| å‹•ä½œ                      | åŸ·è¡Œæ–¹å¼   | èªªæ˜                                 |
| ------------------------- | ---------- | ------------------------------------ |
| `send_email_async()`      | **åŒæ­¥**   | å‡½æ•¸åŸ·è¡Œå®Œæ‰è¿”å›ï¼ˆåªæ˜¯åç¨±æœ‰ asyncï¼‰ |
| `send_email_to_queue()`   | **åŒæ­¥**   | å‘¼å« SQS APIï¼Œç­‰å¾…å›æ‡‰               |
| `send_email()` (fallback) | **åŒæ­¥**   | å‘¼å« SMTPï¼Œç­‰å¾…å›æ‡‰                  |
| Lambda å–å‡ºä»»å‹™ä¸¦å¯„ä¿¡     | **éåŒæ­¥** | åœ¨èƒŒæ™¯åŸ·è¡Œï¼Œèˆ‡ API å®Œå…¨ç„¡é—œ          |

**é‡é»**ï¼šAPI åªç­‰å¾…ã€Œä»»å‹™æ”¾é€² Queueã€ï¼Œä¸ç­‰å¾…ã€Œå¯¦éš›å¯„ä¿¡ã€ã€‚

**ã€ŒéåŒæ­¥ã€æŒ‡çš„æ˜¯**ï¼šå¯¦éš›å¯„ä¿¡ç”± Lambda åœ¨èƒŒæ™¯è™•ç†ï¼ŒAPI ä¸éœ€è¦ç­‰å¾…å¯„ä¿¡å®Œæˆã€‚

**ã€ŒæŠŠä»»å‹™æ”¾é€² Queueã€æœ¬èº«æ˜¯åŒæ­¥çš„**ï¼š`send_email_to_queue` æœƒç­‰å¾… SQS å›æ‡‰ï¼ˆæˆåŠŸ/å¤±æ•—ï¼‰å¾Œæ‰è¿”å›ã€‚

---

### éŒ¯èª¤è™•ç†ç­–ç•¥ï¼šç‚ºä½•ã€Œæ°¸ä¸ raiseã€

#### è¨­è¨ˆåŸå‰‡

```
æ ¸å¿ƒåŠŸèƒ½ï¼ˆè³‡æ–™åº«æ“ä½œï¼‰          è¼”åŠ©åŠŸèƒ½ï¼ˆå¯„ä¿¡ï¼‰
        â”‚                           â”‚
        â”‚ commit æˆåŠŸ               â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                           â”‚ å¯èƒ½å¤±æ•—
        â”‚                           â”‚
        â–¼                           â–¼
   API æ‡‰å› 200              ä¸æ‡‰å½±éŸ¿ API çµæœ
```

#### å¦‚æœ raise æœƒç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ

```
Model å±¤
    â”‚
    â”œâ”€â”€ conn.commit()  â† æˆåŠŸ
    â”‚
    â”œâ”€â”€ send_email_async()
    â”‚       â”‚
    â”‚       â””â”€â”€ send_email_to_queue()
    â”‚               â”‚
    â”‚               â””â”€â”€ raise Exception  â† å¯„ä¿¡å¤±æ•—
    â”‚
    â”‚   ä¾‹å¤–å¾€ä¸Šæ‹‹
    â–¼
Router å±¤
    â”‚
    â””â”€â”€ åŒ…æˆ HTTP 500 å›çµ¦å‰ç«¯

çµæœï¼šè³‡æ–™åº«æˆåŠŸå¯«å…¥ï¼Œä½†å‰ç«¯æ”¶åˆ° 500ï¼Œèˆ‡çœŸå¯¦æƒ…æ³ä¸ç¬¦ï¼
```

#### ä¸‰å€‹æª”æ¡ˆçš„éŒ¯èª¤è™•ç†è¨­è¨ˆ

| æª”æ¡ˆ             | å‡½æ•¸                    | éŒ¯èª¤è™•ç†               | åŸå›               |
| ---------------- | ----------------------- | ---------------------- | ----------------- |
| `sqs_utils.py`   | `send_email_to_queue()` | return Falseï¼Œä¸ raise | è®“å‘¼å«ç«¯ fallback |
| `email_utils.py` | `send_email_async()`    | å‘¼å« fallback åŒæ­¥å¯„ä¿¡ | åŠŸèƒ½ä¸ä¸­æ–·        |
| `email_utils.py` | `send_email()`          | è¨˜ logï¼Œä¸ raise       | ä¸å½±éŸ¿æ ¸å¿ƒæµç¨‹    |

---

### Lambda èˆ‡ SQS çš„æ•´åˆæ©Ÿåˆ¶ (ğŸ“ SQS + Lambda + DLQ)

#### Lambda è™•ç†çµæœèˆ‡ SQS è¡Œç‚º

| Lambda è¡Œç‚º              | SQS åæ‡‰                                                   |
| ------------------------ | ---------------------------------------------------------- |
| æ­£å¸¸çµæŸï¼ˆreturnï¼‰       | AWS Lambda Service å‘¼å« SQS DeleteMessage APIï¼Œè¨Šæ¯è¢«åˆªé™¤  |
| æ‹‹å‡ºä¾‹å¤–ï¼ˆraiseï¼‰        | ä¸å‘¼å« DeleteMessageï¼Œè¨Šæ¯åœ¨ visibility timeout å¾Œé‡æ–°å¯è¦‹ |
| é‡è©¦è¶…é maxReceiveCount | è¨Šæ¯ç§»åˆ° Dead Letter Queue (DLQ)                           |

#### é‹ä½œåŸç†åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Lambda + SQS æ•´åˆæ©Ÿåˆ¶                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  1. SQS æŠŠè¨Šæ¯å‚³çµ¦ Lambda                                                       â”‚
â”‚     â”‚                                                                           â”‚
â”‚     â”‚ æ­¤æ™‚è¨Šæ¯é€²å…¥ã€Œè™•ç†ä¸­ã€ç‹€æ…‹ï¼ˆä¸å¯è¦‹ï¼‰                                        â”‚
â”‚     â”‚ visibility timeout é–‹å§‹å€’æ•¸ï¼ˆé è¨­ 30 ç§’ï¼‰                                  â”‚
â”‚     â–¼                                                                           â”‚
â”‚  2. Lambda åŸ·è¡Œ lambda_handler                                                  â”‚
â”‚     â”‚                                                                           â”‚
â”‚     â”œâ”€â”€ æ­£å¸¸çµæŸï¼ˆreturnï¼‰                                                      â”‚
â”‚     â”‚   â”‚                                                                       â”‚
â”‚     â”‚   â”‚ AWS Lambda Service å‘¼å« SQS çš„ DeleteMessage API                      â”‚
â”‚     â”‚   â–¼                                                                       â”‚
â”‚     â”‚   è¨Šæ¯è¢«åˆªé™¤ âœ“                                                            â”‚
â”‚     â”‚                                                                           â”‚
â”‚     â””â”€â”€ æ‹‹å‡ºä¾‹å¤–ï¼ˆraiseï¼‰                                                       â”‚
â”‚         â”‚                                                                       â”‚
â”‚         â”‚ AWS Lambda Service ä¸å‘¼å« DeleteMessage                               â”‚
â”‚         â”‚ è¨Šæ¯ç¶­æŒã€Œè™•ç†ä¸­ã€ç‹€æ…‹                                                 â”‚
â”‚         â–¼                                                                       â”‚
â”‚         visibility timeout åˆ°æœŸå¾Œï¼Œè¨Šæ¯é‡æ–°å¯è¦‹                                  â”‚
â”‚         â”‚                                                                       â”‚
â”‚         â–¼                                                                       â”‚
â”‚         ä¸‹ä¸€å€‹ Lambda å¯¦ä¾‹å–èµ°è¨Šæ¯ï¼Œé‡è©¦è™•ç†                                     â”‚
â”‚         â”‚                                                                       â”‚
â”‚         â–¼                                                                       â”‚
â”‚         è¶…é maxReceiveCountï¼ˆ3 æ¬¡ï¼‰â†’ è¨Šæ¯ç§»åˆ° DLQ                              â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Exception åˆ†é¡è™•ç†åŸå‰‡

**è¨­è¨ˆåŸå‰‡ï¼šå·²çŸ¥çš„æ°¸ä¹…æ€§å•é¡Œä¸é‡è©¦ï¼ŒæœªçŸ¥å•é¡Œé è¨­é‡è©¦ï¼ˆä¿å®ˆç­–ç•¥ï¼‰**

| éŒ¯èª¤é¡å‹          | è™•ç†æ–¹å¼ | åŸå›                              |
| ----------------- | -------- | -------------------------------- |
| `JSONDecodeError` | ä¸ raise | æ ¼å¼éŒ¯èª¤æ˜¯æ°¸ä¹…æ€§å•é¡Œï¼Œé‡è©¦ä¹Ÿæ²’ç”¨ |
| `SMTPException`   | ä¸ raise | å¯èƒ½æ˜¯æ”¶ä»¶äººç„¡æ•ˆï¼Œé‡è©¦ä¹Ÿæ²’ç”¨     |
| æœªé æœŸéŒ¯èª¤        | raise    | å¯èƒ½æ˜¯æš«æ™‚æ€§å•é¡Œï¼Œé‡è©¦å¯èƒ½æˆåŠŸ   |

#### æ‰¹æ¬¡è™•ç†çš„å½±éŸ¿

| æƒ…æ³           | ç™¼ç”Ÿçš„äº‹                                                                    |
| -------------- | --------------------------------------------------------------------------- |
| æŸä¸€ç­† raise   | æ•´æ‰¹ä»»å‹™ï¼ˆé€™æ¬¡ Lambda æ”¶åˆ°çš„æ‰€æœ‰ Recordsï¼‰éƒ½è¢«è¦–ç‚ºå¤±æ•—ï¼Œå…¨éƒ¨å›åˆ° Queue é‡è©¦ |
| æŸä¸€ç­†ä¸ raise | åªæœ‰é‚£ç­†ä¸æœƒé‡è©¦ï¼ˆè¢«è¦–ç‚ºæˆåŠŸåˆªé™¤ï¼‰ï¼Œå…¶ä»–æ­£å¸¸è™•ç†                            |

**çµè«–**ï¼šå°å·²çŸ¥çš„æ°¸ä¹…æ€§å•é¡Œä¸ raiseï¼Œé¿å…ä¸€ç­†å£è¨Šæ¯å½±éŸ¿æ•´æ‰¹ã€‚

---

### èˆ‰ä¾‹ï¼šç¥¨åˆ¸ä¸Šæ¶æµç¨‹ POST /api/sell_tickets

**å®Œæ•´æµç¨‹**ï¼š

1. **åœ–ç‰‡è™•ç†**
   - é©—è­‰å‰¯æª”åï¼ˆjpg, jpeg, pngï¼‰
   - é©—è­‰æª”æ¡ˆå¤§å°ï¼ˆâ‰¤ 5MBï¼‰
   - é©—è­‰åœ–ç‰‡æœ‰æ•ˆæ€§ï¼ˆä½¿ç”¨ PILï¼‰
   - ä¸Šå‚³è‡³ S3ï¼Œå–å¾— CloudFront URL

2. **ç¥¨åˆ¸è³‡æ–™è™•ç†**
   - è§£æå‰ç«¯å‚³ä¾†çš„ JSON å­—ä¸²
   - å°‡æ¯å¼µç¥¨åˆ¸å°æ‡‰çš„åœ–ç‰‡ URL æ•´ç†æˆ `img_map`

3. **Transaction æ“ä½œ**ï¼ˆåŒä¸€å€‹é€£ç·šå…§å®Œæˆï¼‰
   - æ–°å¢ç¥¨åˆ¸åˆ° `tickets_for_sale`
   - æŸ¥è©¢è©²å ´æ¬¡çš„é ç´„è³‡æ–™
   - æ¯”å°åƒ¹æ ¼èˆ‡åº§ä½æ¢ä»¶
   - è‹¥åŒ¹é…æˆåŠŸï¼šæ–°å¢ç«™å…§é€šçŸ¥ + æ”¶é›† Email è³‡æ–™
   - Commit

4. **å¯„é€é€šçŸ¥**ï¼ˆCommit æˆåŠŸå¾Œï¼‰
   - å°‡ Email ç™¼é€åˆ° SQS Queue

**ç‚ºä»€éº¼ Email è¦åœ¨ Commit å¾Œæ‰å¯„ï¼Ÿ**

é¿å…ã€Œè³‡æ–™åº«æ“ä½œå¤±æ•—ä½† Email å·²å¯„å‡ºã€çš„æƒ…æ³ï¼Œç¢ºä¿é€šçŸ¥èˆ‡è³‡æ–™ç‹€æ…‹ä¸€è‡´ã€‚

---

### å‡½æ•¸å‘¼å«æµç¨‹èˆ‡è¿”å›æ™‚æ©Ÿ

### åŸºæœ¬åŸå‰‡

Python å‡½æ•¸æ˜¯**åŒæ­¥åŸ·è¡Œ**çš„ï¼Œæ¯ä¸€è¡Œå¿…é ˆç­‰å‰ä¸€è¡Œå®Œæˆï¼Œæ‰æœƒåŸ·è¡Œä¸‹ä¸€è¡Œã€‚å‡½æ•¸åˆ°é”å°¾ç«¯ï¼ˆæˆ–åŸ·è¡Œ `return`ï¼‰æ™‚ï¼Œæµç¨‹æ‰æœƒè¿”å›å‘¼å«è™•ã€‚

```python
def outer_function():
    result = inner_function()  # â† å¿…é ˆç­‰ inner_function åŸ·è¡Œå®Œç•¢
    return result              # â† æ‰æœƒåŸ·è¡Œé€™è¡Œ
```

### Model å±¤å‘¼å« SQS çš„æµç¨‹

ç•¶ Transaction å’Œå¯„ä¿¡é‚è¼¯éƒ½åœ¨ Model å±¤æ™‚ï¼š

```
Router å±¤                          Model å±¤                         SQS ç›¸é—œå‡½æ•¸
    â”‚                                  â”‚                                   â”‚
    â”‚  update_order_and_ticket_status  â”‚                                   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                   â”‚
    â”‚                                  â”‚                                   â”‚
    â”‚                                  â”œâ”€â”€ Transaction æ“ä½œ                â”‚
    â”‚                                  â”œâ”€â”€ conn.commit()                   â”‚
    â”‚                                  â”‚                                   â”‚
    â”‚                                  â”‚  send_email_async()               â”‚
    â”‚                                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                  â”‚                                   â”œâ”€â”€ send_email_to_queue()
    â”‚                                  â”‚                                   â”‚   (åŒæ­¥ï¼šç­‰å¾… SQS å›æ‡‰)
    â”‚                                  â”‚                                   â”‚
    â”‚                                  â”‚                                   â”œâ”€â”€ if å¤±æ•—: send_email()
    â”‚                                  â”‚                                   â”‚   (åŒæ­¥ï¼šç­‰å¾… SMTP å›æ‡‰)
    â”‚                                  â”‚                                   â”‚
    â”‚                                  â”‚  send_email_async è¿”å›            â”‚
    â”‚                                  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                                  â”‚                                   â”‚
    â”‚  model å‡½æ•¸çµæŸï¼Œè¿”å›            â”‚                                   â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                   â”‚
    â”‚                                   â”‚                                   â”‚
    â”œâ”€â”€ return {"status": "success"}   â”‚                                   â”‚
    â–¼                                  â”‚                                   â”‚
```

---

### ç‚ºä»€éº¼æµç¨‹ä¸€å®šæœƒè¿”å› Router å±¤ï¼Ÿ

`send_email_async` è¨­è¨ˆç‚º**æ°¸ä¸ raise**ï¼š

```python
def send_email_async(to, subject, body) -> None:
    success = send_email_to_queue(...)  # â† å›å‚³ True/Falseï¼Œä¸ raise
    if not success:
        send_email(...)                  # â† å…§éƒ¨ try-exceptï¼Œä¸ raise
    # å‡½æ•¸æ­£å¸¸çµæŸï¼Œè¿”å› None
```

| æƒ…æ³                | `send_email_to_queue` | `send_email`         | çµæœ         |
| ------------------- | --------------------- | -------------------- | ------------ |
| SQS æˆåŠŸ            | return True           | ä¸åŸ·è¡Œ               | å‡½æ•¸æ­£å¸¸çµæŸ |
| SQS å¤±æ•—ï¼ŒSMTP æˆåŠŸ | return False          | æˆåŠŸ                 | å‡½æ•¸æ­£å¸¸çµæŸ |
| SQS å¤±æ•—ï¼ŒSMTP å¤±æ•— | return False          | catch ä¾‹å¤–ï¼Œè¨˜éŒ„ log | å‡½æ•¸æ­£å¸¸çµæŸ |

**çµè«–**ï¼šç„¡è«–ç™¼ç”Ÿä»€éº¼æƒ…æ³ï¼Œ`send_email_async` éƒ½æœƒæ­£å¸¸çµæŸï¼Œæµç¨‹ä¸€å®šæœƒè¿”å› Model å±¤ â†’ è¿”å› Router å±¤ã€‚

### æ™‚åºåœ–ï¼šè©³ç´°ç‰ˆ

```
æ™‚é–“è»¸ â†’

Router:  â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€>
              â”‚                                                     â”‚
              â”‚ å‘¼å« update_order_and_ticket_status                 â”‚ return success
              â–¼                                                     â”‚
Model:        â”œâ”€â”€ SELECT â”€â”€â”€ UPDATE â”€â”€â”€ INSERT â”€â”€â”€ commit â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¤
                                                            â”‚       â”‚
                                                            â”‚ å‘¼å«  â”‚ è¿”å›
                                                            â–¼       â”‚
send_email_async:                                           â”œâ”€â”€â”€â”€â”€â”€â”€â”¤
                                                            â”‚       â”‚
                                                      â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â” â”‚
                                                      â”‚ SQS æˆåŠŸ? â”‚ â”‚
                                                      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚
                                                       Yes  â”‚  No   â”‚
                                                            â”‚   â”‚   â”‚
                                                            â”‚   â–¼   â”‚
                                                            â”‚ send_email (fallback)
                                                            â”‚   â”‚   â”‚
                                                            â–¼   â–¼   â”‚
                                                         è¿”å› â”€â”€â”€â”€â”€>â”‚
                                                                    â”‚
                                                                    â–¼
                                                              API å›å‚³
```

### è¨­è¨ˆåŸå‰‡ç¸½çµ

| åŸå‰‡           | èªªæ˜                                             |
| -------------- | ------------------------------------------------ |
| Commit å„ªå…ˆ    | æ ¸å¿ƒåŠŸèƒ½ï¼ˆTransactionï¼‰å®Œæˆå¾Œï¼Œæ‰è™•ç†å¯„ä¿¡        |
| å¯„ä¿¡ä¸å½±éŸ¿æ ¸å¿ƒ | `send_email_async` æ°¸ä¸ raiseï¼Œä¸æœƒå°è‡´ API å¤±æ•— |
| æœ‰ Fallback    | SQS å¤±æ•—æ™‚ï¼Œé™ç´šç‚ºåŒæ­¥å¯„ä¿¡                       |
| å¯è¿½æº¯         | æ‰€æœ‰å¤±æ•—éƒ½æœ‰ log è¨˜éŒ„                            |

---

### SQS éåŒæ­¥å¯„ä¿¡ï¼šæµç¨‹èˆ‡è§€å¿µ

### ç™½è©±ç†è§£

**`send_email_async`ï¼ˆç™¼é€ä»»å‹™åˆ° SQS Queueï¼‰**ï¼š

- é€™æ˜¯ä¸€å€‹**åŒæ­¥**å‡½æ•¸
- åŠŸèƒ½æ˜¯ã€ŒæŠŠå¯„ä¿¡ä»»å‹™æ”¾é€² SQS Queueã€
- ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½æœƒåœ¨åšå®Œé€™å€‹ç™¼é€å‹•ä½œå¾Œæ­£å¸¸çµæŸ
- çµæŸå¾Œï¼Œæµç¨‹è‡ªå‹•è¿”å›å‘¼å«å®ƒçš„å‡½æ•¸ï¼ˆä¾‹å¦‚ Model å±¤çš„ `update_order_and_ticket_status`ï¼‰

**Lambda Functionï¼ˆå¯¦éš›åŸ·è¡Œå¯„ä¿¡ï¼‰**ï¼š

- é€™æ˜¯**éåŒæ­¥**é‹ä½œçš„
- è¨­è¨ˆæˆã€Œç•¶æœ‰ä»»å‹™è¢«æ”¾åˆ° SQS Queue æ™‚ï¼ŒAWS è‡ªå‹•è§¸ç™¼ Lambda ä¾†åŸ·è¡Œå¯„ä¿¡ã€
- é€™å€‹å¯¦éš›å¯„ä¿¡çš„å‹•ä½œæ˜¯åœ¨**èƒŒæ™¯åŸ·è¡Œ**ï¼Œèˆ‡ API å®Œå…¨ç„¡é—œ
- API ä¸æœƒç­‰å¾… Lambda åŸ·è¡Œå®Œç•¢

**å…©è€…çš„é—œä¿‚**ï¼š

- Model å±¤çš„ `update_order_and_ticket_status` åªèˆ‡ `send_email_async` æœ‰é—œ
- åªè¦ `send_email_async` æ­£å¸¸çµæŸï¼ˆä¸ raiseï¼‰ï¼Œ`update_order_and_ticket_status` å°±æœƒæ­£å¸¸çµæŸä¸¦è¿”å› Router å±¤
- Lambda æ˜¯å¦å¤–ç¨ç«‹é‹ä½œçš„ç¨‹å¼ï¼Œèˆ‡ `update_order_and_ticket_status` å‡½æ•¸ç„¡é—œ

### æµç¨‹èªªæ˜

```python
def update_order_and_ticket_status(...) -> None:
    # ... Transaction æ“ä½œ ...
    conn.commit()              # â† 1. commit åŸ·è¡Œå®Œç•¢å¾Œ

    send_email_async(...)      # â† 2. æ‰å‘¼å« send_email_async
                               #      send_email_async æ˜¯åŒæ­¥å‡½æ•¸ï¼ŒåŸ·è¡Œå®Œç•¢å¾Œæ‰æœƒè¿”å›
                               #      å…§éƒ¨è¨­è¨ˆç‚ºã€Œæ°¸ä¸ raiseã€ï¼Œç„¡è«–æˆåŠŸæˆ–å¤±æ•—éƒ½æ­£å¸¸çµæŸ

    # â† 3. send_email_async è¿”å›å¾Œï¼Œæœ¬å‡½æ•¸åˆ°é”å°¾ç«¯ï¼Œæµç¨‹è¿”å› Router å±¤
    # â† 4. çœŸæ­£çš„ã€ŒéåŒæ­¥ã€æ˜¯ Lambda å¾ SQS å–å‡ºä»»å‹™ä¸¦å¯„ä¿¡ï¼Œèˆ‡æœ¬å‡½æ•¸ç„¡é—œ
```

### ç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆï¼Ÿ

| è¨­è¨ˆæ±ºç­–                      | åŸå›                                             |
| ----------------------------- | ----------------------------------------------- |
| `send_email_async` æ°¸ä¸ raise | å¯„ä¿¡æ˜¯è¼”åŠ©åŠŸèƒ½ï¼Œä¸æ‡‰å½±éŸ¿æ ¸å¿ƒåŠŸèƒ½ï¼ˆTransactionï¼‰ |
| ä»»å‹™æ”¾é€² SQS å¾Œç«‹å³è¿”å›       | API å¿«é€Ÿå›æ‡‰ï¼Œä¸éœ€ç­‰å¾…å¯¦éš›å¯„ä¿¡å®Œæˆ              |
| Lambda åœ¨èƒŒæ™¯åŸ·è¡Œ             | å¯„ä¿¡å¯èƒ½éœ€è¦ 2-5 ç§’ï¼Œä¸æ‡‰é˜»å¡ API               |
| Lambda ç¨ç«‹é‹ä½œ               | å³ä½¿ Lambda å¤±æ•—ï¼ŒAPI æ—©å·²å›å‚³æˆåŠŸ              |

### æ™‚åºåœ–

```
API è«‹æ±‚
    â”‚
    â–¼
Transaction Commitï¼ˆæ ¸å¿ƒåŠŸèƒ½å®Œæˆï¼‰
    â”‚
    â–¼
send_email_async()ï¼ˆåŒæ­¥ï¼šæŠŠä»»å‹™æ”¾é€² Queueï¼‰
    â”‚
    â”œâ”€â”€ æˆåŠŸ â†’ ä»»å‹™é€²å…¥ SQS Queue
    â”‚
    â””â”€â”€ å¤±æ•— â†’ fallback åŒæ­¥å¯„ä¿¡ï¼ˆä¹Ÿä¸æœƒ raiseï¼‰
    â”‚
    â–¼
å‡½æ•¸çµæŸï¼Œè¿”å› Router å±¤
    â”‚
    â–¼
return {"status": "success"}
    â”‚
    â–¼
API å›å‚³çµ¦å‰ç«¯

                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    â•‘ ä»¥ä¸‹æ˜¯èƒŒæ™¯åŸ·è¡Œï¼Œèˆ‡ API å®Œå…¨ç„¡é—œ        â•‘
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                        â”‚
                                        â–¼
                                SQS Queue æœ‰æ–°ä»»å‹™
                                        â”‚
                                        â–¼
                              AWS è§¸ç™¼ Lambda Function
                                        â”‚
                                        â–¼
                              Lambda åŸ·è¡Œå¯¦éš›å¯„ä¿¡
                                        â”‚
                                        â”œâ”€â”€ æˆåŠŸ â†’ è¨Šæ¯å¾ Queue åˆªé™¤
                                        â”‚
                                        â””â”€â”€ å¤±æ•— â†’ é‡è©¦ â†’ è¶…éæ¬¡æ•¸é€² DLQ
```

### å¸¸è¦‹èª¤è§£é‡æ¸…

| èª¤è§£                               | æ­£ç¢ºç†è§£                                         |
| ---------------------------------- | ------------------------------------------------ |
| `send_email_async` æ˜¯éåŒæ­¥å‡½æ•¸    | å®ƒæ˜¯**åŒæ­¥**å‡½æ•¸ï¼Œåªæ˜¯åç¨±æœ‰ async               |
| å‘¼å« `send_email_async` å¾Œç«‹å³è¿”å› | å¿…é ˆç­‰å®ƒåŸ·è¡Œå®Œç•¢æ‰æœƒè¿”å›                         |
| API æœƒç­‰å¾… Email å¯„å‡º              | API åªç­‰å¾…ã€Œä»»å‹™æ”¾é€² Queueã€ï¼Œä¸ç­‰å¾…ã€Œå¯¦éš›å¯„ä¿¡ã€ |
| Lambda å¤±æ•—æœƒå½±éŸ¿ API              | Lambda æ˜¯ç¨ç«‹é‹ä½œï¼Œèˆ‡ API ç„¡é—œ                   |

---

### Lambda è§¸ç™¼ä¾†æºæ¯”è¼ƒ

| è§¸ç™¼ä¾†æº        | ç”¨é€”         | statusCode è¦æ±‚             | body æ ¼å¼è¦æ±‚                      |
| --------------- | ------------ | --------------------------- | ---------------------------------- |
| **SQS**         | èƒŒæ™¯ä»»å‹™è™•ç† | ä¸éœ€è¦ï¼ˆçœ‹æœ‰æ²’æœ‰ raiseï¼‰    | ä¸éœ€è¦ï¼ˆAWS ä¸çœ‹ bodyï¼‰            |
| **API Gateway** | HTTP API     | **å¿…é ˆ**ï¼ˆHTTP éœ€è¦ç‹€æ…‹ç¢¼ï¼‰ | **å¿…é ˆæ˜¯å­—ä¸²**ï¼ˆHTTP body æ˜¯å­—ä¸²ï¼‰ |

#### æœ¬å°ˆæ¡ˆçš„è¨­è¨ˆ

```python
# é›–ç„¶æ˜¯ SQS è§¸ç™¼ï¼Œä½†ä¿æŒæ¨™æº–æ ¼å¼
result = {
    'statusCode': 200,
    'body': json.dumps({
        'message': 'completed',
        'success': success_count,
        'failed': fail_count,
        'total': len(event['Records'])
    })
}
```

**ä¿æŒæ¨™æº–æ ¼å¼çš„å¥½è™•**ï¼š

- ä¸€è‡´æ€§ï¼šæ‰€æœ‰ Lambda éƒ½ç”¨ç›¸åŒæ ¼å¼ï¼Œæ–¹ä¾¿ç¶­è­·
- å¯æ“´å±•ï¼šæœªä¾†å¦‚æœè¦åŠ  API Gateway è§¸ç™¼ï¼Œä¸ç”¨æ”¹
- å¯è®€æ€§ï¼šçœ‹ CloudWatch Logs æ™‚ï¼Œresult å…§å®¹æ¸…æ¥š

---

### Fallback æ©Ÿåˆ¶è¨­è¨ˆ

```
                    send_email_async()
                          â”‚
                          â–¼
              send_email_to_queue()
                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                           â”‚
       return True                 return False
            â”‚                           â”‚
            â–¼                           â–¼
     ä»»å‹™é€²å…¥ Queue              fallback: send_email()
            â”‚                           â”‚
            â”‚                           â”‚
            â–¼                           â–¼
    Lambda èƒŒæ™¯å¯„ä¿¡              ç›´æ¥åŒæ­¥å¯„ä¿¡
```

**è¨­è¨ˆåŸå‰‡**ï¼š

1. SQS æ­£å¸¸æ™‚ï¼šå¿«é€Ÿå°‡ä»»å‹™æ”¾é€² Queueï¼ŒAPI å¯æ›´å¿«å›æ‡‰
2. SQS ç•°å¸¸æ™‚ï¼šé™ç´šæˆåŒæ­¥å¯„ä¿¡ï¼ŒåŠŸèƒ½ä¸ä¸­æ–·
3. åŒæ­¥å¯„ä¿¡å¤±æ•—æ™‚ï¼šè¨˜ log ä½†ä¸ raiseï¼Œä¸å½±éŸ¿æ ¸å¿ƒæµç¨‹

---

### å…©å€‹ send_email å‡½æ•¸çš„æ¯”è¼ƒ

| é …ç›®     | FastAPI ç‰ˆ (`email_utils.py`) | Lambda ç‰ˆ (`email_sender.py`)   |
| -------- | ----------------------------- | ------------------------------- |
| ä½ç½®     | EC2 ä¸Š                        | AWS Lambda ä¸Š                   |
| è§’è‰²     | Fallback å‚™æ´                 | ä¸»è¦å¯„ä¿¡æ–¹å¼                    |
| éŒ¯èª¤è™•ç† | è¨˜ logï¼Œä¸ raise              | è®“éŒ¯èª¤å¾€ä¸Šæ‹‹çµ¦ `lambda_handler` |
| é‡è©¦æ©Ÿåˆ¶ | ç„¡ï¼ˆå¤±æ•—å°±è¨˜ logï¼‰            | æœ‰ï¼ˆSQS æœƒé‡è©¦ï¼Œæœ€å¤š 3 æ¬¡ï¼‰     |
| ç›£æ§æ–¹å¼ | éœ€æ‰‹å‹•è¨­å®š CloudWatch Agent   | è‡ªå‹•æ•´åˆ CloudWatch Logs        |

**ç‚ºä»€éº¼ Lambda ç‰ˆè®“éŒ¯èª¤å¾€ä¸Šæ‹‹ï¼Ÿ**

å› ç‚º Lambda çš„ä¸»è¦è·è²¬å°±æ˜¯ã€Œå¯„ä¿¡ã€ï¼Œå¤±æ•—æ™‚æ‡‰è©²ï¼š

1. è®“ `lambda_handler` çš„ `try-except` æ¥ä½
2. æ ¹æ“šéŒ¯èª¤é¡å‹æ±ºå®šæ˜¯å¦é‡è©¦
3. è¶…éé‡è©¦æ¬¡æ•¸é€²å…¥ DLQï¼Œè§¸ç™¼å‘Šè­¦é€šçŸ¥é–‹ç™¼è€…

---

### messageId çš„ç”¨é€”

| é …ç›®     | èªªæ˜                            |
| -------- | ------------------------------- |
| åˆ†é…æ™‚æ©Ÿ | è¨Šæ¯é€²å…¥ SQS Queue æ™‚           |
| é‡è©¦æ™‚   | æ²¿ç”¨åŸæœ¬çš„ç·¨è™Ÿï¼Œä¸æœƒæ”¹è®Š        |
| ç”¨é€”     | è¿½è¹¤åŒä¸€ç­†è¨Šæ¯çš„è™•ç†æ­·ç¨‹        |
| Debug    | å¯ä¸²é€£ FastAPI å’Œ Lambda çš„ log |

---

## 2. Security Design

### ğŸ¯ Race Condition Prevention

### Race Conditionï¼ˆç«¶çˆ­æ¢ä»¶ï¼‰

#### å®šç¾©

**Race Condition** æ˜¯æŒ‡å¤šå€‹ä¸¦ç™¼æ“ä½œåŒæ™‚å­˜å–å…±äº«è³‡æºæ™‚ï¼Œå› ç‚ºåŸ·è¡Œé †åºçš„ä¸ç¢ºå®šæ€§ï¼Œå°è‡´çµæœä¸ç¬¦åˆé æœŸã€‚

#### æœ¬å°ˆæ¡ˆçš„å…©å€‹ Race Condition ç™¼ç”Ÿé»

| ç™¼ç”Ÿé»               | å‡½æ•¸                             | å¾Œæœ                             | åš´é‡ç¨‹åº¦ |
| -------------------- | -------------------------------- | -------------------------------- | -------- |
| å¤šäººåŒæ™‚ç™¼é€åª’åˆè«‹æ±‚ | `create_order`                   | åŒä¸€å¼µç¥¨ç”¢ç”Ÿå¤šç­†ã€Œåª’åˆä¸­ã€è¨‚å–®   | **ä½**   |
| è³£å®¶å¿«é€Ÿæ¥å—å¤šç­†è¨‚å–® | `update_order_and_ticket_status` | åŒä¸€å¼µç¥¨ç”¢ç”Ÿå¤šç­†ã€Œåª’åˆæˆåŠŸã€è¨‚å–® | **é«˜**   |

---

#### Race Condition 1ï¼šcreate_orderï¼ˆå½±éŸ¿è¼ƒå°ï¼‰

**å•é¡Œèªªæ˜**

```python
def create_order(ticket_id: int, buyer_id: int) -> None:
    # Step 1: æª¢æŸ¥ç¥¨åˆ¸æ˜¯å¦å·²å”®å‡º
    cursor.execute("SELECT is_sold FROM tickets_for_sale WHERE id = %s", (ticket_id,))
    if ticket["is_sold"]:
        raise HTTPException(status_code=400, detail="æ­¤ç¥¨åˆ¸å·²å”®å‡º")

    # â† é€™è£¡æœ‰æ™‚é–“å·®ï¼

    # Step 2: INSERT æ–°è¨‚å–®ï¼ˆç‹€æ…‹ç‚ºã€Œåª’åˆä¸­ã€ï¼‰
    cursor.execute("INSERT INTO orders ...")

    conn.commit()
```

**å¯¦éš›æƒ…å¢ƒ**

å ´æ™¯ï¼šæœ‰ä¸€å¼µç¥¨åˆ¸ `ticket_id=100`ï¼Œå…©å€‹è²·å®¶ A å’Œ B **å¹¾ä¹åŒæ™‚**æƒ³è¦é€™å¼µç¥¨ã€‚

```
æ™‚é–“è»¸ â†’

è²·å®¶ A:  â”€â”€â”€ [SELECT æª¢æŸ¥] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [INSERT è¨‚å–®] â”€â”€â”€ [commit]
                  â†“
              ç¥¨åˆ¸æœªå”®å‡º âœ“

è²·å®¶ B:  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [SELECT æª¢æŸ¥] â”€â”€â”€ [INSERT è¨‚å–®] â”€â”€â”€ [commit]
                            â†“
                        ç¥¨åˆ¸æœªå”®å‡º âœ“
                        ï¼ˆA é‚„æ²’ commitï¼Œis_sold é‚„æ˜¯ Falseï¼‰
```

**çµæœ**ï¼šåŒä¸€å¼µç¥¨ç”¢ç”Ÿäº†**å…©ç­†ã€Œåª’åˆä¸­ã€çš„è¨‚å–®**ã€‚

**ç‚ºä»€éº¼å½±éŸ¿è¼ƒå°ï¼Ÿ**

å› ç‚ºã€Œåª’åˆä¸­ã€åªæ˜¯è¡¨ç¤ºè²·å®¶æå‡ºäº†è«‹æ±‚ï¼Œç¥¨åˆ¸é‚„æ²’æœ‰çœŸæ­£è³£å‡ºã€‚

```
è¨‚å–®ç”Ÿå‘½é€±æœŸï¼š

è²·å®¶ç™¼é€åª’åˆè«‹æ±‚ â†’ è¨‚å–®ç‹€æ…‹ã€Œåª’åˆä¸­ã€ï¼ˆå¯ä»¥æœ‰å¤šç­†ï¼‰
                        â†“
è³£å®¶æ¥å—å…¶ä¸­ä¸€ç­† â†’ è©²ç­†è¨‚å–®è®Šæˆã€Œåª’åˆæˆåŠŸã€ï¼Œç¥¨åˆ¸ is_sold = True
                        â†“
                    å…¶ä»–ã€Œåª’åˆä¸­ã€çš„è¨‚å–®ï¼šè³£å®¶æ‹’çµ•ï¼Œæˆ–ç¶­æŒã€Œåª’åˆä¸­ã€
```

| æ­¥é©Ÿ | ç™¼ç”Ÿçš„äº‹                                      |
| ---- | --------------------------------------------- |
| 1    | è²·å®¶ A å’Œ B åŒæ™‚å°ç¥¨åˆ¸ 100 ç™¼é€åª’åˆè«‹æ±‚       |
| 2    | ç”¢ç”Ÿå…©ç­†ã€Œåª’åˆä¸­ã€çš„è¨‚å–®ï¼ˆè¨‚å–® #1 å’Œ #2ï¼‰     |
| 3    | è³£å®¶åœ¨ã€Œæˆ‘çš„å”®ç¥¨ã€é é¢çœ‹åˆ°å…©ç­†åª’åˆè«‹æ±‚        |
| 4    | è³£å®¶é¸æ“‡æ¥å—è¨‚å–® #1ï¼ˆè²·å®¶ Aï¼‰                 |
| 5    | è¨‚å–® #1 è®Šæˆã€Œåª’åˆæˆåŠŸã€ï¼Œç¥¨åˆ¸ is_sold = True |
| 6    | è³£å®¶æ‹’çµ•è¨‚å–® #2ï¼Œæˆ–è¨‚å–® #2 ç¶­æŒã€Œåª’åˆä¸­ã€     |

**çµè«–**ï¼š

- æœ€å¤šå°±æ˜¯ç”¢ç”Ÿå¤šç­†ã€Œåª’åˆä¸­ã€çš„è¨‚å–®
- è³£å®¶åªæœƒæ¥å—å…¶ä¸­ä¸€ç­†
- ä¸æœƒé€ æˆã€ŒåŒä¸€å¼µç¥¨è³£çµ¦å…©å€‹äººã€çš„åš´é‡å•é¡Œ
- çœŸæ­£æ±ºå®šèª°è²·åˆ°ç¥¨çš„æ˜¯ã€Œè³£å®¶æ¥å—åª’åˆã€ï¼Œè€Œéã€Œç™¼é€åª’åˆè«‹æ±‚ã€

---

#### Race Condition 2ï¼šupdate_order_and_ticket_statusï¼ˆæ½›åœ¨åš´é‡å•é¡Œï¼‰

**å•é¡Œèªªæ˜**

å¦‚æœè³£å®¶å¿«é€Ÿé»æ“Šå¤šå€‹ã€Œæ¥å—ã€æŒ‰éˆ•å‘¢ï¼Ÿ

```
æ™‚é–“è»¸ â†’

æ¥å—è¨‚å–® #1:  â”€â”€â”€ [æª¢æŸ¥ç‹€æ…‹=åª’åˆä¸­ âœ“] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ [UPDATE åª’åˆæˆåŠŸ] â”€â”€â”€ [UPDATE is_sold=True] â”€â”€â”€ [commit]

æ¥å—è¨‚å–® #2:  â”€â”€â”€â”€â”€â”€â”€â”€ [æª¢æŸ¥ç‹€æ…‹=åª’åˆä¸­ âœ“] â”€â”€â”€ [UPDATE åª’åˆæˆåŠŸ] â”€â”€â”€ [UPDATE is_sold=True] â”€â”€â”€ [commit]
                              â†‘
                        è¨‚å–® #2 çš„ç‹€æ…‹ç¢ºå¯¦æ˜¯ã€Œåª’åˆä¸­ã€
                        æ­¤æ™‚è¨‚å–® #1 é‚„æ²’ commitï¼Œis_sold é‚„æ˜¯ False
```

**çµæœ**ï¼šåŒä¸€å¼µç¥¨æœ‰**å…©ç­†ã€Œåª’åˆæˆåŠŸã€çš„è¨‚å–®**ï¼é€™æ˜¯åš´é‡å•é¡Œï¼

**ç¾å¯¦ä¸­çš„ç·©è§£å› ç´ **

| ç·©è§£å› ç´      | èªªæ˜                                        |
| ------------ | ------------------------------------------- |
| å‰ç«¯ UI ä¿è­· | é»æ“Šã€Œæ¥å—ã€å¾ŒæŒ‰éˆ•æœƒ disable æˆ–é¡¯ç¤º loading |
| ä½¿ç”¨æƒ…å¢ƒ     | è³£å®¶é€šå¸¸ä¸æœƒåŒæ™‚å¿«é€Ÿé»æ“Šå¤šå€‹ã€Œæ¥å—ã€        |
| æ¥­å‹™æµç¨‹     | åŒä¸€å¼µç¥¨é€šå¸¸åªæœƒæœ‰å°‘æ•¸å¹¾å€‹è²·å®¶åŒæ™‚æ¶        |

---

### è§£æ±ºæ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1ï¼šåŸå­æ›´æ–°ï¼ˆAtomic Updateï¼‰

**æŠŠã€Œæª¢æŸ¥ã€å’Œã€Œæ›´æ–°ã€åˆä½µæˆä¸€å€‹ SQL æ“ä½œ**

```python
# âŒ éåŸå­æ“ä½œï¼ˆæœ‰ race condition é¢¨éšªï¼‰
cursor.execute("SELECT shipment_status FROM orders WHERE id = %s", (order_id,))
order = cursor.fetchone()
if order["shipment_status"] == "æœªå‡ºè²¨":
    cursor.execute("UPDATE orders SET shipment_status = 'å·²å‡ºè²¨' WHERE id = %s", (order_id,))

# âœ“ åŸå­æ›´æ–°ï¼ˆæŠŠæ¢ä»¶å¯«é€² WHEREï¼‰
cursor.execute("""
    UPDATE orders
    SET shipment_status = 'å·²å‡ºè²¨', shipped_at = %s
    WHERE id = %s
      AND seller_id = %s
      AND payment_status = 'å·²ä»˜æ¬¾'
      AND shipment_status = 'æœªå‡ºè²¨'
""", (now, order_id, seller_id))

if cursor.rowcount == 0:
    # æ¢ä»¶ä¸ç¬¦åˆï¼ŒæŸ¥è©¢å…·é«”åŸå› 
    ...
```

**åŸç†**ï¼šè³‡æ–™åº«ä¿è­‰å–®ä¸€ SQL èªå¥çš„åŸå­æ€§ï¼ŒWHERE æ¢ä»¶åœ¨åŸ·è¡Œæ™‚æ‰æª¢æŸ¥ï¼Œä¸æœƒæœ‰æ™‚é–“å·®ã€‚

#### æ–¹æ¡ˆ 2ï¼šè³‡æ–™åº«é–ï¼ˆSELECT FOR UPDATEï¼‰

```python
# ä½¿ç”¨ FOR UPDATE é–å®šè³‡æ–™åˆ—ï¼Œå…¶ä»– transaction å¿…é ˆç­‰å¾…
cursor.execute("""
    SELECT * FROM tickets_for_sale
    WHERE id = %s
    FOR UPDATE
""", (ticket_id,))
ticket = cursor.fetchone()

if not ticket["is_sold"]:
    cursor.execute("UPDATE tickets_for_sale SET is_sold = TRUE WHERE id = %s", (ticket_id,))
    cursor.execute("INSERT INTO orders ...")

conn.commit()  # é‡‹æ”¾é–
```

**æ³¨æ„**ï¼šé–æœƒé™ä½ä¸¦ç™¼æ•ˆèƒ½ï¼Œæ‡‰è¬¹æ…ä½¿ç”¨ã€‚

---

### æœ¬å°ˆæ¡ˆçš„æ‡‰ç”¨ç¯„ä¾‹

#### ç¯„ä¾‹ï¼šå‡ºè²¨ API ä½¿ç”¨åŸå­æ›´æ–°é˜²æ­¢é‡è¤‡å‡ºè²¨

```python
# routes/orders.py - mark_shipped_api

# ä½¿ç”¨åŸå­æ›´æ–°ï¼Œé˜²æ­¢ä½¿ç”¨è€…é€£æ“Šå‡ºè²¨æŒ‰éˆ•
rows_affected = update_order_shipped_atom(cursor, now, order_id, seller_id)

if rows_affected == 0:
    # æ›´æ–°å¤±æ•—ï¼ŒæŸ¥è©¢å…·é«”åŸå› 
    order = get_order_by_id(cursor, order_id)
    if order["shipment_status"] == "å·²å‡ºè²¨":
        raise HTTPException(status_code=400, detail="æ­¤è¨‚å–®å·²å‡ºè²¨")
    ...
```

```python
# models/order_model.py

def update_order_shipped_atom(cursor, shipped_time, order_id, seller_id) -> int:
    cursor.execute("""
        UPDATE orders
        SET shipment_status='å·²å‡ºè²¨', shipped_at=%s
        WHERE id=%s
          AND seller_id=%s
          AND payment_status='å·²ä»˜æ¬¾'
          AND shipment_status='æœªå‡ºè²¨'  -- é—œéµï¼šåªæ›´æ–°ã€Œæœªå‡ºè²¨ã€çš„è¨‚å–®
    """, (shipped_time, order_id, seller_id))

    return cursor.rowcount  # 0 è¡¨ç¤ºæ²’æ›´æ–°ï¼Œ1 è¡¨ç¤ºæˆåŠŸæ›´æ–°
```

**æ•ˆæœ**ï¼š

```
æ™‚é–“è»¸ â†’

è«‹æ±‚ 1: [UPDATE ... WHERE shipment_status='æœªå‡ºè²¨'] â†’ rowcount=1 â†’ ç¹¼çºŒå¯„ä¿¡
                                                           â†“
è«‹æ±‚ 2:                    [UPDATE ... WHERE shipment_status='æœªå‡ºè²¨'] â†’ rowcount=0 â†’ å›å‚³éŒ¯èª¤
                                                                              â†‘
                                              æ­¤æ™‚ shipment_status å·²ç¶“æ˜¯ 'å·²å‡ºè²¨'ï¼Œæ¢ä»¶ä¸ç¬¦
```

---

### Race Condition é˜²è­·æ•´ç†

| æƒ…å¢ƒ         | è§£æ±ºæ–¹æ¡ˆ                       | æœ¬å°ˆæ¡ˆç¯„ä¾‹                  |
| ------------ | ------------------------------ | --------------------------- |
| é˜²æ­¢é‡è¤‡æ“ä½œ | åŸå­æ›´æ–°ï¼ˆWHERE åŠ å…¥ç‹€æ…‹æ¢ä»¶ï¼‰ | `update_order_shipped_atom` |
| æ¶è³¼/ç§’æ®º    | SELECT FOR UPDATE              | é€²éšé˜²è­·æ–¹æ¡ˆ                |
| è¨ˆæ•¸å™¨å¢æ¸›   | `UPDATE SET count = count + 1` | -                           |
| å”¯ä¸€æ€§æª¢æŸ¥   | è³‡æ–™åº« UNIQUE ç´„æŸ             | -                           |
| å‰ç«¯é˜²è­·     | æŒ‰éˆ• disableã€loading ç‹€æ…‹     | é»æ“Šå¾Œ disable              |

---

### ğŸ“ ä¿¡ä»»é‚Šç•Œ

#### å®šç¾©

**ä¿¡ä»»é‚Šç•Œ**æ˜¯ç³»çµ±ä¸­ã€Œå¯ä¿¡ä»»å€åŸŸã€èˆ‡ã€Œä¸å¯ä¿¡ä»»å€åŸŸã€çš„åˆ†ç•Œç·šã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸å¯ä¿¡ä»»å€åŸŸ                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  ä½¿ç”¨è€…  â”‚     â”‚  å‰ç«¯    â”‚     â”‚ å¤–éƒ¨ API   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ â† ä¿¡ä»»é‚Šç•Œ
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¯ä¿¡ä»»å€åŸŸ                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  å¾Œç«¯    â”‚     â”‚ è³‡æ–™åº«  â”‚     â”‚ å…§éƒ¨æœå‹™    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒåŸå‰‡

**æ°¸é ä¸è¦ä¿¡ä»»ä¾†è‡ªä¸å¯ä¿¡ä»»å€åŸŸçš„è³‡æ–™**

å‰ç«¯å‚³ä¾†çš„ä»»ä½•è³‡æ–™éƒ½å¯èƒ½æ˜¯ï¼š

- è¢«ç«„æ”¹çš„ï¼ˆä½¿ç”¨è€…ä¿®æ”¹äº† JavaScript æˆ– API è«‹æ±‚ï¼‰
- éæœŸçš„ï¼ˆè³‡æ–™åœ¨å‚³è¼¸éç¨‹ä¸­å·²ç¶“æ”¹è®Šï¼‰
- æƒ¡æ„çš„ï¼ˆæ”»æ“Šè€…åˆ»æ„æ§‹é€ çš„è³‡æ–™ï¼‰

#### å¸¸è¦‹çš„ä¿¡ä»»é‚Šç•Œé©—è­‰

| é©—è­‰é …ç›®   | èªªæ˜                     | ç¯„ä¾‹                                    |
| ---------- | ------------------------ | --------------------------------------- |
| è³‡æ–™å­˜åœ¨æ€§ | ç¢ºèª ID å°æ‡‰çš„è³‡æ–™å­˜åœ¨   | `SELECT ... WHERE id = %s`              |
| æ¬Šé™æª¢æŸ¥   | ç¢ºèªä½¿ç”¨è€…æœ‰æ¬Šæ“ä½œè©²è³‡æ–™ | `order["seller_id"] != current_user_id` |
| ç‹€æ…‹æª¢æŸ¥   | ç¢ºèªè³‡æ–™è™•æ–¼å¯æ“ä½œçš„ç‹€æ…‹ | `order["status"] == "åª’åˆä¸­"`           |
| æ ¼å¼é©—è­‰   | ç¢ºèªè³‡æ–™æ ¼å¼æ­£ç¢º         | Pydantic Model é©—è­‰                     |

---

### å®‰å…¨æ€§è¨­è¨ˆï¼šä¿¡ä»»é‚Šç•Œ + Race Condition çš„çµ„åˆé˜²è­·

åœ¨ `create_order` å‡½æ•¸ä¸­ï¼ŒåŒæ™‚è™•ç†äº†å…©å€‹å•é¡Œï¼š

```python
def create_order(ticket_id: int, buyer_id: int) -> None:
    with get_connection() as conn:
        with conn.cursor(dictionary=True) as cursor:
            # ã€ä¿¡ä»»é‚Šç•Œã€‘é©—è­‰ç¥¨åˆ¸å­˜åœ¨ä¸”æœªå”®å‡º
            cursor.execute("SELECT is_sold, seller_id FROM tickets_for_sale WHERE id = %s", (ticket_id,))
            ticket = cursor.fetchone()
            if not ticket:
                raise HTTPException(status_code=404, detail="æ‰¾ä¸åˆ°ç¥¨åˆ¸")
            if ticket["is_sold"]:
                raise HTTPException(status_code=400, detail="æ­¤ç¥¨åˆ¸å·²å”®å‡º")

            # ã€ä¿¡ä»»é‚Šç•Œã€‘é©—è­‰è²·è³£é›™æ–¹ä¸åŒäºº
            if ticket["seller_id"] == buyer_id:
                raise HTTPException(status_code=400, detail="ä¸èƒ½å°è‡ªå·±è²©å”®çš„ç¥¨ç™¼é€åª’åˆè«‹æ±‚")

            # ã€Race Condition é¢¨éšªèªªæ˜ã€‘
            # - æ­¤è™•æª¢æŸ¥å’Œ INSERT ä¹‹é–“æœ‰æ™‚é–“å·®ï¼Œå¤šäººåŒæ™‚ç™¼é€åª’åˆè«‹æ±‚å¯èƒ½ç”¢ç”Ÿå¤šç­†ã€Œåª’åˆä¸­ã€è¨‚å–®
            # - å½±éŸ¿è¼ƒå°ï¼šå› ç‚ºã€Œåª’åˆä¸­ã€åªæ˜¯è«‹æ±‚ç‹€æ…‹ï¼Œè³£å®¶åªæœƒæ¥å—å…¶ä¸­ä¸€ç­†
            # - çœŸæ­£æ±ºå®šèª°è²·åˆ°ç¥¨çš„æ˜¯ã€Œè³£å®¶æ¥å—åª’åˆã€ï¼Œè€Œéã€Œç™¼é€åª’åˆè«‹æ±‚ã€
            cursor.execute("INSERT INTO orders ...")

            conn.commit()
```

---

### ğŸ¯ JWT Authentication

### JWT æ˜¯ä»€éº¼ï¼Ÿ

JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ä¸€ç¨®**ç„¡ç‹€æ…‹**çš„èº«ä»½é©—è­‰æ©Ÿåˆ¶ã€‚ä¼ºæœå™¨ä¸éœ€è¦åœ¨è³‡æ–™åº«æˆ– Session ä¸­å„²å­˜ç™»å…¥ç‹€æ…‹ï¼Œåªéœ€è¦é©—è­‰ Token çš„ç°½åå³å¯ç¢ºèªä½¿ç”¨è€…èº«ä»½ã€‚

### JWT çš„çµ„æˆçµæ§‹

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTIzLCJlbWFpbCI6InRlc3RAZXhhbXBsZS5jb20iLCJuYW1lIjoiVG9tIiwiZXhwIjoxNzY5OTEzOTMwfQ.abc123signature
â”‚                                      â”‚                                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Payload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€ Signature â”€â”€â”€
```

| éƒ¨åˆ†          | å…§å®¹                                       | èªªæ˜                 |
| ------------- | ------------------------------------------ | -------------------- |
| **Header**    | `{"alg": "HS256", "typ": "JWT"}`           | æ¼”ç®—æ³•å’Œé¡å‹         |
| **Payload**   | `{"id": 123, "email": "...", "exp": ...}`  | ä½¿ç”¨è€…è³‡æ–™å’ŒéæœŸæ™‚é–“ |
| **Signature** | `HMACSHA256(header + payload, SECRET_KEY)` | ç”¨å¯†é‘°ç°½åï¼Œé˜²æ­¢ç«„æ”¹ |

### ç‚ºä»€éº¼ä½¿ç”¨ JWTï¼Ÿ

| ç‰¹æ€§         | èªªæ˜                                       |
| ------------ | ------------------------------------------ |
| **ç„¡ç‹€æ…‹**   | ä¼ºæœå™¨ä¸éœ€å„²å­˜ Sessionï¼Œé©åˆåˆ†æ•£å¼ç³»çµ±     |
| **è‡ªåŒ…å«**   | Token æœ¬èº«åŒ…å«æ‰€æœ‰å¿…è¦è³‡è¨Šï¼Œä¸éœ€æŸ¥è©¢è³‡æ–™åº« |
| **è·¨åŸŸå‹å¥½** | å¯ä»¥è¼•é¬†åœ¨ä¸åŒæœå‹™é–“å‚³é                   |
| **å¯é©—è­‰**   | ç°½åæ©Ÿåˆ¶ç¢ºä¿è³‡æ–™æœªè¢«ç«„æ”¹                   |

### JWT vs Session æ¯”è¼ƒ

| é …ç›®     | JWT                    | Session                   |
| -------- | ---------------------- | ------------------------- |
| ç‹€æ…‹å„²å­˜ | å®¢æˆ¶ç«¯ï¼ˆTokenï¼‰        | ä¼ºæœå™¨ç«¯ï¼ˆè¨˜æ†¶é«”/è³‡æ–™åº«ï¼‰ |
| æ“´å±•æ€§   | é«˜ï¼ˆç„¡ç‹€æ…‹ï¼‰           | ä½ï¼ˆéœ€å…±äº« Sessionï¼‰      |
| å®‰å…¨æ€§   | éœ€é˜²æ­¢ Token æ´©æ¼      | éœ€é˜²æ­¢ Session åŠ«æŒ       |
| ç™»å‡ºæ©Ÿåˆ¶ | è¼ƒè¤‡é›œï¼ˆéœ€ç¶­è­·é»‘åå–®ï¼‰ | ç°¡å–®ï¼ˆåˆªé™¤ Sessionï¼‰      |

---

### JWT Token ç”Ÿæˆèˆ‡é©—è­‰ç¨‹å¼ç¢¼è§£æ

#### ç”Ÿæˆ Token

```python
def create_access_token(data: dict, expires_delta: Optional[timedelta] = None) -> str:
    # 1. è¤‡è£½ payloadï¼ˆé¿å…ä¿®æ”¹åŸå§‹è³‡æ–™ï¼‰
    to_encode = data.copy()  # {"id": 123, "email": "...", "name": "Tom"}

    # 2. è¨ˆç®—éæœŸæ™‚é–“
    expire = datetime.now(timezone.utc) + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    to_encode.update({"exp": expire})

    # 3. ç°½åç”Ÿæˆ JWT
    #    jwt.encode(payload, å¯†é‘°, æ¼”ç®—æ³•) â†’ JWT å­—ä¸²
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)

    return encoded_jwt  # "eyJhbGciOi..."
```

#### é©—è­‰ Token

```python
def verify_token(token: str) -> Dict[str, Any]:
    try:
        # 1. è§£ç¢¼ JWTï¼ˆåŒæ™‚é©—è­‰ç°½åå’ŒéæœŸæ™‚é–“ï¼‰
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])

        # 2. å–å‡ºä½¿ç”¨è€…è³‡è¨Š
        user_id = payload.get("id")
        if user_id is None:
            raise HTTPException(status_code=401, detail="Token payload invalid")

        return {"user_id": user_id, "name": payload.get("name"), "email": payload.get("email")}

    except jwt.ExpiredSignatureError:
        # PyJWT è‡ªå‹•æª¢æŸ¥ exp æ¬„ä½
        raise HTTPException(status_code=401, detail="Token å·²éæœŸ")

    except jwt.PyJWTError:
        # ç°½åéŒ¯èª¤ã€æ ¼å¼éŒ¯èª¤ç­‰
        raise HTTPException(status_code=401, detail="ç„¡æ•ˆçš„ token")
```

---

### JWT å®‰å…¨æ€§æ³¨æ„äº‹é …

| é …ç›®           | å»ºè­°                                                               |
| -------------- | ------------------------------------------------------------------ |
| **SECRET_KEY** | ä½¿ç”¨å¼·å¯†é‘°ï¼ˆè‡³å°‘ 256 bitsï¼‰ï¼Œå­˜æ”¾åœ¨ç’°å¢ƒè®Šæ•¸                        |
| **éæœŸæ™‚é–“**   | è¨­å®šåˆç†çš„ exp                                                     |
| **HTTPS**      | ç”Ÿç”¢ç’°å¢ƒå¿…é ˆä½¿ç”¨ HTTPSï¼Œé˜²æ­¢ Token è¢«æ””æˆª                          |
| **æ•æ„Ÿè³‡æ–™**   | ä¸è¦åœ¨ Payload æ”¾å¯†ç¢¼ã€ä¿¡ç”¨å¡è™Ÿç­‰æ•æ„Ÿè³‡è¨Š                          |
| **Token å„²å­˜** | å‰ç«¯ä½¿ç”¨ localStorage æˆ– httpOnly Cookie (æœ¬å°ˆæ¡ˆä½¿ç”¨ localStorage) |

---

## 3. Database Design

### ğŸ¯ Transaction Management

### è³‡æ–™åº« Transaction èˆ‡é–æ©Ÿåˆ¶

### åŸºæœ¬æ¦‚å¿µ

#### Transactionï¼ˆäº¤æ˜“ï¼‰

ä¸€å€‹ transaction æ˜¯ä¸€çµ„ã€Œè¦å˜›å…¨éƒ¨æˆåŠŸï¼Œè¦å˜›å…¨éƒ¨å¤±æ•—ã€çš„è³‡æ–™åº«æ“ä½œã€‚

```python
conn.start_transaction()  # é–‹å§‹ transaction
cursor.execute("UPDATE ...")
cursor.execute("DELETE ...")
conn.commit()             # å…¨éƒ¨æˆåŠŸ â†’ æäº¤
# æˆ–
conn.rollback()           # ä»»ä¸€å¤±æ•— â†’ å…¨éƒ¨æ’¤éŠ·
```

#### ç‚ºä»€éº¼è¦åœ¨åŒä¸€å€‹ Connection å’Œ Transaction å…§æ“ä½œï¼Ÿ

**é–æ˜¯ç¶å®šåœ¨ transaction ä¸Šçš„**ï¼Œåªåœ¨è©² transaction å…§æœ‰æ•ˆã€‚

| æƒ…æ³                                   | çµæœ         |
| -------------------------------------- | ------------ |
| åŒä¸€å€‹ connection + åŒä¸€å€‹ transaction | âœ“ é–æœ‰æ•ˆ     |
| ä¸åŒ connection                        | âœ— é–ç„¡æ•ˆ     |
| åŒä¸€å€‹ connection ä½†é–‹æ–° transaction   | âœ— èˆŠé–å·²é‡‹æ”¾ |

**éŒ¯èª¤ç¤ºç¯„**ï¼š

```python
with get_connection() as conn1:
    cursor1.execute("SELECT ... FOR UPDATE")  # å–å¾—é–

with get_connection() as conn2:  # â† æ–° connectionï¼Œé–å·²å¤±æ•ˆ
    cursor2.execute("DELETE ...")  # â† å…¶ä»–äººå¯èƒ½å·²ä¿®æ”¹è³‡æ–™
```

---

### ä½µç™¼æƒ…å¢ƒï¼šå¤šå€‹è«‹æ±‚åŒæ™‚æ“ä½œ

ç•¶å¤šå€‹ä½¿ç”¨è€…åŒæ™‚æ“ä½œåŒä¸€ç­†è³‡æ–™æ™‚ï¼Œæœƒç”¢ç”Ÿå¤šå€‹ transactionï¼š

```
ä½¿ç”¨è€… A                          ä½¿ç”¨è€… B
â”€â”€â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€â”€â”€â”€
SELECT ... FOR UPDATE (å–å¾—é–)
                                  SELECT ... FOR UPDATE (ç­‰å¾…ä¸­...)
DELETE
COMMIT (é‡‹æ”¾é–)
                                  (å–å¾—é–ï¼Œä½†è³‡æ–™å·²è¢«åˆªé™¤)
                                  æŸ¥ç„¡è³‡æ–™ â†’ å›å‚³ False
```

`SELECT FOR UPDATE` ç¢ºä¿åœ¨ä½ å®Œæˆæ“ä½œå‰ï¼Œå…¶ä»–è«‹æ±‚å¿…é ˆç­‰å¾…ã€‚

---

### ç‚ºä»€éº¼åªåš SELECT ä¹Ÿè¦ ROLLBACKï¼Ÿ

`SELECT FOR UPDATE` æœƒå–å¾—æ’ä»–é–ï¼Œé€™å€‹é–æœƒä¸€ç›´æŒæœ‰ç›´åˆ°ï¼š

- `COMMIT`
- `ROLLBACK`
- é€£ç·šé—œé–‰

**å³ä½¿æ²’æœ‰ä¿®æ”¹è³‡æ–™ï¼Œä¹Ÿéœ€è¦æ˜ç¢ºé‡‹æ”¾é–**ï¼Œå¦å‰‡å…¶ä»– transaction æœƒä¸€ç›´ç­‰å¾…ã€‚

```python
if not row:
    conn.rollback()  # æ²’æœ‰è¦ä¿®æ”¹ï¼Œä½†ä»éœ€é‡‹æ”¾é–
    return False
```

---

### GET /api/top_games_median_prices SQL è¨­è¨ˆ

### SQL çµæ§‹

```sql
WITH ranked AS (
    -- CTE 1: è¨ˆç®—æ¯å ´æ¯”è³½çš„ç¥¨åƒ¹æ’åï¼ˆç‚ºäº†ç®—ä¸­ä½æ•¸ï¼‰
),
median_calc AS (
    -- CTE 2: è¨ˆç®—æ¯å ´æ¯”è³½çš„ç¥¨åƒ¹ä¸­ä½æ•¸
),
top_games AS (
    -- CTE 3: å–éŠ·é‡å‰ 5 åçš„å ´æ¬¡
)
SELECT ...
FROM top_games tg
LEFT JOIN median_calc mc ON tg.game_id = mc.game_id
```

### ç‚ºä»€éº¼ç”¨ LEFT JOINï¼Ÿ

| å¯«æ³•                  | ç•°å¸¸æ™‚çš„è¡Œç‚º                               | å¯è¿½è¹¤æ€§       |
| --------------------- | ------------------------------------------ | -------------- |
| INNER JOIN            | è³‡æ–™ç›´æ¥æ¶ˆå¤±ï¼Œæ²’æœ‰ä»»ä½•æç¤º                 | âŒ é›£ç™¼ç¾å•é¡Œ  |
| LEFT JOIN + NULL æª¢æŸ¥ | è³‡æ–™å­˜åœ¨ä½† median_price = NULLï¼Œå¯è¨˜éŒ„ log | âœ“ å®¹æ˜“ç™¼ç¾å•é¡Œ |

### ç•°å¸¸è™•ç†ç­–ç•¥

```python
if row["median_price"] is None:
    # é˜²ç¦¦æ€§è™•ç†ï¼šç†è«–ä¸Šä¸æœƒç™¼ç”Ÿï¼Œä½†å¦‚æœç™¼ç”Ÿè¦è¨˜éŒ„ä¸¦è·³é
    print(f"[Warning] å ´æ¬¡ {row['game_id']} ä¸­ä½æ•¸ç‚º NULLï¼ˆä¸æ‡‰ç™¼ç”Ÿï¼‰")
    continue  # è·³éï¼Œä¸å›å‚³éŒ¯èª¤çš„ 0
```

**ç‚ºä»€éº¼ä¸è¨­ç‚º 0ï¼Ÿ**

- æœ‰äº¤æ˜“çš„æ¯”è³½ï¼Œç¥¨åƒ¹ä¸å¯èƒ½æ˜¯ 0 å…ƒ
- é¡¯ç¤º 0 æœƒèª¤å°ä½¿ç”¨è€…
- è·³éè³‡æ–™æ¯”é¡¯ç¤ºéŒ¯èª¤è³‡æ–™æ›´å¥½

---

### GET /api/team_trade_rank UNION ALL è¨­è¨ˆ

### å•é¡ŒèƒŒæ™¯

ä¸€ç­†è¨‚å–®æ¶‰åŠå…©æ”¯çƒéšŠï¼ˆä¸»éšŠ vs å®¢éšŠï¼‰ï¼Œéœ€è¦åˆ†åˆ¥è¨ˆç®—æ¯æ”¯çƒéšŠçš„äº¤æ˜“æ¬¡æ•¸ã€‚

### SQL çµæ§‹

```sql
SELECT team, COUNT(*) AS trade_count
FROM (
    -- å­æŸ¥è©¢ 1: å–å‡ºæ‰€æœ‰è¨‚å–®çš„ä¸»éšŠ
    SELECT g.team_home AS team
    FROM orders o JOIN ...

    UNION ALL

    -- å­æŸ¥è©¢ 2: å–å‡ºæ‰€æœ‰è¨‚å–®çš„å®¢éšŠ
    SELECT g.team_away AS team
    FROM orders o JOIN ...
) AS teams
GROUP BY team
ORDER BY trade_count DESC
```

### ç‚ºä»€éº¼ç”¨ UNION ALLï¼Ÿ

å‡è¨­æœ‰ 3 ç­†è¨‚å–®ï¼š

| è¨‚å–® | ä¸»éšŠ     | å®¢éšŠ     |
| ---- | -------- | -------- |
| 1    | ä¸­ä¿¡å…„å¼Ÿ | çµ±ä¸€ç…   |
| 2    | ä¸­ä¿¡å…„å¼Ÿ | å¯Œé‚¦æ‚å°‡ |
| 3    | æ¨‚å¤©æ¡ƒçŒ¿ | ä¸­ä¿¡å…„å¼Ÿ |

**å­æŸ¥è©¢ 1ï¼ˆteam_homeï¼‰**ï¼š

```
ä¸­ä¿¡å…„å¼Ÿ
ä¸­ä¿¡å…„å¼Ÿ
æ¨‚å¤©æ¡ƒçŒ¿
```

**å­æŸ¥è©¢ 2ï¼ˆteam_awayï¼‰**ï¼š

```
çµ±ä¸€ç…
å¯Œé‚¦æ‚å°‡
ä¸­ä¿¡å…„å¼Ÿ
```

**UNION ALL åˆä½µ**ï¼š

```
ä¸­ä¿¡å…„å¼Ÿ
ä¸­ä¿¡å…„å¼Ÿ
æ¨‚å¤©æ¡ƒçŒ¿
çµ±ä¸€ç…
å¯Œé‚¦æ‚å°‡
ä¸­ä¿¡å…„å¼Ÿ
```

**GROUP BY team å¾Œ**ï¼š

| çƒéšŠ     | trade_count |
| -------- | ----------- |
| ä¸­ä¿¡å…„å¼Ÿ | 3           |
| æ¨‚å¤©æ¡ƒçŒ¿ | 1           |
| çµ±ä¸€ç…   | 1           |
| å¯Œé‚¦æ‚å°‡ | 1           |

### UNION vs UNION ALL

| èªæ³•      | è¡Œç‚º             |
| --------- | ---------------- |
| UNION     | å»é™¤é‡è¤‡ï¼ˆè¼ƒæ…¢ï¼‰ |
| UNION ALL | ä¿ç•™å…¨éƒ¨ï¼ˆè¼ƒå¿«ï¼‰ |

é€™è£¡å¿…é ˆç”¨ **UNION ALL**ï¼Œå› ç‚ºæˆ‘å€‘è¦è¨ˆç®—æ‰€æœ‰å‡ºç¾æ¬¡æ•¸ï¼Œä¸èƒ½å»é‡ã€‚

---

## 4. Caching & Performance

### ğŸ¯ Redis é€£ç·šæ± è¨­è¨ˆ

### GET /api/top_games å¿«å–è¨­è¨ˆ

### è¨­è¨ˆç›®æ¨™

æœ¬æœˆç†±é–€è³½äº‹æ’è¡Œæ¦œæ˜¯**é«˜é »è®€å–ã€ä½é »è®Šå‹•**çš„è³‡æ–™ï¼Œé©åˆä½¿ç”¨å¿«å–ã€‚

### æ¶æ§‹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è«‹æ±‚é€²å…¥                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: å˜—è©¦å¾ Redis å–å¾—å¿«å–                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cache_key = "top_games:2025-07"                             â”‚
â”‚ cached_data = redis_client.get(cache_key)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                               â”‚
       å¿«å–å‘½ä¸­ (HIT)                   å¿«å–æœªå‘½ä¸­ (MISS)
              â”‚                          æˆ– Redis éŒ¯èª¤
              â–¼                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚ ç›´æ¥å›å‚³å¿«å–è³‡æ–™         â”‚                   â”‚
â”‚ return json.loads(data) â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Step 2: é™ç´šæŸ¥è©¢è³‡æ–™åº«                   â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ top_games = get_top_games()             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Step 3: å¯«å…¥ Redis å¿«å–ï¼ˆTTL = 1 å¤©ï¼‰    â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ redis_client.setex(key, 86400, payload) â”‚
                    â”‚ ï¼ˆå¯«å…¥å¤±æ•—ä¸ä¸­æ–·ï¼Œåªè¨˜éŒ„ logï¼‰            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Step 4: å›å‚³è³‡æ–™åº«æŸ¥è©¢çµæœ               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é™ç´šç­–ç•¥

| Redis ç‹€æ…‹    | è¡Œç‚º                         |
| ------------- | ---------------------------- |
| æ­£å¸¸ + æœ‰å¿«å– | ç›´æ¥å›å‚³å¿«å–                 |
| æ­£å¸¸ + ç„¡å¿«å– | æŸ¥ DB â†’ å­˜å¿«å– â†’ å›å‚³        |
| é€£ç·šå¤±æ•—      | æŸ¥ DB â†’ å›å‚³ï¼ˆä¸å­˜å¿«å–ï¼‰     |
| å¯«å…¥å¤±æ•—      | æŸ¥ DB â†’ å›å‚³ï¼ˆå¿½ç•¥å¯«å…¥éŒ¯èª¤ï¼‰ |

### é—œéµè¨­è¨ˆåŸå‰‡

1. **å¿«å–æ˜¯è¼”åŠ©åŠŸèƒ½**ï¼šRedis å£äº†ä¸æ‡‰è©²å½±éŸ¿æ ¸å¿ƒåŠŸèƒ½
2. **åªæœ‰ DB éŒ¯èª¤æ‰ä¸­æ–·**ï¼šDB æ˜¯å¿…è¦æ¢ä»¶ï¼Œå¤±æ•—å°±å› 500
3. **Log å€åˆ†å•é¡Œä¾†æº**ï¼šè¨˜éŒ„ keyã€bytesã€error æ–¹ä¾¿é™¤éŒ¯

### TTL è¨­è¨ˆè€ƒé‡

```python
redis_client.setex(cache_key, 86400, payload)  # 86400 ç§’ = 1 å¤©
```

- **ç‚ºä»€éº¼ 1 å¤©ï¼Ÿ** æ’è¡Œæ¦œä¸éœ€è¦å³æ™‚æ›´æ–°ï¼Œ1 å¤©å…§çš„è®ŠåŒ–å¯æ¥å—
- **æ•ˆç›Š**ï¼šå‡è¨­æ¯å¤© 10,000 æ¬¡è«‹æ±‚ï¼Œåªæœ‰ç¬¬ 1 æ¬¡æŸ¥ DBï¼Œå…¶é¤˜ 9,999 æ¬¡å¾å¿«å–å–

---

### Redis å¿«å–æ©Ÿåˆ¶å®Œæ•´è§£æ

### æ ¸å¿ƒè§€å¿µç¸½è¦½

| åè©                 | æ˜¯ä»€éº¼                     | ä»€éº¼æ™‚å€™å»ºç«‹                  | æ˜¯ Singleton å—                    |
| -------------------- | -------------------------- | ----------------------------- | ---------------------------------- |
| **é€£ç·šæ± ç‰©ä»¶**       | ç®¡ç†å¤šæ¢é€£ç·šçš„å®¹å™¨         | import æ™‚                     | âœ“ æ˜¯ï¼ˆæ¨¡çµ„å±¤ç´šè®Šæ•¸ `REDIS_POOL`ï¼‰  |
| **Redis å®¢æˆ¶ç«¯ç‰©ä»¶** | åŸ·è¡Œæ“ä½œçš„ä»‹é¢ï¼ˆgetã€setï¼‰ | æ¯æ¬¡å‘¼å« `get_redis_client()` | âœ— ä¸æ˜¯ï¼ˆæ¯æ¬¡éƒ½å»ºç«‹æ–°çš„ï¼Œä½†å¾ˆè¼•é‡ï¼‰ |
| **ç¶²è·¯é€£ç·š**         | èˆ‡ Redis ä¼ºæœå™¨çš„ TCP é€£ç·š | ç¬¬ä¸€æ¬¡åŸ·è¡Œæ“ä½œæ™‚              | ç”±é€£ç·šæ± ç®¡ç†                       |

---

### é—œéµè§€å¿µé‡æ¸…

#### è§€å¿µ 1ï¼šå»ºç«‹ã€Œç‰©ä»¶ã€â‰  å»ºç«‹ã€Œé€£ç·šã€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç‰©ä»¶ vs é€£ç·š                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  redis.ConnectionPool(...)                                                      â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ å»ºç«‹ã€Œé€£ç·šæ± ç‰©ä»¶ã€ âœ“                                                  â”‚
â”‚           å»ºç«‹ã€Œç¶²è·¯é€£ç·šã€ âœ—  â† æ± æ˜¯ç©ºçš„ï¼Œæ²’æœ‰ä»»ä½•é€£ç·šï¼                         â”‚
â”‚                                                                                 â”‚
â”‚  redis.Redis(connection_pool=REDIS_POOL)                                        â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ å»ºç«‹ã€Œå®¢æˆ¶ç«¯ç‰©ä»¶ã€ âœ“                                                  â”‚
â”‚           å»ºç«‹ã€Œç¶²è·¯é€£ç·šã€ âœ—  â† é‚„æ˜¯æ²’æœ‰é€£ç·šï¼                                  â”‚
â”‚                                                                                 â”‚
â”‚  redis_client.get("key")                                                        â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ å»ºç«‹ã€Œç¶²è·¯é€£ç·šã€ âœ“  â† é€™æ™‚æ‰çœŸæ­£é€£ç·šï¼                                â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è§€å¿µ 2ï¼šmax_connections=10 æ˜¯ã€Œä¸Šé™ã€ï¼Œä¸æ˜¯ã€Œåˆå§‹æ•¸é‡ã€

```
max_connections=10 çš„æ„æ€ï¼š

âœ— éŒ¯èª¤ç†è§£ï¼šä¸€é–‹å§‹å°±å»ºç«‹ 10 æ¢é€£ç·šæ”¾è‘—
âœ“ æ­£ç¢ºç†è§£ï¼šæœ€å¤šåªèƒ½æœ‰ 10 æ¢é€£ç·šï¼ŒæŒ‰éœ€å»ºç«‹
```

| æƒ…æ³                       | æ± ä¸­é€£ç·šæ•¸ | ç™¼ç”Ÿä»€éº¼             |
| -------------------------- | ---------- | -------------------- |
| ç¬¬ä¸€æ¬¡è«‹æ±‚                 | 0 â†’ 1      | å»ºç«‹ 1 æ¢            |
| ç¬¬äºŒæ¬¡è«‹æ±‚ï¼ˆå‰ä¸€å€‹å·²æ­¸é‚„ï¼‰ | 1          | å–å‡ºä½¿ç”¨ï¼Œä¸å»ºç«‹     |
| åŒæ™‚ 3 å€‹è«‹æ±‚              | 1 â†’ 3      | ä¸å¤ ç”¨ï¼Œå»ºç«‹åˆ° 3 æ¢  |
| åŒæ™‚ 15 å€‹è«‹æ±‚             | 3 â†’ 10     | æœ€å¤š 10 æ¢ï¼Œå…¶é¤˜ç­‰å¾… |

#### è§€å¿µ 3ï¼šã€Œæ­¸é‚„ã€â‰ ã€Œé—œé–‰ã€

```
ä½¿ç”¨å®Œé€£ç·šå¾Œï¼š

âœ— éŒ¯èª¤ç†è§£ï¼šé€£ç·šé—œé–‰ï¼Œä¸‹æ¬¡è¦é‡æ–°å»ºç«‹
âœ“ æ­£ç¢ºç†è§£ï¼šé€£ç·šæ”¾å›æ± ä¸­ä¿æŒå­˜æ´»ï¼Œä¸‹æ¬¡ç›´æ¥å–å‡ºä½¿ç”¨
```

é€£ç·šçš„ç”Ÿå‘½é€±æœŸï¼š

- **å»ºç«‹**ï¼šç¬¬ä¸€æ¬¡éœ€è¦æ™‚
- **ä½¿ç”¨**ï¼šåŸ·è¡Œ Redis æ“ä½œ
- **æ­¸é‚„**ï¼šæ”¾å›æ± ä¸­ï¼ˆä¿æŒ TCP é€£ç·šï¼‰
- **é—œé–‰**ï¼šæ‡‰ç”¨ç¨‹å¼çµæŸæ™‚

---

### å®Œæ•´æµç¨‹åœ–ï¼šç¬¬ä¸€æ¬¡ vs ä¹‹å¾Œçš„è«‹æ±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ã€æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•ã€‘import redis_utils                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  1. è¼‰å…¥ç’°å¢ƒè®Šæ•¸                                                                 â”‚
â”‚     REDIS_HOST, REDIS_PORT, REDIS_PASSWORD                                      â”‚
â”‚                                                                                 â”‚
â”‚  2. å»ºç«‹é€£ç·šæ± ç‰©ä»¶ï¼ˆæ¨¡çµ„å±¤ç´šè®Šæ•¸ï¼ŒSingletonï¼‰                                    â”‚
â”‚     REDIS_POOL = redis.ConnectionPool(...)                                      â”‚
â”‚                                                                                 â”‚
â”‚     æ­¤æ™‚çš„ç‹€æ…‹ï¼š                                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚     â”‚     REDIS_POOL      â”‚                                                     â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                                     â”‚
â”‚     â”‚  â”‚   ï¼ˆç©ºçš„ï¼‰     â”‚  â”‚  â† æ²’æœ‰ä»»ä½•é€£ç·š                                    â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                                     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ã€ç¬¬ä¸€æ¬¡è«‹æ±‚ã€‘GET /api/top_games                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  1. API å‘¼å« get_redis_client()                                                 â”‚
â”‚     â””â”€â”€ å»ºç«‹ Redis å®¢æˆ¶ç«¯ç‰©ä»¶ï¼ˆè¼•é‡ï¼Œæ¯æ¬¡éƒ½å»ºç«‹æ–°çš„ï¼‰                            â”‚
â”‚         redis_client = redis.Redis(connection_pool=REDIS_POOL)                  â”‚
â”‚                                                                                 â”‚
â”‚     æ­¤æ™‚ï¼šé‚„æ²’æœ‰ç¶²è·¯é€£ç·šï¼                                                       â”‚
â”‚                                                                                 â”‚
â”‚  2. API åŸ·è¡Œ redis_client.get("top_games:2025-07")                              â”‚
â”‚     â”‚                                                                           â”‚
â”‚     â”œâ”€â”€ é€£ç·šæ± æª¢æŸ¥ï¼šæ± ä¸­æœ‰é–’ç½®é€£ç·šå—ï¼Ÿ                                          â”‚
â”‚     â”‚   â””â”€â”€ æ²’æœ‰ï¼ˆæ± æ˜¯ç©ºçš„ï¼‰                                                    â”‚
â”‚     â”‚                                                                           â”‚
â”‚     â”œâ”€â”€ å»ºç«‹ç¶²è·¯é€£ç·š #1ï¼ˆTCP é€£ç·šåˆ° Redis ä¼ºæœå™¨ï¼‰                              â”‚
â”‚     â”‚                                                                           â”‚
â”‚     â”œâ”€â”€ ä½¿ç”¨é€£ç·š #1 åŸ·è¡Œ GET æ“ä½œ                                               â”‚
â”‚     â”‚                                                                           â”‚
â”‚     â””â”€â”€ æ“ä½œå®Œæˆï¼Œé€£ç·š #1 æ­¸é‚„åˆ°æ± ä¸­                                            â”‚
â”‚                                                                                 â”‚
â”‚     æ­¤æ™‚çš„ç‹€æ…‹ï¼š                                                                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚     â”‚     REDIS_POOL      â”‚                                                     â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                                     â”‚
â”‚     â”‚  â”‚  é€£ç·š #1 â—    â”‚  â”‚  â† 1 æ¢é€£ç·šï¼Œé–’ç½®ä¸­ï¼Œä¿æŒ TCP é€£ç·š                 â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                                     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ã€ç¬¬äºŒæ¬¡è«‹æ±‚ã€‘GET /api/top_games                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  1. API å‘¼å« get_redis_client()                                                 â”‚
â”‚     â””â”€â”€ å»ºç«‹æ–°çš„ Redis å®¢æˆ¶ç«¯ç‰©ä»¶ï¼ˆå¾ˆè¼•é‡ï¼Œç„¡æ‰€è¬‚ï¼‰                              â”‚
â”‚                                                                                 â”‚
â”‚  2. API åŸ·è¡Œ redis_client.get("top_games:2025-07")                              â”‚
â”‚     â”‚                                                                           â”‚
â”‚     â”œâ”€â”€ é€£ç·šæ± æª¢æŸ¥ï¼šæ± ä¸­æœ‰é–’ç½®é€£ç·šå—ï¼Ÿ                                          â”‚
â”‚     â”‚   â””â”€â”€ æœ‰ï¼é€£ç·š #1 æ­£åœ¨é–’ç½®                                                â”‚
â”‚     â”‚                                                                           â”‚
â”‚     â”œâ”€â”€ å–å‡ºé€£ç·š #1ï¼ˆä¸éœ€è¦å»ºç«‹æ–°é€£ç·šï¼ï¼‰                                       â”‚
â”‚     â”‚                                                                           â”‚
â”‚     â”œâ”€â”€ ä½¿ç”¨é€£ç·š #1 åŸ·è¡Œ GET æ“ä½œ                                               â”‚
â”‚     â”‚                                                                           â”‚
â”‚     â””â”€â”€ æ“ä½œå®Œæˆï¼Œé€£ç·š #1 æ­¸é‚„åˆ°æ± ä¸­                                            â”‚
â”‚                                                                                 â”‚
â”‚     æ•ˆèƒ½æå‡ï¼šçœå»äº†å»ºç«‹ TCP é€£ç·šçš„æ™‚é–“ï¼                                        â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ã€é«˜ä½µç™¼æƒ…å¢ƒã€‘åŒæ™‚ 3 å€‹è«‹æ±‚                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  åˆå§‹ç‹€æ…‹ï¼šæ± ä¸­æœ‰ 1 æ¢é–’ç½®é€£ç·šï¼ˆ#1ï¼‰                                             â”‚
â”‚                                                                                 â”‚
â”‚  è«‹æ±‚ Aï¼šredis_client.get("keyA")                                               â”‚
â”‚     â””â”€â”€ å–å‡º #1 â†’ ä½¿ç”¨ä¸­...                                                     â”‚
â”‚                                                                                 â”‚
â”‚  è«‹æ±‚ Bï¼šredis_client.get("keyB")ï¼ˆåŒæ™‚ç™¼ç”Ÿï¼‰                                   â”‚
â”‚     â””â”€â”€ #1 æ­£åœ¨è¢« A ç”¨ â†’ æ± ä¸­æ²’é–’ç½® â†’ å»ºç«‹ #2 â†’ ä½¿ç”¨ä¸­...                       â”‚
â”‚                                                                                 â”‚
â”‚  è«‹æ±‚ Cï¼šredis_client.get("keyC")ï¼ˆåŒæ™‚ç™¼ç”Ÿï¼‰                                   â”‚
â”‚     â””â”€â”€ #1ã€#2 éƒ½åœ¨ç”¨ â†’ å»ºç«‹ #3 â†’ ä½¿ç”¨ä¸­...                                     â”‚
â”‚                                                                                 â”‚
â”‚  ä¸‰å€‹è«‹æ±‚éƒ½å®Œæˆå¾Œçš„ç‹€æ…‹ï¼š                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚     REDIS_POOL      â”‚                                                        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                                        â”‚
â”‚  â”‚  â”‚  é€£ç·š #1 â—    â”‚  â”‚                                                        â”‚
â”‚  â”‚  â”‚  é€£ç·š #2 â—    â”‚  â”‚  â† 3 æ¢é€£ç·šï¼Œå…¨éƒ¨é–’ç½®ï¼Œç­‰å¾…ä¸‹æ¬¡ä½¿ç”¨                   â”‚
â”‚  â”‚  â”‚  é€£ç·š #3 â—    â”‚  â”‚                                                        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚                                                                                 â”‚
â”‚  ä¹‹å¾Œçš„è«‹æ±‚ï¼šå¾ #1ã€#2ã€#3 ä¸­å–å‡ºä½¿ç”¨ï¼Œä¸éœ€è¦å»ºç«‹æ–°çš„                            â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å¸¸è¦‹å•é¡Œ

#### Q1ï¼šç‚ºä»€éº¼è¦ç”¨é€£ç·šæ± ï¼Ÿ

**ç­”**ï¼š

- å»ºç«‹ TCP é€£ç·šéœ€è¦æ™‚é–“ï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰
- å¦‚æœæ¯æ¬¡æ“ä½œéƒ½å»ºç«‹æ–°é€£ç·šï¼Œæ•ˆèƒ½å¾ˆå·®
- é€£ç·šæ± è®“é€£ç·šå¯ä»¥é‡è¤‡ä½¿ç”¨ï¼Œçœå»å»ºç«‹é€£ç·šçš„æ™‚é–“

#### Q2ï¼šmax_connections=10 æ˜¯ä»€éº¼æ„æ€ï¼Ÿ

**ç­”**ï¼š

- æ˜¯**ä¸Šé™**ï¼Œä¸æ˜¯åˆå§‹æ•¸é‡
- æ± ä¸­çš„é€£ç·šæ˜¯**æŒ‰éœ€æ±‚å»ºç«‹**çš„
- ç¬¬ä¸€æ¬¡åªå»ºç«‹ 1 æ¢ï¼ŒåŒæ™‚éœ€è¦æ›´å¤šæ™‚æ‰å»ºç«‹æ›´å¤š
- é”åˆ°ä¸Šé™å¾Œï¼Œæ–°è«‹æ±‚è¦ç­‰å¾…å…¶ä»–é€£ç·šé‡‹æ”¾

#### Q3ï¼šé€£ç·šä»€éº¼æ™‚å€™é—œé–‰ï¼Ÿ

**ç­”**ï¼š

- ä½¿ç”¨å®Œ**ä¸æœƒ**é—œé–‰ï¼Œæœƒæ­¸é‚„åˆ°æ± ä¸­
- é€£ç·šä¿æŒ TCP é€£ç·šç‹€æ…‹ï¼Œç­‰å¾…ä¸‹æ¬¡ä½¿ç”¨
- åªæœ‰æ‡‰ç”¨ç¨‹å¼çµæŸæ™‚ï¼Œé€£ç·šæ‰æœƒé—œé–‰

#### Q4ï¼šdecode_responses=True æ˜¯åšä»€éº¼çš„ï¼Ÿ

**ç­”**ï¼š

- Redis é è¨­å›å‚³ `bytes`ï¼ˆä¾‹å¦‚ `b'hello'`ï¼‰
- è¨­å®šå¾Œè‡ªå‹•è§£ç¢¼ç‚º `str`ï¼ˆä¾‹å¦‚ `'hello'`ï¼‰
- å¥½è™•ï¼šä¸ç”¨æ¯æ¬¡æ‰‹å‹• `.decode("utf-8")`ï¼Œå¯ä»¥ç›´æ¥ç”¨ `json.loads()`

---

### API ä¸­ä½¿ç”¨ Redis çš„å®Œæ•´æµç¨‹ï¼ˆä»¥ /api/top_games ç‚ºä¾‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        /api/top_games å®Œæ•´æµç¨‹                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  è«‹æ±‚é€²ä¾†ï¼šGET /api/top_games                                                   â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚  1. å˜—è©¦å¾ Redis è®€å–å¿«å–                    â”‚                                â”‚
â”‚  â”‚                                             â”‚                                â”‚
â”‚  â”‚  redis_client = get_redis_client()          â”‚ â† å»ºç«‹å®¢æˆ¶ç«¯ç‰©ä»¶              â”‚
â”‚  â”‚  cached_data = redis_client.get(cache_key)  â”‚ â† é€™æ™‚æ‰ç”¨åˆ°é€£ç·š              â”‚
â”‚  â”‚                                             â”‚                                â”‚
â”‚  â”‚  é€£ç·šæ± çš„å‹•ä½œï¼š                              â”‚                                â”‚
â”‚  â”‚  - æœ‰é–’ç½®é€£ç·š â†’ å–å‡ºä½¿ç”¨                     â”‚                                â”‚
â”‚  â”‚  - æ²’æœ‰é€£ç·š â†’ å»ºç«‹æ–°é€£ç·š                     â”‚                                â”‚
â”‚  â”‚  - æ“ä½œå®Œæˆ â†’ æ­¸é‚„åˆ°æ± ä¸­                     â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ æœ‰å¿«å–ï¼ˆHITï¼‰                                                         â”‚
â”‚       â”‚   â””â”€â”€ return json.loads(cached_data)                                    â”‚
â”‚       â”‚       ç›´æ¥å›å‚³ï¼ŒçµæŸï¼                                                   â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ æ²’å¿«å–ï¼ˆMISSï¼‰æˆ– Redis éŒ¯èª¤                                           â”‚
â”‚           â”‚                                                                     â”‚
â”‚           â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚  2. æŸ¥è©¢è³‡æ–™åº«                               â”‚                                â”‚
â”‚  â”‚                                             â”‚                                â”‚
â”‚  â”‚  top_games = get_top_games()                â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚           â”‚                                                                     â”‚
â”‚           â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â”‚  3. å¯«å…¥ Redis å¿«å–                          â”‚                                â”‚
â”‚  â”‚                                             â”‚                                â”‚
â”‚  â”‚  redis_client = get_redis_client()          â”‚ â† å†å–ä¸€æ¬¡ï¼ˆä¿éšªï¼‰             â”‚
â”‚  â”‚  redis_client.setex(cache_key, 86400, data) â”‚ â† å¯«å…¥ + è¨­å®š TTL              â”‚
â”‚  â”‚                                             â”‚                                â”‚
â”‚  â”‚  é€£ç·šæ± çš„å‹•ä½œï¼š                              â”‚                                â”‚
â”‚  â”‚  - å¯èƒ½ä½¿ç”¨åŒä¸€æ¢é€£ç·šï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸åŒæ¢        â”‚                                â”‚
â”‚  â”‚  - æ“ä½œå®Œæˆ â†’ æ­¸é‚„åˆ°æ± ä¸­                     â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚           â”‚                                                                     â”‚
â”‚           â–¼                                                                     â”‚
â”‚  return top_games                                                               â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### éŒ¯èª¤è™•ç†ç­–ç•¥

| Redis æ“ä½œ      | å¤±æ•—æ™‚çš„è™•ç†           | åŸå›                        |
| --------------- | ---------------------- | -------------------------- |
| GETï¼ˆè®€å¿«å–ï¼‰   | é™ç´šæŸ¥è³‡æ–™åº«ï¼Œä¸ raise | å¿«å–æ˜¯è¼”åŠ©åŠŸèƒ½ï¼Œä¸å½±éŸ¿æ ¸å¿ƒ |
| SETEXï¼ˆå¯«å¿«å–ï¼‰ | åªå° logï¼Œä¸ raise     | ä¸å½±éŸ¿ API å›å‚³çµæœ        |

```python
# è®€å¿«å–å¤±æ•—ï¼šé™ç´šåˆ°è³‡æ–™åº«
try:
    cached_data = redis_client.get(cache_key)
except Exception as e:
    logger.warning(f"Redis GET error: {e}")
    # ä¸ raiseï¼Œç¹¼çºŒå¾€ä¸‹æŸ¥è³‡æ–™åº«

# å¯«å¿«å–å¤±æ•—ï¼šåªå° log
try:
    redis_client.setex(cache_key, 86400, payload)
except Exception as e:
    logger.warning(f"Redis SETEX error: {e}")
    # ä¸ raiseï¼Œç›´æ¥ return è³‡æ–™åº«çµæœ
```

---

### ç‚ºä»€éº¼ Redis éœ€è¦é€£ç·šæ± ï¼Œè€Œ S3/SQS ä¸ç”¨ï¼Ÿ

#### æœå‹™å”å®šè¨­è¨ˆæ±ºå®šé€£ç·šç‰¹æ€§

| æœå‹™      | å”å®š                                | é€£ç·šç‰¹æ€§      | é€£ç·šæ±          |
| --------- | ----------------------------------- | ------------- | -------------- |
| **Redis** | Redis Protocolï¼ˆRESPï¼‰ï¼Œè·‘åœ¨ TCP ä¸Š | æŒä¹…é€£ç·š      | éœ€è¦è‡ªå·±ç®¡ç†   |
| **S3**    | HTTP/HTTPSï¼ˆRESTful APIï¼‰           | è«‹æ±‚-å›æ‡‰æ¨¡å¼ | boto3 å…§éƒ¨ç®¡ç† |
| **SQS**   | HTTP/HTTPSï¼ˆRESTful APIï¼‰           | è«‹æ±‚-å›æ‡‰æ¨¡å¼ | boto3 å…§éƒ¨ç®¡ç† |

#### Redisï¼šTCP æŒä¹…é€£ç·š

```
TCP é€£ç·šå»ºç«‹ï¼ˆä¸‰æ¬¡æ¡æ‰‹ï¼‰
    â”‚
    â”œâ”€â”€ GET key1      â†’ å›æ‡‰
    â”œâ”€â”€ SET key2 val  â†’ å›æ‡‰
    â”œâ”€â”€ GET key3      â†’ å›æ‡‰
    â”œâ”€â”€ ...ï¼ˆå¯ä»¥ä¸€ç›´ç”¨ä¸‹å»ï¼‰
    â”‚
TCP é€£ç·šé—œé–‰ï¼ˆåªæœ‰æ˜ç¢ºé—œé–‰æ™‚ï¼‰
```

**ç‰¹é»**ï¼š

- é€£ç·šå»ºç«‹å¾Œä¿æŒå­˜æ´»ï¼Œä¸€å€‹é€£ç·šåŸ·è¡Œå¤šå€‹å‘½ä»¤
- é©åˆé«˜é »æ“ä½œï¼ˆæ¯ç§’å¯èƒ½å¹¾ç™¾æ¬¡æŸ¥è©¢ï¼‰
- éœ€è¦æˆ‘å€‘è‡ªå·±å»ºç«‹é€£ç·šæ± ä¾†ç®¡ç†é€£ç·š

#### S3/SQSï¼šHTTP è«‹æ±‚-å›æ‡‰æ¨¡å¼

```
è«‹æ±‚ 1ï¼šPUT /bucket/file.jpg
    â””â”€â”€ å»ºç«‹é€£ç·š â†’ ç™¼é€è«‹æ±‚ â†’ æ”¶åˆ°å›æ‡‰ â†’ é€£ç·šå¯èƒ½é—œé–‰æˆ–å¾©ç”¨

è«‹æ±‚ 2ï¼šGET /bucket/file.jpg
    â””â”€â”€ å»ºç«‹é€£ç·š â†’ ç™¼é€è«‹æ±‚ â†’ æ”¶åˆ°å›æ‡‰ â†’ é€£ç·šå¯èƒ½é—œé–‰æˆ–å¾©ç”¨
```

**ç‰¹é»**ï¼š

- HTTP/1.1 æœ‰ Keep-Alive æ©Ÿåˆ¶
- boto3 å…§éƒ¨å·²ç¶“ç®¡ç†é€£ç·šæ± 
- æˆ‘å€‘ä¸éœ€è¦è‡ªå·±è™•ç†ï¼Œç›´æ¥ç”¨å®¢æˆ¶ç«¯ç‰©ä»¶å³å¯

#### ç°¡å–®æ¯”å–»

| é¡å‹                         | æ¯”å–»                                         |
| ---------------------------- | -------------------------------------------- |
| **Redisï¼ˆTCP æŒä¹…é€£ç·šï¼‰**    | æ‰“é›»è©±ï¼šæ’¥é€šå¾Œå¯ä»¥ä¸€ç›´è¬›ï¼Œè¬›å®Œå†æ›           |
| **S3/SQSï¼ˆHTTP è«‹æ±‚-å›æ‡‰ï¼‰** | å¯„ä¿¡ï¼šæ¯æ¬¡å¯„ä¸€å°ï¼Œæ”¶åˆ°å›ä¿¡ï¼Œä¸‹æ¬¡å†å¯„æ–°çš„ä¸€å° |

#### çµè«–

| å•é¡Œ                         | ç­”æ¡ˆ                                     |
| ---------------------------- | ---------------------------------------- |
| èª°æ±ºå®šé€£ç·šé¡å‹ï¼Ÿ             | æœå‹™æœ¬èº«çš„å”å®šè¨­è¨ˆï¼Œä¸æ˜¯æˆ‘å€‘é¸æ“‡         |
| Redis ç‚ºä»€éº¼è¦è‡ªå·±å»ºé€£ç·šæ± ï¼Ÿ | å®ƒæ˜¯ TCP æŒä¹…é€£ç·šï¼Œredis-py æ²’æœ‰å…§å»ºç®¡ç† |
| S3/SQS ç‚ºä»€éº¼ä¸ç”¨è‡ªå·±å»ºï¼Ÿ    | å®ƒå€‘æ˜¯ HTTP APIï¼Œboto3 å…§éƒ¨å·²ç¶“è™•ç†å¥½äº†  |

---

### é€£ç·šæ­¸é‚„æ™‚æ©Ÿï¼šæ¯æ¬¡æ“ä½œå®Œæˆå°±ç«‹å³æ­¸é‚„

#### å¸¸è¦‹èª¤è§£

```
âœ— éŒ¯èª¤ç†è§£ï¼šåŒä¸€å€‹ API çš„å¤šæ¬¡æ“ä½œå…±ç”¨åŒä¸€æ¢é€£ç·š
âœ“ æ­£ç¢ºç†è§£ï¼šæ¯æ¬¡æ“ä½œå®Œæˆå¾Œç«‹å³æ­¸é‚„ï¼Œä¸‹æ¬¡æ“ä½œé‡æ–°å¾æ± ä¸­å–
```

#### å¯¦éš›æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    /api/top_games ä¸­çš„é€£ç·šä½¿ç”¨                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  redis_client = get_redis_client()        â† å»ºç«‹å®¢æˆ¶ç«¯ç‰©ä»¶ï¼ˆé‚„æ²’å–é€£ç·šï¼‰         â”‚
â”‚                                                                                 â”‚
â”‚  cached_data = redis_client.get(cache_key)                                      â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ å¾æ± ä¸­å–å‡ºé€£ç·š #1                                                     â”‚
â”‚       â”œâ”€â”€ åŸ·è¡Œ GET                                                              â”‚
â”‚       â””â”€â”€ æ­¸é‚„é€£ç·š #1 åˆ°æ± ä¸­              â† é€™è£¡å°±æ­¸é‚„äº†ï¼                       â”‚
â”‚                                                                                 â”‚
â”‚  # ... æŸ¥è³‡æ–™åº«ï¼ˆå¯èƒ½èŠ± 50msï¼‰...                                               â”‚
â”‚  # é€™æ®µæ™‚é–“é€£ç·š #1 æ˜¯é–’ç½®çš„ï¼Œå…¶ä»–è«‹æ±‚å¯ä»¥ç”¨                                      â”‚
â”‚                                                                                 â”‚
â”‚  redis_client.setex(cache_key, 86400, payload)                                  â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ å¾æ± ä¸­å–å‡ºé€£ç·šï¼ˆå¯èƒ½æ˜¯ #1ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–æ¢ï¼‰                           â”‚
â”‚       â”œâ”€â”€ åŸ·è¡Œ SETEX                                                            â”‚
â”‚       â””â”€â”€ æ­¸é‚„é€£ç·šåˆ°æ± ä¸­                                                        â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆï¼Ÿ

| è¨­è¨ˆæ–¹å¼                              | å„ªé»                                             | ç¼ºé»                                 |
| ------------------------------------- | ------------------------------------------------ | ------------------------------------ |
| **æ¯æ¬¡æ“ä½œå°±æ­¸é‚„**ï¼ˆredis-py çš„åšæ³•ï¼‰ | é€£ç·šä¸æœƒè¢«å–®ä¸€è«‹æ±‚é•·æ™‚é–“ä½”ç”¨ï¼Œé«˜ä½µç™¼æ™‚é€£ç·šå¯å…±äº« | æ¯æ¬¡æ“ä½œéƒ½æœ‰ã€Œå–å‡º/æ­¸é‚„ã€çš„å°é–‹éŠ·    |
| æ•´å€‹ API ä½”ç”¨åŒä¸€æ¢                   | æ¸›å°‘å–å‡º/æ­¸é‚„æ¬¡æ•¸                                | é€£ç·šè¢«é•·æ™‚é–“ä½”ç”¨ï¼Œé«˜ä½µç™¼æ™‚å¯èƒ½ä¸å¤ ç”¨ |

**é—œéµç†è§£**ï¼šã€Œå–å‡º/æ­¸é‚„ã€åªæ˜¯å¾æ± ä¸­æ‹¿ç‰©ä»¶ï¼Œ**ä¸æ˜¯å»ºç«‹ç¶²è·¯é€£ç·š**ï¼Œé–‹éŠ·éå¸¸å°ã€‚

#### å¦‚æœæƒ³è¦å¤šå€‹æ“ä½œå…±ç”¨åŒä¸€æ¢é€£ç·šï¼Ÿ

ä½¿ç”¨ **Pipeline**ï¼š

```python
# ä¸€èˆ¬åšæ³•ï¼šæ¯å€‹æ“ä½œå„è‡ªå–é€£ç·šã€æ­¸é‚„
redis_client.get("key1")    # å– â†’ åŸ·è¡Œ â†’ æ­¸é‚„
redis_client.get("key2")    # å– â†’ åŸ·è¡Œ â†’ æ­¸é‚„
redis_client.get("key3")    # å– â†’ åŸ·è¡Œ â†’ æ­¸é‚„

# Pipelineï¼šå¤šå€‹æ“ä½œå…±ç”¨ä¸€æ¢é€£ç·šï¼Œä¸€æ¬¡åŸ·è¡Œ
pipe = redis_client.pipeline()
pipe.get("key1")
pipe.get("key2")
pipe.get("key3")
results = pipe.execute()    # ä¸€æ¬¡å–é€£ç·š â†’ åŸ·è¡Œå…¨éƒ¨ â†’ æ­¸é‚„
```

**Pipeline å¥½è™•**ï¼šæ¸›å°‘ç¶²è·¯å¾€è¿”æ¬¡æ•¸ï¼ˆ3 æ¬¡è®Š 1 æ¬¡ï¼‰ã€å…±ç”¨åŒä¸€æ¢é€£ç·šã€‚

#### ç¸½çµ

| å•é¡Œ                        | ç­”æ¡ˆ                                      |
| --------------------------- | ----------------------------------------- |
| æ¯æ¬¡æ“ä½œå®Œå°±æ­¸é‚„å—ï¼Ÿ        | **æ˜¯çš„**ï¼Œç«‹å³æ­¸é‚„                        |
| åŒä¸€å€‹ API ç”¨åŒä¸€æ¢é€£ç·šå—ï¼Ÿ | **ä¸ä¸€å®š**ï¼Œå¯èƒ½ç›¸åŒä¹Ÿå¯èƒ½ä¸åŒ            |
| é€™æ¨£æœƒå½±éŸ¿æ•ˆèƒ½å—ï¼Ÿ          | **ä¸æœƒ**ï¼Œå–å‡º/æ­¸é‚„åªæ˜¯æ“ä½œæ± ä¸­ç‰©ä»¶ï¼Œå¾ˆå¿« |
| æƒ³è¦å…±ç”¨é€£ç·šæ€éº¼åšï¼Ÿ        | ä½¿ç”¨ Pipeline                             |

---

## 5. API Design

### ğŸ“ TapPay ä»˜æ¬¾æµç¨‹

### API æµç¨‹åœ–

```
POST /api/tappay_pay
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. é©—è­‰è¨‚å–®                          â”‚
â”‚    - è¨‚å–®æ˜¯å¦å­˜åœ¨                    â”‚
â”‚    - æ˜¯å¦ç‚ºè²·å®¶æœ¬äºº                  â”‚
â”‚    - è¨‚å–®ç‹€æ…‹æ˜¯å¦ç‚ºã€Œåª’åˆæˆåŠŸã€       â”‚
â”‚    - ä»˜æ¬¾ç‹€æ…‹æ˜¯å¦ç‚ºã€Œæœªä»˜æ¬¾ã€         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ é©—è­‰å¤±æ•— â†’ å›å‚³ 4XX éŒ¯èª¤
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å»ºç«‹ä»˜æ¬¾ç´€éŒ„ (tappay_status=UNPAID)â”‚
â”‚    ç›®çš„ï¼šå³ä½¿å¾ŒçºŒå¤±æ•—ï¼Œä¹Ÿæœ‰ç´€éŒ„å¯æŸ¥   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å‘¼å« TapPay API                   â”‚
â”‚    - è¨­å®š timeout=10s é¿å…è³‡æºè€—ç›¡   â”‚
â”‚    - ä½¿ç”¨ async httpx éåŒæ­¥è«‹æ±‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€ API å‘¼å«å¤±æ•—ï¼ˆç¶²è·¯/DNS/TapPay æ›æ‰ï¼‰
        â”‚   â†’ æ›´æ–° tappay_status=FAILED
        â”‚   â†’ å›å‚³ 500
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è™•ç† TapPay å›å‚³çµæœ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€ status=0ï¼ˆä»˜æ¬¾æˆåŠŸï¼‰
        â”‚   â†’ æ›´æ–° payments è¡¨
        â”‚   â†’ æ›´æ–° orders è¡¨ï¼ˆpayment_status=å·²ä»˜æ¬¾ï¼‰
        â”‚   â†’ æ–°å¢é€šçŸ¥ã€å¯„ä¿¡çµ¦è³£å®¶
        â”‚   â†’ å›å‚³ success
        â”‚
        â””â”€â”€ statusâ‰ 0ï¼ˆä»˜æ¬¾å¤±æ•—ï¼Œå¦‚é¤˜é¡ä¸è¶³ï¼‰
            â†’ æ›´æ–° tappay_status=FAILED
            â†’ å›å‚³ 400ï¼ˆå®¢æˆ¶ç«¯å•é¡Œï¼Œéç³»çµ±éŒ¯èª¤ï¼‰
```

### éŒ¯èª¤è™•ç†ç­–ç•¥

| éŒ¯èª¤é¡å‹                      | HTTP ç‹€æ…‹ç¢¼ | åŸå›                       |
| ----------------------------- | ----------- | ------------------------- |
| è¨‚å–®ä¸å­˜åœ¨                    | 404         | æ¥­å‹™é‚è¼¯éŒ¯èª¤              |
| ç„¡æ¬Šé™æ“ä½œ                    | 403         | æ¥­å‹™é‚è¼¯éŒ¯èª¤              |
| è¨‚å–®ç‹€æ…‹ä¸ç¬¦                  | 400         | æ¥­å‹™é‚è¼¯éŒ¯èª¤              |
| TapPay API å‘¼å«å¤±æ•—           | 500         | ç³»çµ±/ç¶²è·¯éŒ¯èª¤ï¼ˆä¸å¯é æœŸï¼‰ |
| TapPay æˆæ¬Šå¤±æ•—ï¼ˆé¤˜é¡ä¸è¶³ç­‰ï¼‰ | 400         | å®¢æˆ¶ç«¯å•é¡Œï¼ˆå¯é æœŸï¼‰      |
| è³‡æ–™åº«æ›´æ–°å¤±æ•—                | 500         | ç³»çµ±éŒ¯èª¤                  |

### ç‚ºä»€éº¼å…ˆå»ºç«‹ UNPAID ä»˜æ¬¾ç´€éŒ„ï¼Ÿ

```python
payment_id = create_payment_unpaid(order_id, amount)
```

**ç›®çš„**ï¼š

1. **å¯è¿½æº¯æ€§**ï¼šå³ä½¿ TapPay API å¤±æ•—ï¼Œä¹Ÿæœ‰ç´€éŒ„çŸ¥é“ã€Œæ›¾ç¶“ç™¼èµ·éä»˜æ¬¾ã€
2. **å•é¡Œæ’æŸ¥**ï¼šå¯ä»¥å¾ payments è¡¨çœ‹åˆ°å¤±æ•—åŸå› ï¼ˆtappay_status_messageï¼‰
3. **å°å¸³éœ€æ±‚**ï¼šæ–¹ä¾¿èˆ‡ TapPay å¾Œå°å°å¸³

### ç‚ºä»€éº¼è¨­å®š timeout=10sï¼Ÿ

```python
async with httpx.AsyncClient(timeout=10.0) as client:
```

**åŸå› **ï¼š

- è‹¥æ¯å€‹è«‹æ±‚éƒ½å¡åœ¨å¤–éƒ¨ APIï¼Œæœƒä½”ç”¨é€£ç·šè³‡æº
- å³ä½¿æœ‰ asyncï¼Œå¤§é‡å¡ä½çš„è«‹æ±‚ä»æœƒæ‹–å® Server
- 10 ç§’æ˜¯åˆç†çš„é‡‘æµ API å›æ‡‰æ™‚é–“ä¸Šé™

### ç‚ºä»€éº¼ä½¿ç”¨ async httpxï¼Ÿ

```python
async with httpx.AsyncClient() as client:
    resp = await client.post(...)
```

**å„ªé»**ï¼š

- éåŒæ­¥è«‹æ±‚ï¼Œä¸æœƒé˜»å¡å…¶ä»–è«‹æ±‚
- æå‡ä½µç™¼è™•ç†èƒ½åŠ›
- é©åˆ I/O å¯†é›†å‹æ“ä½œï¼ˆå‘¼å«å¤–éƒ¨ APIï¼‰

---

### ğŸ“ è³£å®¶å‡ºè²¨æµç¨‹

### API æµç¨‹åœ–

```
POST /api/mark_shipped
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åŸå­æ›´æ–°è¨‚å–®ç‹€æ…‹                  â”‚
â”‚    UPDATE ... WHERE å¤šé‡æ¢ä»¶         â”‚
â”‚    - id = order_id                  â”‚
â”‚    - seller_id = ç•¶å‰ç”¨æˆ¶           â”‚
â”‚    - payment_status = 'å·²ä»˜æ¬¾'       â”‚
â”‚    - shipment_status = 'æœªå‡ºè²¨'      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€ rowcount=0ï¼ˆæ›´æ–°å¤±æ•—ï¼‰
        â”‚   â†’ æŸ¥è©¢è¨‚å–®ï¼Œåˆ¤æ–·å…·é«”åŸå› 
        â”‚   â†’ å›å‚³å°æ‡‰çš„ 4XX éŒ¯èª¤
        â”‚
        â–¼ rowcount=1ï¼ˆæ›´æ–°æˆåŠŸï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æŸ¥è©¢è¨‚å–®è³‡æ–™ï¼ˆç”¨æ–¼å¾ŒçºŒé€šçŸ¥ï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ–°å¢ç«™å…§é€šçŸ¥                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æŸ¥è©¢è²·å®¶ Emailï¼ˆcommit å‰æŸ¥è©¢ï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Transaction Commit               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. å¯„ä¿¡é€šçŸ¥è²·å®¶ï¼ˆç™¼é€åˆ° SQSï¼‰        â”‚
â”‚    Commit æˆåŠŸå¾Œæ‰å¯„ï¼Œé¿å…å¯„äº†å»æ²’æ›´æ–°â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ç„¡æ•ˆåŒ– Redis å¿«å–                 â”‚
â”‚    å‡ºè²¨å¾Œæ’è¡Œæ¦œçµ±è¨ˆæœƒæ”¹è®Š            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
    å›å‚³ success
```

### åŸå­æ›´æ–°ï¼ˆAtomic Updateï¼‰è¨­è¨ˆ

**å•é¡Œ**ï¼šä½¿ç”¨è€…é€£æ“Šå…©æ¬¡å‡ºè²¨æŒ‰éˆ•

```
è«‹æ±‚ 1: æª¢æŸ¥ç‹€æ…‹=æœªå‡ºè²¨ â†’ æ›´æ–°ç‚ºå·²å‡ºè²¨ â†’ å¯„ä¿¡
è«‹æ±‚ 2: æª¢æŸ¥ç‹€æ…‹=æœªå‡ºè²¨ â†’ æ›´æ–°ç‚ºå·²å‡ºè²¨ â†’ å¯„ä¿¡ï¼ˆé‡è¤‡å¯„ä¿¡ï¼ï¼‰
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼šæŠŠæª¢æŸ¥å’Œæ›´æ–°åˆä½µæˆä¸€å€‹ SQL

```python
cursor.execute("""
    UPDATE orders
    SET shipment_status='å·²å‡ºè²¨', shipped_at=%s
    WHERE id=%s
      AND seller_id=%s
      AND payment_status='å·²ä»˜æ¬¾'
      AND shipment_status='æœªå‡ºè²¨'  -- é—œéµï¼šåªæ›´æ–°ã€Œæœªå‡ºè²¨ã€çš„è¨‚å–®
""", (shipped_time, order_id, seller_id))
```

**æ•ˆæœ**ï¼š

- è«‹æ±‚ 1ï¼šæ¢ä»¶ç¬¦åˆï¼Œrowcount=1ï¼Œç¹¼çºŒå¾ŒçºŒæµç¨‹
- è«‹æ±‚ 2ï¼šshipment_status å·²ç¶“æ˜¯ã€Œå·²å‡ºè²¨ã€ï¼Œæ¢ä»¶ä¸ç¬¦ï¼Œrowcount=0ï¼Œä¸æœƒé‡è¤‡å¯„ä¿¡

### Transaction è¨­è¨ˆ

**ç‚ºä»€éº¼åœ¨ Router å±¤ç®¡ç† Transactionï¼Ÿ**

```python
with get_connection() as conn:
    with conn.cursor() as cursor:
        update_order_shipped_atom(cursor, ...)  # å‚³å…¥ cursor
        get_order_by_id(cursor, ...)            # å…±ç”¨åŒä¸€å€‹ cursor
        notify_shipped(cursor, ...)             # å…±ç”¨åŒä¸€å€‹ cursor
    conn.commit()  # Router å±¤æ±ºå®šä½•æ™‚ commit
```

**åŸå› **ï¼š

- å¤šå€‹ Model å‡½æ•¸éœ€è¦åœ¨åŒä¸€å€‹ Transaction å…§åŸ·è¡Œ
- å¿…é ˆå…±ç”¨åŒä¸€å€‹ cursorï¼Œå¦å‰‡æœƒæ˜¯ä¸åŒçš„é€£ç·š/Transaction
- Router å±¤çµ±ä¸€ç®¡ç†ï¼Œç¢ºä¿ã€Œå…¨éƒ¨æˆåŠŸæ‰ commitã€

### ç‚ºä»€éº¼ Commit å¾Œæ‰å¯„ä¿¡ï¼Ÿ

```python
conn.commit()  # å…ˆ commit

if notification_data:  # å†å¯„ä¿¡
    send_email_async(...)
```

**åŸå› **ï¼š

- å¦‚æœå…ˆå¯„ä¿¡å¾Œ commitï¼Œè¬ä¸€ commit å¤±æ•—ï¼Œä½¿ç”¨è€…æ”¶åˆ°ã€Œå·²å‡ºè²¨ã€é€šçŸ¥ï¼Œä½†è¨‚å–®ç‹€æ…‹æ²’æ›´æ–°
- Commit æˆåŠŸå¾Œå†å¯„ä¿¡ï¼Œç¢ºä¿ã€Œè³‡æ–™åº«ç‹€æ…‹ã€å’Œã€Œé€šçŸ¥å…§å®¹ã€ä¸€è‡´

### ç‚ºä»€éº¼å¯„ä¿¡å¤±æ•—ä¸å½±éŸ¿ API çµæœï¼Ÿ

```python
# å¯„ä¿¡å¤±æ•—ä¸æœƒ raiseï¼ŒAPI ä»å›å‚³ success
send_email_async(...)  # å¤±æ•—æ™‚å…§éƒ¨ catchï¼Œä¸å½±éŸ¿ä¸»æµç¨‹

return {"status": "success"}  # ä¸€å®šæœƒåŸ·è¡Œåˆ°é€™è£¡
```

**åŸå› **ï¼š

- å‡ºè²¨æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Œå¯„ä¿¡æ˜¯è¼”åŠ©åŠŸèƒ½
- ä¸èƒ½å› ç‚ºå¯„ä¿¡å¤±æ•—ï¼Œå°±è®“å‡ºè²¨ç‹€æ…‹ä¸æ›´æ–°
- å¯„ä¿¡å¤±æ•—å¯ä»¥å¾ŒçºŒè£œæ•‘ï¼ˆé‡å¯„ã€æŸ¥ SQS ç´€éŒ„ï¼‰

### ç‚ºä»€éº¼ç„¡æ•ˆåŒ– Redis å¿«å–ï¼Ÿ

```python
redis_client.delete(cache_key)
```

**åŸå› **ï¼š

- å‡ºè²¨å¾Œï¼Œè©²è¨‚å–®è®Šæˆã€Œå·²å‡ºè²¨ã€
- æ’è¡Œæ¦œçµ±è¨ˆæœƒæ”¹è®Šï¼ˆå¤šäº†ä¸€ç­†å·²å®Œæˆäº¤æ˜“ï¼‰
- åˆªé™¤èˆŠå¿«å–ï¼Œè®“ä¸‹æ¬¡è«‹æ±‚æŸ¥è©¢è³‡æ–™åº«ä¸¦å¯«å…¥æœ€æ–°è³‡æ–™

---

### ğŸ“ åˆ†é æŸ¥è©¢

### GET /api/browse_tickets

### åŸºæœ¬æ¦‚å¿µ

åˆ†é ç”¨æ–¼æ§åˆ¶æ¯æ¬¡æŸ¥è©¢å›å‚³çš„è³‡æ–™ç­†æ•¸ï¼Œé¿å…ä¸€æ¬¡è¼‰å…¥éå¤šè³‡æ–™ã€‚

**API åƒæ•¸**ï¼š

| åƒæ•¸         | èªªæ˜                   | é è¨­å€¼       |
| ------------ | ---------------------- | ------------ |
| `game_id`    | å ´æ¬¡ ID                | å¿…å¡«         |
| `sort_by`    | æ’åºæ¬„ä½               | `created_at` |
| `sort_order` | æ’åºæ–¹å‘               | `desc`       |
| `seat_areas` | åº§ä½å€ç¯©é¸ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰ | ç„¡           |
| `page`       | ç›®å‰é ç¢¼ï¼ˆå¾ 1 é–‹å§‹ï¼‰  | 1            |
| `per_page`   | æ¯é ç­†æ•¸               | 6            |

**åˆ†é è¨ˆç®—**ï¼š

| é …ç›®          | èªªæ˜       | è¨ˆç®—æ–¹å¼ / ç¯„ä¾‹å€¼       |
| ------------- | ---------- | ----------------------- |
| `offset`      | è·³éå‰å¹¾ç­† | `(page - 1) * per_page` |
| `total_count` | ç¸½è³‡æ–™ç­†æ•¸ | ç”±å¾Œç«¯æŸ¥è©¢å¾Œå›å‚³        |

```python
offset = (page - 1) * per_page
# page=1, per_page=6 â†’ offset=0  â†’ å–ç¬¬ 1-6 ç­†
# page=2, per_page=6 â†’ offset=6  â†’ å–ç¬¬ 7-12 ç­†
```

### ç¯„ä¾‹ï¼š7 å¼µç¥¨åˆ¸ï¼Œæ¯é  6 å¼µ

```
ç¸½å…± 7 å¼µç¥¨åˆ¸ï¼š[ç¥¨1, ç¥¨2, ç¥¨3, ç¥¨4, ç¥¨5, ç¥¨6, ç¥¨7]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 1 é  (page=1)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ offset = (1-1) * 6 = 0                              â”‚
â”‚ SQL: LIMIT 6 OFFSET 0                               â”‚
â”‚ çµæœ: [ç¥¨1, ç¥¨2, ç¥¨3, ç¥¨4, ç¥¨5, ç¥¨6]  â† 6 ç­†        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 2 é  (page=2)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ offset = (2-1) * 6 = 6                              â”‚
â”‚ SQL: LIMIT 6 OFFSET 6                               â”‚
â”‚ çµæœ: [ç¥¨7]  â† åªå‰© 1 ç­†                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SQL èªæ³•

```sql
-- ç¬¬ 1 é ï¼šè·³é 0 ç­†ï¼Œå– 6 ç­†
SELECT * FROM tickets LIMIT 6 OFFSET 0;

-- ç¬¬ 2 é ï¼šè·³é 6 ç­†ï¼Œå– 6 ç­†ï¼ˆå¯¦éš›åªå‰© 1 ç­†ï¼‰
SELECT * FROM tickets LIMIT 6 OFFSET 6;
```

### å‰ç«¯å¦‚ä½•è¨ˆç®—ç¸½é æ•¸

```javascript
const totalPages = Math.ceil(total_count / per_page);
// Math.ceil(7 / 6) = Math.ceil(1.17) = 2 é 
```

---

## 6. CI/CD & DevOps

### ğŸ¯ Docker å®¹å™¨åŒ–

### Docker çš„æ ¸å¿ƒåƒ¹å€¼

**ã€Œä½ çš„é›»è…¦èƒ½è·‘ = æˆ‘çš„é›»è…¦ä¹Ÿèƒ½è·‘ã€**

| å‚³çµ±å•é¡Œ             | Docker è§£æ±ºæ–¹æ¡ˆ              |
| -------------------- | ---------------------------- |
| ã€Œæˆ‘çš„é›»è…¦å¯ä»¥è·‘å•Šã€ | ç’°å¢ƒè¢«å®¹å™¨åŒ…èµ·ä¾†ï¼Œåˆ°å“ªéƒ½ä¸€æ¨£ |
| Python ç‰ˆæœ¬ä¸åŒ      | Dockerfile æŒ‡å®šç‰ˆæœ¬          |
| å¥—ä»¶ç‰ˆæœ¬è¡çª         | æ¯å€‹å®¹å™¨æœ‰ç¨ç«‹çš„å¥—ä»¶         |
| ç’°å¢ƒè¨­å®šä¸åŒ         | ç”¨ docker-compose çµ±ä¸€è¨­å®š   |

---

### å®¹å™¨éš”é›¢åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ä½ çš„ Mac é›»è…¦                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Mac æœ¬æ©Ÿç’°å¢ƒ                                                           â”‚    â”‚
â”‚  â”‚                                                                         â”‚    â”‚
â”‚  â”‚  - Python 3.8ï¼ˆä½ ä¹‹å‰è£çš„ï¼‰                                             â”‚    â”‚
â”‚  â”‚  - boto3==1.20.0ï¼ˆèˆŠç‰ˆæœ¬ï¼‰                                              â”‚    â”‚
â”‚  â”‚  - å…¶ä»–å°ˆæ¡ˆçš„å¥—ä»¶                                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Docker å®¹å™¨ï¼ˆç¨ç«‹éš”é›¢çš„ç’°å¢ƒï¼‰                                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚                                                                   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - Python 3.11ï¼ˆDockerfile æŒ‡å®šçš„ï¼‰                               â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - boto3==1.35.0ï¼ˆrequirements.txt æŒ‡å®šçš„ï¼‰                       â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  - åªæœ‰é€™å€‹å°ˆæ¡ˆéœ€è¦çš„å¥—ä»¶                                         â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                                                   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  é€™è£¡é¢çš„æ±è¥¿å’Œ Mac æœ¬æ©Ÿå®Œå…¨ç„¡é—œï¼                                â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                                                                   â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                 â”‚
â”‚  å…©å€‹ç’°å¢ƒäº’ä¸å½±éŸ¿ï¼                                                             â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—œéµç†è§£**ï¼š

- ç¨‹å¼ç¢¼åœ¨ä½ çš„é›»è…¦ä¸Šç·¨è¼¯ï¼ˆç”¨ VS Codeï¼‰
- ç¨‹å¼åœ¨å®¹å™¨è£¡åŸ·è¡Œï¼ˆç”¨å®¹å™¨è£¡çš„ Python å’Œå¥—ä»¶ï¼‰
- å¥—ä»¶å®‰è£åœ¨å®¹å™¨è£¡ï¼ˆä¸æœƒå½±éŸ¿ä½ é›»è…¦ä¸Šçš„å…¶ä»–å°ˆæ¡ˆï¼‰

---

### æœ¬æ©Ÿé–‹ç™¼ vs éƒ¨ç½²çš„å·®ç•°

#### æ›è¼‰ï¼ˆMountï¼‰ vs è¤‡è£½ï¼ˆCOPYï¼‰

| æƒ…å¢ƒ           | æ–¹å¼ | èªªæ˜                             |
| -------------- | ---- | -------------------------------- |
| **æœ¬æ©Ÿé–‹ç™¼**   | æ›è¼‰ | ä½ æ”¹æª”æ¡ˆï¼Œå®¹å™¨å³æ™‚çœ‹åˆ°è®ŠåŒ–       |
| **CI/CD éƒ¨ç½²** | è¤‡è£½ | æŠŠç¨‹å¼ç¢¼è¤‡è£½é€²æ˜ åƒï¼Œè®Šæˆå›ºå®šç‰ˆæœ¬ |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœ¬æ©Ÿé–‹ç™¼ï¼šæ›è¼‰ï¼ˆå³æ™‚åŒæ­¥ï¼‰                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  ä½ çš„ Mac                           Docker å®¹å™¨                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚                   â”‚              â”‚                   â”‚                       â”‚
â”‚  â”‚  app.py â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€ æ›è¼‰ â”€â”€â”€â”€â”¼â”€â”€â†’ /app/app.py    â”‚                        â”‚
â”‚  â”‚  ï¼ˆä½ æ”¹é€™è£¡ï¼‰       â”‚   ï¼ˆåŒä¸€å€‹æª”æ¡ˆï¼‰â”‚   ï¼ˆå®¹å™¨çœ‹é€™è£¡ï¼‰    â”‚                       â”‚
â”‚  â”‚                   â”‚              â”‚                   â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                                 â”‚
â”‚  ä½ åœ¨ Mac ä¸Šæ”¹ app.py â†’ å®¹å™¨è£¡çš„ app.py ä¹ŸåŒæ™‚è®Š                                    â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CI/CD éƒ¨ç½²ï¼šè¤‡è£½ï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  Dockerfile è£¡çš„ COPY . .                                                       â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ æŠŠç¨‹å¼ç¢¼ã€Œè¤‡è£½ã€é€² Docker æ˜ åƒ                                            â”‚
â”‚           ï¼ˆä¸æ˜¯æ›è¼‰ï¼Œæ˜¯è¤‡è£½ä¸€ä»½é€²å»ï¼Œè®Šæˆæ˜ åƒçš„ä¸€éƒ¨åˆ†ï¼‰                                â”‚
â”‚                                                                                 â”‚
â”‚  é€™å€‹æ˜ åƒæ¨åˆ° Docker Hubï¼ŒEC2 æ‹‰ä¸‹ä¾†åŸ·è¡Œ                                            â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### docker-compose.yml vs docker-compose.prod.yml

| æª”æ¡ˆ                      | ç”¨é€”     | é—œéµè¨­å®š                             |
| ------------------------- | -------- | ------------------------------------ |
| `docker-compose.yml`      | æœ¬æ©Ÿé–‹ç™¼ | `build: .`ï¼ˆç”¨æœ¬åœ°ç¨‹å¼ç¢¼ buildï¼‰     |
| `docker-compose.prod.yml` | EC2 éƒ¨ç½² | `image: xxx`ï¼ˆç”¨ Docker Hub çš„æ˜ åƒï¼‰ |

```yaml
# docker-compose.ymlï¼ˆæœ¬æ©Ÿé–‹ç™¼ï¼‰
services:
  web:
    build: # â† ç”¨æœ¬åœ° Dockerfile build
      context: .
      platforms:
        - linux/amd64
    ports:
      - "8080:8000"
    env_file:
      - .env
```

```yaml
# docker-compose.prod.ymlï¼ˆEC2 éƒ¨ç½²ï¼‰
services:
  web:
    image: elsachung/project-practice:latest # â† ç›´æ¥ç”¨ Docker Hub æ˜ åƒ
    ports:
      - "8080:8000"
    env_file:
      - .env
```

---

### CI/CD å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CI/CD å®Œæ•´æµç¨‹                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  git push origin main                                                           â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  ã€GitHub Actions - Test éšæ®µã€‘                                                  â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ å®‰è£ Python å’Œå¥—ä»¶                                                    â”‚
â”‚       â”œâ”€â”€ åŸ·è¡Œ pytest                                                           â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ æ¸¬è©¦é€šé âœ“ â†’ ç¹¼çºŒ Deploy éšæ®µ                                         â”‚
â”‚       â””â”€â”€ æ¸¬è©¦å¤±æ•— âœ— â†’ åœæ­¢ï¼Œä¸éƒ¨ç½²                                             â”‚
â”‚                                                                                 â”‚
â”‚  ã€GitHub Actions - Deploy éšæ®µã€‘                                                â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ docker buildï¼ˆç”¨ Dockerfile å»ºç«‹æ˜ åƒï¼‰                                â”‚
â”‚       â”œâ”€â”€ docker pushï¼ˆæ¨åˆ° Docker Hubï¼‰                                        â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ SSH åˆ° EC2 åŸ·è¡Œï¼š                                                     â”‚
â”‚           â”œâ”€â”€ docker system prune -afï¼ˆæ¸…ç†ç£ç¢Ÿç©ºé–“ï¼‰                           â”‚
â”‚           â”œâ”€â”€ docker-compose downï¼ˆåœæ­¢ä¸¦åˆªé™¤èˆŠå®¹å™¨ï¼‰                           â”‚
â”‚           â”œâ”€â”€ docker-compose pullï¼ˆæ‹‰æœ€æ–°æ˜ åƒï¼‰                                 â”‚
â”‚           â””â”€â”€ docker-compose up -dï¼ˆå•Ÿå‹•æ–°å®¹å™¨ï¼‰                                â”‚
â”‚                                                                                 â”‚
â”‚  ã€å®Œæˆã€‘ç¶²ç«™è‡ªå‹•æ›´æ–°                                                            â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### âš ï¸ éƒ¨ç½²å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

#### å•é¡Œ 1ï¼šç£ç¢Ÿç©ºé–“ä¸è¶³

```
ERROR: no space left on device
```

**åŸå› **ï¼šæ¯æ¬¡ CI/CD éƒ½æœƒæ‹‰æ–°æ˜ åƒï¼ŒèˆŠçš„æ²’åˆªé™¤å°è‡´ç´¯ç©ã€‚

**è§£æ±º**ï¼šåœ¨éƒ¨ç½²å‰å…ˆæ¸…ç†

```yaml
script: |
  docker system prune -af           # æ¸…ç†èˆŠæ˜ åƒã€èˆŠå®¹å™¨
  docker-compose -f docker-compose.prod.yml down
  docker-compose -f docker-compose.prod.yml pull
  docker-compose -f docker-compose.prod.yml up -d
```

#### å•é¡Œ 2ï¼šdocker-compose ç‰ˆæœ¬ç›¸å®¹æ€§

```
KeyError: 'ContainerConfig'
```

**åŸå› **ï¼šèˆŠç‰ˆ docker-compose (1.29.2) è®€å–æ–°ç‰ˆ Docker å®¹å™¨è³‡è¨Šæ™‚ API ä¸ç›¸å®¹ã€‚

**è§£æ±º**ï¼šå…ˆ down å† upï¼Œé¿å…è®€å–èˆŠå®¹å™¨è³‡è¨Š

```bash
docker-compose down    # å…ˆåˆªé™¤èˆŠå®¹å™¨
docker-compose up -d   # å†å»ºç«‹æ–°å®¹å™¨
```

#### å•é¡Œ 3ï¼šPort è¢«ä½”ç”¨

```
Bind for 0.0.0.0:8080 failed: port is already allocated
```

**åŸå› **ï¼šä¹‹å‰ç”¨ `docker run` è·‘çš„èˆŠå®¹å™¨é‚„åœ¨é‹è¡Œã€‚

**è§£æ±º**ï¼šåœæ­¢ä¸¦åˆªé™¤èˆŠå®¹å™¨

```bash
docker stop $(docker ps -q)
docker rm $(docker ps -aq)
docker-compose up -d
```

---

### æ¯æ¬¡ Build éƒ½æ˜¯ä¹¾æ·¨ç’°å¢ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç‚ºä»€éº¼ä¸æœƒæœ‰ç‰ˆæœ¬è¡çª                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  æ¯æ¬¡ CI/CD åŸ·è¡Œ docker buildï¼š                                                 â”‚
â”‚                                                                                 â”‚
â”‚  FROM python:3.11-slim          â† å¾ä¹¾æ·¨çš„ Python æ˜ åƒé–‹å§‹                      â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  pip install -r requirements.txt â† å®‰è£æŒ‡å®šç‰ˆæœ¬çš„å¥—ä»¶                           â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  å…¨æ–°çš„ç’°å¢ƒï¼Œæ²’æœ‰ã€Œä¹‹å‰è£çš„èˆŠå¥—ä»¶ã€å•é¡Œ                                          â”‚
â”‚                                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                                 â”‚
â”‚  å°æ¯”ä¸ç”¨ Dockerï¼š                                                               â”‚
â”‚                                                                                 â”‚
â”‚  pip install boto3==1.35.0                                                      â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ å®‰è£åˆ°ä½ é›»è…¦çš„ Python ç’°å¢ƒ                                            â”‚
â”‚           å¯èƒ½è¦†è“‹èˆŠç‰ˆæœ¬ã€å¯èƒ½æœ‰ç›¸ä¾æ€§è¡çª                                       â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Deploy.yml æœ€çµ‚ç‰ˆæœ¬é‡é»

```yaml
- name: Deploy to EC2
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ${{ secrets.EC2_USERNAME }}
    key: ${{ secrets.EC2_SSH_KEY }}
    script: |
      cd ~/app
      docker system prune -af                           # æ¸…ç†ç£ç¢Ÿ
      docker-compose -f docker-compose.prod.yml down    # åˆªé™¤èˆŠå®¹å™¨
      docker-compose -f docker-compose.prod.yml pull    # æ‹‰æ–°æ˜ åƒ
      docker-compose -f docker-compose.prod.yml up -d   # å•Ÿå‹•æ–°å®¹å™¨
```

| æŒ‡ä»¤                      | è§£æ±ºä»€éº¼å•é¡Œ                  |
| ------------------------- | ----------------------------- |
| `docker system prune -af` | é¿å…ç£ç¢Ÿç©ºé–“ä¸è¶³              |
| `docker-compose down`     | é¿å…ç‰ˆæœ¬ç›¸å®¹æ€§å•é¡Œã€Port è¡çª |
| `docker-compose pull`     | ç¢ºä¿æ‹‰åˆ°æœ€æ–°æ˜ åƒ              |
| `docker-compose up -d`    | å•Ÿå‹•æ–°å®¹å™¨                    |

---

### docker-compose ç‰ˆæœ¬ç›¸å®¹æ€§å•é¡Œ

#### å•é¡Œæè¿°

```
KeyError: 'ContainerConfig'
```

#### æ ¹æœ¬åŸå› 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    docker-compose up -d çš„å…§éƒ¨æµç¨‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  1. æª¢æŸ¥æœ‰æ²’æœ‰åŒåçš„èˆŠå®¹å™¨                                                       â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ ã€æ²’æœ‰èˆŠå®¹å™¨ã€‘                                                        â”‚
â”‚       â”‚       â”‚                                                                 â”‚
â”‚       â”‚       â””â”€â”€ ç›´æ¥å‰µå»ºæ–°å®¹å™¨ âœ“ï¼ˆèˆŠç‰ˆ docker-compose å¯ä»¥åšåˆ°ï¼‰              â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ ã€æœ‰èˆŠå®¹å™¨ã€‘                                                          â”‚
â”‚               â”‚                                                                 â”‚
â”‚               â””â”€â”€ è®€å–èˆŠå®¹å™¨è³‡è¨Šï¼ˆContainerConfigï¼‰                             â”‚
â”‚                       â”‚                                                         â”‚
â”‚                       â””â”€â”€ èˆŠç‰ˆ docker-compose (1.29.2) è®€ä¸æ‡‚                   â”‚
â”‚                           æ–°ç‰ˆ Docker (27.x) çš„ API æ ¼å¼ âœ—                      â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| æ“ä½œ                 | èˆŠç‰ˆ docker-compose èƒ½åšå—ï¼Ÿ |
| -------------------- | ---------------------------- |
| å‰µå»ºæ–°å®¹å™¨           | âœ“ å¯ä»¥                       |
| è®€å–èˆŠå®¹å™¨è³‡è¨Šä¸¦é‡å»º | âœ— æœƒå ±éŒ¯ï¼ˆAPI ä¸ç›¸å®¹ï¼‰       |
| åˆªé™¤èˆŠå®¹å™¨ï¼ˆdownï¼‰   | âœ“ å¯ä»¥                       |
| æ‹‰æ˜ åƒï¼ˆpullï¼‰       | âœ“ å¯ä»¥                       |

#### è§£æ±ºæ–¹æ¡ˆ

**ç¹éã€Œè®€å–èˆŠå®¹å™¨ã€é€™å€‹æœƒå‡ºéŒ¯çš„æ­¥é©Ÿ**

```yaml
script: |
  cd ~/app
  docker system prune -af
  docker-compose -f docker-compose.prod.yml down    # å…ˆåˆªé™¤èˆŠå®¹å™¨
  docker-compose -f docker-compose.prod.yml pull
  docker-compose -f docker-compose.prod.yml up -d   # å‰µå»ºæ–°å®¹å™¨ï¼ˆä¸æ˜¯é‡å»ºï¼‰
```

| æ­¥é©Ÿ | æŒ‡ä»¤                   | ä½œç”¨                                 |
| ---- | ---------------------- | ------------------------------------ |
| 1    | `docker-compose down`  | åˆªé™¤èˆŠå®¹å™¨                           |
| 2    | `docker-compose up -d` | å‰µå»ºæ–°å®¹å™¨ï¼ˆæ²’æœ‰èˆŠå®¹å™¨ï¼Œä¸éœ€è¦è®€å–ï¼‰ |

**é—œéµæ´å¯Ÿ**ï¼šæˆ‘å€‘ä¸éœ€è¦ã€Œé‡å»ºèˆŠå®¹å™¨ã€ï¼Œæˆ‘å€‘åªéœ€è¦ã€Œå‰µå»ºæ–°å®¹å™¨ã€ã€‚å…ˆæŠŠèˆŠçš„åˆªæ‰ï¼Œdocker-compose å°±ä¸ç”¨ç…©æƒ±ç›¸å®¹æ€§å•é¡Œã€‚

**ç¶“é©—**ï¼šéƒ¨ç½²è…³æœ¬è¦è€ƒæ…®ç‰ˆæœ¬ç›¸å®¹æ€§ï¼Œä¸èƒ½å‡è¨­ç’°å¢ƒæ˜¯ç†æƒ³çš„ã€‚å…ˆæ¸…ç†å†å»ºç«‹æ˜¯æ›´ç©©å¥çš„åšæ³•ã€‚

---

### ç’°å¢ƒè®Šæ•¸èˆ‡æ©Ÿå¯†å®‰å…¨

#### env_file çš„ä½œç”¨

```yaml
# docker-compose.prod.yml
services:
  web:
    image: elsachung/project-practice:latest
    env_file:
      - .env # å®¹å™¨å•Ÿå‹•æ™‚ï¼Œè®€å– .env ä¸¦æ³¨å…¥åˆ°å®¹å™¨å…§
```

#### .env æœƒè¢«æ‰“åŒ…é€² Docker æ˜ åƒå—ï¼Ÿ

**ä¸æœƒï¼é€™æ˜¯ Docker çš„å®‰å…¨è¨­è¨ˆã€‚**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    .env åœ¨ä»€éº¼æ™‚å€™è¢«ä½¿ç”¨ï¼Ÿ                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  ã€docker build éšæ®µã€‘ï¼ˆæ‰“åŒ…æ˜ åƒï¼‰                                               â”‚
â”‚                                                                                 â”‚
â”‚  Dockerfile åŸ·è¡Œï¼š                                                               â”‚
â”‚  - FROM python:3.11-slim                                                        â”‚
â”‚  - COPY requirements.txt .                                                      â”‚
â”‚  - pip install ...                                                              â”‚
â”‚  - COPY . .                â† è¤‡è£½ç¨‹å¼ç¢¼ï¼Œä½† .env è¢« .dockerignore æ’é™¤          â”‚
â”‚                                                                                 â”‚
â”‚  æ˜ åƒè£¡é¢ã€Œæ²’æœ‰ã€.env æª”æ¡ˆ                                                       â”‚
â”‚                                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                                 â”‚
â”‚  ã€docker-compose up éšæ®µã€‘ï¼ˆåŸ·è¡Œå®¹å™¨ï¼‰                                          â”‚
â”‚                                                                                 â”‚
â”‚  env_file:                                                                      â”‚
â”‚    - .env                  â† é€™æ™‚å€™æ‰è®€å–                                       â”‚
â”‚                                                                                 â”‚
â”‚  è®€å–ã€ŒåŸ·è¡Œé€™å€‹æŒ‡ä»¤çš„é‚£å°æ©Ÿå™¨ã€ä¸Šçš„ .envï¼š                                       â”‚
â”‚  - æœ¬æ©Ÿé–‹ç™¼ï¼šè®€ä½  Mac ä¸Šçš„ .env                                                 â”‚
â”‚  - EC2 éƒ¨ç½²ï¼šè®€ EC2 ä¸Šçš„ ~/app/.env                                             â”‚
â”‚                                                                                 â”‚
â”‚  ç’°å¢ƒè®Šæ•¸æ³¨å…¥åˆ°ã€ŒåŸ·è¡Œä¸­çš„å®¹å™¨ã€ï¼Œä¸æœƒè®Šæˆæ˜ åƒçš„ä¸€éƒ¨åˆ†                            â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ©Ÿå¯†åœ¨å„éšæ®µçš„ç‹€æ…‹

| éšæ®µ         | .env çš„ç‹€æ…‹  | åŸå›                     |
| ------------ | ------------ | ----------------------- |
| ä½ çš„ Mac     | âœ“ æœ‰         | ä½ è‡ªå·±å»ºç«‹çš„            |
| GitHub       | âœ— æ²’æœ‰       | .gitignore æ’é™¤         |
| Docker æ˜ åƒ  | âœ— æ²’æœ‰       | .dockerignore æ’é™¤      |
| Docker Hub   | âœ— æ²’æœ‰       | æ˜ åƒè£¡æ²’æœ‰              |
| EC2          | âœ“ æœ‰         | ä½ æ‰‹å‹•å»ºç«‹çš„ ~/app/.env |
| åŸ·è¡Œä¸­çš„å®¹å™¨ | âœ“ æœ‰ç’°å¢ƒè®Šæ•¸ | å¾ EC2 çš„ .env æ³¨å…¥     |

#### ç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆï¼Ÿ

**åˆ†é›¢ã€Œç¨‹å¼ç¢¼ã€å’Œã€Œæ©Ÿå¯†ã€**

```
Docker æ˜ åƒï¼ˆå¯ä»¥å…¬é–‹ï¼‰           .env æª”æ¡ˆï¼ˆåªå­˜åœ¨éƒ¨ç½²ç’°å¢ƒï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  - Python 3.11          â”‚      â”‚  DB_PASSWORD=xxx        â”‚
â”‚  - ä½ çš„ç¨‹å¼ç¢¼           â”‚  +   â”‚  JWT_SECRET_KEY=xxx     â”‚
â”‚  - å¥—ä»¶                 â”‚      â”‚  AWS_SECRET_ACCESS_KEY= â”‚
â”‚                         â”‚      â”‚                         â”‚
â”‚  ä¸åŒ…å«ä»»ä½•æ©Ÿå¯†ï¼       â”‚      â”‚  åªå­˜åœ¨åŸ·è¡Œç’°å¢ƒ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    åŸ·è¡Œä¸­çš„å®¹å™¨ï¼ˆæœ‰ç¨‹å¼ç¢¼ + æœ‰æ©Ÿå¯†ï¼‰
```

**å¥½è™•**ï¼š

- æ˜ åƒå¯ä»¥æ”¾ Docker Hubï¼Œä¸æ€•æ´©å¯†
- ä¸åŒç’°å¢ƒï¼ˆé–‹ç™¼ã€æ¸¬è©¦ã€ç”Ÿç”¢ï¼‰ç”¨ä¸åŒçš„ .env
- æ›å¯†ç¢¼åªè¦æ”¹ .envï¼Œä¸ç”¨é‡æ–° build æ˜ åƒ

---

### CI/CD ä¸­ Build å’Œ Run éšæ®µçš„å·®ç•°

#### ç™¼ç”Ÿåœ¨ä¸åŒçš„åœ°æ–¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CI/CD ä¸­çš„ Build å’Œ Run éšæ®µ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  ã€GitHub Actions Runnerã€‘ï¼ˆGitHub çš„é›²ç«¯æ©Ÿå™¨ï¼‰                                  â”‚
â”‚                                                                                 â”‚
â”‚  docker build                                                                   â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ è®€å– Dockerfile                                                       â”‚
â”‚       â”œâ”€â”€ åŸ·è¡Œ COPY . .ï¼ˆåƒè€ƒ .dockerignoreï¼Œè·³é .envï¼‰                        â”‚
â”‚       â”œâ”€â”€ é€™å°æ©Ÿå™¨ä¸Šæ ¹æœ¬æ²’æœ‰ä½ çš„ .envï¼ˆGitHub ä¸Šæ²’æœ‰ï¼‰                          â”‚
â”‚       â””â”€â”€ ç”¢ç”Ÿæ˜ åƒï¼Œæ¨åˆ° Docker Hub                                             â”‚
â”‚                                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                                 â”‚
â”‚  ã€EC2ã€‘ï¼ˆä½ çš„é›²ç«¯ä¸»æ©Ÿï¼‰                                                         â”‚
â”‚                                                                                 â”‚
â”‚  docker-compose up -d                                                           â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ è®€å– docker-compose.prod.yml                                          â”‚
â”‚       â”œâ”€â”€ çœ‹åˆ° env_file: .env                                                   â”‚
â”‚       â”œâ”€â”€ è®€å– EC2 ä¸Šçš„ ~/app/.envï¼ˆé€™å€‹æª”æ¡ˆå­˜åœ¨ï¼‰                              â”‚
â”‚       â””â”€â”€ æŠŠç’°å¢ƒè®Šæ•¸æ³¨å…¥åˆ°å®¹å™¨                                                  â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é—œéµå·®ç•°

| éšæ®µ                | åŸ·è¡Œä½ç½®              | æœ‰ .env å—ï¼Ÿ | åŸå›                                      |
| ------------------- | --------------------- | ------------ | ---------------------------------------- |
| `docker build`      | GitHub Actions Runner | âœ— æ²’æœ‰       | GitHub ä¸Šæ²’æœ‰ .envï¼ˆè¢« .gitignore æ’é™¤ï¼‰ |
| `docker-compose up` | EC2                   | âœ“ æœ‰         | ä½ æ‰‹å‹•å»ºç«‹çš„ ~/app/.env                  |

**ä¸æ˜¯ã€Œé¸æ“‡è®€ä¸è®€ã€ï¼Œè€Œæ˜¯ã€Œé‚£å€‹ä½ç½®æœ‰æ²’æœ‰ .envã€ã€‚**

---

### Deploy.yml Actions èªæ³•è§£æ

#### uses çš„æ ¼å¼

```
uses: ä½œè€…/Actionåç¨±@ç‰ˆæœ¬
      â”‚      â”‚        â”‚
      â”‚      â”‚        â””â”€â”€ v4 = ç‰ˆæœ¬ 4
      â”‚      â””â”€â”€ checkout = é€™å€‹ Action çš„åç¨±
      â””â”€â”€ actions = GitHub å®˜æ–¹å¸³è™Ÿ
```

#### ä½¿ç”¨çš„ Actions

| Action                          | ä½œè€…                   | åŠŸèƒ½                                   |
| ------------------------------- | ---------------------- | -------------------------------------- |
| `actions/checkout@v4`           | GitHub å®˜æ–¹            | æŠŠç¨‹å¼ç¢¼ä¸‹è¼‰åˆ° Runner                  |
| `actions/setup-python@v5`       | GitHub å®˜æ–¹            | å®‰è£æŒ‡å®šç‰ˆæœ¬çš„ Python                  |
| `docker/login-action@v3`        | Docker å®˜æ–¹            | ç™»å…¥ Docker Hub                        |
| `docker/setup-buildx-action@v3` | Docker å®˜æ–¹            | è¨­å®š Docker Buildxï¼ˆæ”¯æ´å¤šå¹³å° buildï¼‰ |
| `docker/build-push-action@v5`   | Docker å®˜æ–¹            | Build æ˜ åƒä¸¦ Push åˆ° Docker Hub        |
| `appleboy/ssh-action@v1.0.3`    | appleboyï¼ˆå°ç£é–‹ç™¼è€…ï¼‰ | SSH é€£ç·šåˆ°é ç«¯ä¸»æ©ŸåŸ·è¡ŒæŒ‡ä»¤             |

#### runs-on é¸é …

| é¸é …             | èªªæ˜                          |
| ---------------- | ----------------------------- |
| `ubuntu-latest`  | æœ€æ–°ç‰ˆ Ubuntuï¼ˆå…è²»é¡åº¦æœ€å¤šï¼‰ |
| `ubuntu-22.04`   | æŒ‡å®š Ubuntu 22.04             |
| `macos-latest`   | æœ€æ–°ç‰ˆ macOS                  |
| `windows-latest` | æœ€æ–°ç‰ˆ Windows                |

---

## 7. AWS Cloud Services

### ğŸ“ S3 + CloudFront

### æ¶æ§‹æ¦‚è¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              S3 + CloudFront æ¶æ§‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  ä½¿ç”¨è€…ä¸Šå‚³ç¥¨åˆ¸åœ–ç‰‡                                                              â”‚
â”‚        â”‚                                                                        â”‚
â”‚        â–¼                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚   FastAPI   â”‚ â”€â”€â”€â”€ â”‚   AWS S3    â”‚ â”€â”€â”€â”€ â”‚ CloudFront  â”‚                      â”‚
â”‚  â”‚  (EC2 ä¸Š)   â”‚      â”‚  (å„²å­˜åœ–ç‰‡)  â”‚      â”‚   (CDN)     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚        â”‚                                          â”‚                             â”‚
â”‚        â”‚                                          â”‚                             â”‚
â”‚        â–¼                                          â–¼                             â”‚
â”‚  å›å‚³ CloudFront URL              ä½¿ç”¨è€…ç€è¦½å™¨è«‹æ±‚åœ–ç‰‡æ™‚                         â”‚
â”‚  çµ¦å‰ç«¯é¡¯ç¤º                        å¾æœ€è¿‘çš„ç¯€é»å¿«é€Ÿå–å¾—                           â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### CloudFront URL å­˜åœ¨æ™‚æ©Ÿ

**CLOUDFRONT_URL æ˜¯ã€Œéƒ¨ç½²æ™‚å°±å·²å­˜åœ¨ã€ï¼Œä¸æ˜¯ã€Œä¸Šå‚³æ™‚å‹•æ…‹ç”¢ç”Ÿã€ã€‚**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ™‚é–“ç·š                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  ã€éƒ¨ç½²éšæ®µã€‘åœ¨ AWS Console è¨­å®šï¼ˆåªåšä¸€æ¬¡ï¼‰                                      â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ 1. å»ºç«‹ S3 Bucket                                                     â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ 2. å»ºç«‹ CloudFront Distributionï¼ŒæŒ‡å‘é€™å€‹ S3 Bucket                    â”‚
â”‚       â”‚       â”‚                                                                 â”‚
â”‚       â”‚       â””â”€â”€ AWS åˆ†é…ä¸€å€‹å›ºå®š Domainï¼šd1234abcd.cloudfront.net             â”‚
â”‚       â”‚           ï¼ˆé€™å€‹ Domain å¾æ­¤åˆ»èµ·å°±å·²å­˜åœ¨ï¼Œä¸æœƒæ”¹è®Šï¼‰                      â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ 3. æŠŠé€™å€‹ Domain è¨­å®šåˆ°ç’°å¢ƒè®Šæ•¸ï¼šCLOUDFRONT_URL                        â”‚
â”‚                                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                 â”‚
â”‚  ã€åŸ·è¡Œéšæ®µã€‘ä½¿ç”¨è€…ä¸Šå‚³æª”æ¡ˆï¼ˆæ¯æ¬¡ä¸Šå‚³éƒ½æœƒåŸ·è¡Œï¼‰                                    â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ s3_client.put_object() â†’ æª”æ¡ˆé€²å…¥ S3                                  â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ çµ„è£ URLï¼šCLOUDFRONT_URL + "/tickets/" + file_name                    â”‚
â”‚           â”‚                                                                     â”‚
â”‚           â””â”€â”€ CLOUDFRONT_URL æ—©å°±å­˜åœ¨ï¼Œé€™è£¡åªæ˜¯ã€Œä½¿ç”¨ã€å®ƒä¾†çµ„è£å®Œæ•´è·¯å¾‘           â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸€å€‹ CloudFront Distribution = ä¸€å€‹å›ºå®š URL

æ‰€æœ‰ä¸Šå‚³åˆ°é€™å€‹ S3 Bucket çš„æª”æ¡ˆï¼Œéƒ½å…±ç”¨åŒä¸€å€‹ `CLOUDFRONT_URL`ï¼Œåªæ˜¯**è·¯å¾‘**ä¸åŒï¼š

```
https://d1234abcd.cloudfront.net/tickets/image001.jpg
https://d1234abcd.cloudfront.net/tickets/image002.jpg
https://d1234abcd.cloudfront.net/tickets/image003.jpg
â”‚                              â”‚
â””â”€â”€ åŒä¸€å€‹ CLOUDFRONT_URL â”€â”€â”€â”€â”€â”´â”€â”€ ä¸åŒçš„æª”æ¡ˆè·¯å¾‘
```

### ã€Œå…ˆä¸Šå‚³å†çµ„è£ã€çš„å•†æ¥­é‚è¼¯è¨­è¨ˆ

```python
# ç¨‹å¼ç¢¼é †åº
s3_client.put_object(...)                              # 1. å…ˆä¸Šå‚³
cloudfront_url = f"{CLOUDFRONT_URL}/tickets/{file_name}"  # 2. å†çµ„è£ URL
```

**ç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆï¼Ÿ**

| é †åº       | åŸå›                           |
| ---------- | ----------------------------- |
| å…ˆä¸Šå‚³     | ç¢ºä¿æª”æ¡ˆ**ç¢ºå¯¦å­˜åœ¨**æ–¼ S3     |
| å†çµ„è£ URL | ç¢ºä¿é€™å€‹ URL **æœ‰æ±è¥¿å¯å­˜å–** |

**å¦‚æœé †åºåéä¾†æœƒæ€æ¨£ï¼Ÿï¼ˆæŠ€è¡“ä¸Šå¯è¡Œï¼Œä½†å•†æ¥­é‚è¼¯ä¸åˆç†ï¼‰**

```
æƒ…å¢ƒï¼šå…ˆçµ„è£ URLï¼Œå†ä¸Šå‚³ï¼ˆä½†ä¸Šå‚³å¤±æ•—äº†ï¼‰

1. cloudfront_url = f"{CLOUDFRONT_URL}/tickets/{file_name}"  â† çµ„è£æˆåŠŸ
2. s3_client.put_object(...)  â† ä¸Šå‚³å¤±æ•—ï¼

çµæœï¼š
- ä½ æœ‰ä¸€å€‹ã€Œçœ‹èµ·ä¾†æ­£ç¢ºã€çš„ URL
- ä½†é€™å€‹ URL æŒ‡å‘ä¸€å€‹ã€Œä¸å­˜åœ¨çš„æª”æ¡ˆã€
- ä½¿ç”¨è€…é»æ“Š â†’ 404 Not Found
```

### ç°¡å–®æ¯”å–»

```
CLOUDFRONT_URL å°±åƒã€Œå¤§æ¨“åœ°å€ã€
æª”æ¡ˆè·¯å¾‘å°±åƒã€Œæˆ¿é–“è™Ÿç¢¼ã€
ä¸Šå‚³æª”æ¡ˆå°±åƒã€ŒæŠŠæ±è¥¿æ”¾é€²æˆ¿é–“ã€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚  å¤§æ¨“åœ°å€ï¼ˆCLOUDFRONT_URLï¼‰                              â”‚
â”‚  â””â”€â”€ è“‹å¥½å¤§æ¨“æ™‚å°±æœ‰äº†ï¼Œæ°¸é ä¸è®Š                          â”‚
â”‚      https://d1234abcd.cloudfront.net                   â”‚
â”‚                                                         â”‚
â”‚  æˆ¿é–“è™Ÿç¢¼ï¼ˆæª”æ¡ˆè·¯å¾‘ï¼‰                                    â”‚
â”‚  â””â”€â”€ æ¯æ¬¡ä¸Šå‚³æ™‚æ±ºå®š                                      â”‚
â”‚      /tickets/image001.jpg                              â”‚
â”‚                                                         â”‚
â”‚  æ”¾æ±è¥¿é€²æˆ¿é–“ï¼ˆput_objectï¼‰                              â”‚
â”‚  â””â”€â”€ å¿…é ˆå…ˆæ”¾é€²å»ï¼Œåˆ¥äººæ‰èƒ½ä¾†æ‹¿                          â”‚
â”‚                                                         â”‚
â”‚  å®Œæ•´åœ°å€ = å¤§æ¨“åœ°å€ + æˆ¿é–“è™Ÿç¢¼                          â”‚
â”‚  https://d1234abcd.cloudfront.net/tickets/image001.jpg  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¸¸è¦‹èª¤è§£æ¾„æ¸…

| èª¤è§£                               | æ­£ç¢ºç†è§£                                                       |
| ---------------------------------- | -------------------------------------------------------------- |
| ä¸Šå‚³æˆåŠŸå¾Œæ‰ã€Œç”¢ç”Ÿã€CLOUDFRONT_URL | âœ— éŒ¯èª¤ã€‚CLOUDFRONT_URL åœ¨è¨­å®š CloudFront æ™‚å°±å·²å­˜åœ¨            |
| æ¯å€‹æª”æ¡ˆæœ‰ä¸åŒçš„ CLOUDFRONT_URL    | âœ— éŒ¯èª¤ã€‚æ‰€æœ‰æª”æ¡ˆå…±ç”¨åŒä¸€å€‹ï¼Œåªæ˜¯è·¯å¾‘ä¸åŒ                       |
| å…ˆçµ„è£ URL å†ä¸Šå‚³ä¹Ÿå¯ä»¥            | â–³ æŠ€è¡“ä¸Šå¯è¡Œï¼Œä½†å•†æ¥­é‚è¼¯ä¸åˆç†ï¼ˆå¯èƒ½ç”¢ç”ŸæŒ‡å‘ä¸å­˜åœ¨æª”æ¡ˆçš„ URLï¼‰ |

### å®Œæ•´ä¸Šå‚³æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           S3 ä¸Šå‚³å®Œæ•´æµç¨‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  1. ä½¿ç”¨è€…åœ¨å‰ç«¯é¸æ“‡åœ–ç‰‡                                                         â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  2. POST /api/sell_ticketsï¼ˆåŒ…å«åœ–ç‰‡æª”æ¡ˆï¼‰                                       â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  3. FastAPI é©—è­‰æª”æ¡ˆï¼ˆå‰¯æª”åã€å¤§å°ç­‰ï¼‰                                           â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  4. å‘¼å« upload_file_to_s3()                                                    â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â”œâ”€â”€ s3_client.put_object()  â† ä¸Šå‚³åˆ° S3ï¼ˆæ­¤æ™‚æ‰å»ºç«‹ç¶²è·¯é€£ç·šï¼‰              â”‚
â”‚       â”‚       â”‚                                                                 â”‚
â”‚       â”‚       â””â”€â”€ æˆåŠŸï¼šæª”æ¡ˆå­˜å…¥ S3 Bucket                                      â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ çµ„è£ CloudFront URL                                                   â”‚
â”‚           â”‚                                                                     â”‚
â”‚           â””â”€â”€ f"{CLOUDFRONT_URL}/tickets/{file_name}"                           â”‚
â”‚               ï¼ˆä½¿ç”¨æ—©å°±å­˜åœ¨çš„ CLOUDFRONT_URL + é€™æ¬¡çš„æª”åï¼‰                      â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  5. å›å‚³ CloudFront URL çµ¦ API                                                  â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  6. å°‡ URL å­˜å…¥è³‡æ–™åº«ï¼ˆtickets_for_sale.image_urlï¼‰                             â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â–¼                                                                         â”‚
â”‚  7. å‰ç«¯é¡¯ç¤ºåœ–ç‰‡æ™‚ï¼Œä½¿ç”¨é€™å€‹ CloudFront URL                                      â”‚
â”‚       â”‚                                                                         â”‚
â”‚       â””â”€â”€ ä½¿ç”¨è€…ç€è¦½å™¨ â†’ CloudFront CDN â†’ S3 â†’ å–å¾—åœ–ç‰‡                         â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### MIME é¡å‹çš„ä½œç”¨

```
ä¸Šå‚³æ™‚
    â”‚
    â”‚  s3_client.put_object(ContentType="image/jpeg")
    â–¼
S3 å„²å­˜ metadata
    â”‚
    â”‚  è¨˜ä½ã€Œé€™å€‹æª”æ¡ˆçš„ Content-Type æ˜¯ image/jpegã€
    â–¼
ä½¿ç”¨è€…è«‹æ±‚åœ–ç‰‡
    â”‚
    â”‚  GET https://cloudfront.../tickets/image123.jpg
    â–¼
S3/CloudFront å›å‚³
    â”‚
    â”‚  HTTP Response Header: Content-Type: image/jpeg
    â–¼
ç€è¦½å™¨çŸ¥é“é€™æ˜¯åœ–ç‰‡
    â”‚
    â””â”€â”€ ç›´æ¥é¡¯ç¤ºï¼ˆè€Œä¸æ˜¯ä¸‹è¼‰ï¼‰
```

---

## 8. Design Patterns

### ğŸ“ Singleton Patternï¼šSQS Client é€£ç·šç®¡ç†

#### å»ºç«‹é€£ç·šçš„æ™‚æ©Ÿ

```
æ™‚é–“è»¸ â†’

1. import sqs_utils
   â”‚
   â””â”€â”€ _sqs_client = None  â† åªæ˜¯åˆå§‹åŒ–è®Šæ•¸ç‚º Noneï¼Œæ²’æœ‰å»ºç«‹é€£ç·š

2. ç¬¬ä¸€æ¬¡å‘¼å« send_email_to_queue()
   â”‚
   â””â”€â”€ sqs = get_sqs_client()
       â”‚
       â””â”€â”€ if _sqs_client is None:  â† æ˜¯ None
           â”‚
           â””â”€â”€ _sqs_client = boto3.client(...)  â† é€™æ™‚æ‰å»ºç«‹é€£ç·šï¼

3. ç¬¬äºŒæ¬¡å‘¼å« send_email_to_queue()
   â”‚
   â””â”€â”€ sqs = get_sqs_client()
       â”‚
       â””â”€â”€ if _sqs_client is None:  â† ä¸æ˜¯ None
           â”‚
           â””â”€â”€ ç›´æ¥ return _sqs_client  â† é‡è¤‡ä½¿ç”¨ï¼Œä¸é‡æ–°é€£ç·š
```

#### ç‚ºä»€éº¼ä½¿ç”¨ Singleton Pattern

| å•é¡Œ                                     | è§£æ±ºæ–¹æ¡ˆ                        |
| ---------------------------------------- | ------------------------------- |
| æ¯æ¬¡å‘¼å« `boto3.client()` éƒ½æœƒå»ºç«‹æ–°é€£ç·š | ç”¨ Singleton åªå»ºç«‹ä¸€æ¬¡         |
| é€£ç·šå»ºç«‹éœ€è¦æ™‚é–“ï¼ˆç¶²è·¯å»¶é²ï¼‰             | é‡è¤‡ä½¿ç”¨å·²å»ºç«‹çš„é€£ç·š            |
| å¦‚æœæ¯å° Email éƒ½å»ºç«‹æ–°é€£ç·šï¼Œæµªè²»è³‡æº    | æ•´å€‹ç¨‹å¼åŸ·è¡ŒæœŸé–“å…±ç”¨ä¸€å€‹ Client |

#### ç‚ºä»€éº¼è®Šæ•¸è¦å®£å‘Šåœ¨å‡½æ•¸å¤–é¢

```python
# âŒ éŒ¯èª¤å¯«æ³•ï¼šå¯«åœ¨å‡½æ•¸è£¡é¢
def get_sqs_client():
    _sqs_client = None  # â† å€åŸŸè®Šæ•¸ï¼Œæ¯æ¬¡å‘¼å«éƒ½æœƒé‡è¨­ç‚º None
    if _sqs_client is None:
        _sqs_client = boto3.client(...)  # â† æ¯æ¬¡éƒ½æœƒé‡æ–°å»ºç«‹ï¼
    return _sqs_client

# âœ“ æ­£ç¢ºå¯«æ³•ï¼šå¯«åœ¨å‡½æ•¸å¤–é¢ï¼ˆæ¨¡çµ„å±¤ç´šï¼‰
_sqs_client = None  # â† æ¨¡çµ„å±¤ç´šè®Šæ•¸ï¼Œåªåœ¨ import æ™‚åŸ·è¡Œä¸€æ¬¡

def get_sqs_client():
    global _sqs_client  # â† å®£å‘Šè¦ä¿®æ”¹çš„æ˜¯æ¨¡çµ„å±¤ç´šçš„è®Šæ•¸
    if _sqs_client is None:
        _sqs_client = boto3.client(...)  # â† åªæœ‰ç¬¬ä¸€æ¬¡å‘¼å«æ‰æœƒå»ºç«‹
    return _sqs_client
```

#### Python è®Šæ•¸ä½œç”¨åŸŸåŸå‰‡

| æƒ…æ³                         | éœ€è¦ global å—                           |
| ---------------------------- | ---------------------------------------- |
| åœ¨å‡½æ•¸å…§ã€Œè®€å–ã€æ¨¡çµ„å±¤ç´šè®Šæ•¸ | ä¸éœ€è¦                                   |
| åœ¨å‡½æ•¸å…§ã€Œä¿®æ”¹ã€æ¨¡çµ„å±¤ç´šè®Šæ•¸ | éœ€è¦ `global` å®£å‘Š                       |
| æ²’æœ‰ `global` å°±ä¿®æ”¹         | æœƒå»ºç«‹æ–°çš„å€åŸŸè®Šæ•¸ï¼Œä¸æœƒä¿®æ”¹æ¨¡çµ„å±¤ç´šè®Šæ•¸ |

---

### Singleton Patternï¼šå…©ç¨®å¯¦ä½œæ–¹å¼

### Eager Singletonï¼ˆæ€¥åˆ‡åˆå§‹åŒ–ï¼‰

```python
# s3_utils.py çš„å¯«æ³•
s3_client = boto3.client("s3", ...)  # import æ™‚å°±å»ºç«‹
```

**ç‰¹é»**ï¼š

- ç¨‹å¼ç¢¼ç°¡å–®ï¼ˆä¸€è¡Œï¼‰
- import æ™‚å°±å»ºç«‹ï¼Œä¸ç®¡æœ‰æ²’æœ‰ç”¨åˆ°
- é©åˆï¼šå¹¾ä¹ä¸€å®šæœƒç”¨åˆ°çš„æœå‹™

### Lazy Singletonï¼ˆå»¶é²åˆå§‹åŒ–ï¼‰

```python
# sqs_utils.py çš„å¯«æ³•
_sqs_client = None  # import æ™‚åªå®£å‘Š

def get_sqs_client():
    global _sqs_client
    if _sqs_client is None:
        _sqs_client = boto3.client('sqs', ...)
    return _sqs_client
```

**ç‰¹é»**ï¼š

- ç¨‹å¼ç¢¼è¼ƒè¤‡é›œï¼ˆéœ€è¦å‡½æ•¸ + globalï¼‰
- ç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚æ‰å»ºç«‹
- é©åˆï¼šå¯èƒ½ä¸æœƒç”¨åˆ°çš„æœå‹™

### æ¯”è¼ƒ

| é …ç›®         | Eagerï¼ˆS3ï¼‰ | Lazyï¼ˆSQSï¼‰        |
| ------------ | ----------- | ------------------ |
| å»ºç«‹æ™‚æ©Ÿ     | import æ™‚   | ç¬¬ä¸€æ¬¡å‘¼å«æ™‚       |
| ç¨‹å¼ç¢¼è¤‡é›œåº¦ | ä½          | é«˜                 |
| æ²’ç”¨åˆ°æ™‚     | é‚„æ˜¯æœƒå»ºç«‹  | ä¸æœƒå»ºç«‹           |
| é©åˆå ´æ™¯     | æ ¸å¿ƒåŠŸèƒ½    | æœ‰ fallback çš„åŠŸèƒ½ |

**å…©è€…éƒ½æ˜¯ Singleton**ï¼šæ¨¡çµ„å±¤ç´šè®Šæ•¸åœ¨æ•´å€‹ç¨‹å¼æœŸé–“åªæœ‰ä¸€å€‹å¯¦ä¾‹ã€‚

### ç‚ºä»€éº¼ Python æ¨¡çµ„è®Šæ•¸æ˜¯ Singletonï¼Ÿ

```python
# ç¬¬ä¸€æ¬¡ import s3_utils
import s3_utils  # Python åŸ·è¡Œæ¨¡çµ„ï¼Œå»ºç«‹ s3_client

# ç¬¬äºŒæ¬¡ import s3_utils
import s3_utils  # Python ç™¼ç¾å·²ç¶“ import éï¼Œä¸æœƒé‡æ–°åŸ·è¡Œ
                 # ç›´æ¥ä½¿ç”¨ä¹‹å‰çš„ s3_client

# çµè«–ï¼šæ¨¡çµ„å±¤ç´šè®Šæ•¸å¤©ç”Ÿå°±æ˜¯ Singleton
```

---

#### ä¸‰ç¨®å·¥å…·çš„ Singleton è¨­è¨ˆæ¯”è¼ƒ

| é …ç›®                     | s3_utils       | sqs_utils          | redis_utils          |
| ------------------------ | -------------- | ------------------ | -------------------- |
| **Singleton é¡å‹**       | Eager          | Lazy               | Eagerï¼ˆé€£ç·šæ± ï¼‰      |
| **Singleton å°è±¡**       | å®¢æˆ¶ç«¯ç‰©ä»¶     | å®¢æˆ¶ç«¯ç‰©ä»¶         | é€£ç·šæ± ï¼ˆä¸æ˜¯å®¢æˆ¶ç«¯ï¼‰ |
| **æ¨¡çµ„å±¤ç´šè®Šæ•¸**         | `s3_client`    | `_sqs_client`      | `REDIS_POOL`         |
| **import æ™‚**            | å»ºç«‹å®¢æˆ¶ç«¯ç‰©ä»¶ | åªå®£å‘Š None        | å»ºç«‹é€£ç·šæ± ç‰©ä»¶       |
| **å–å¾—å‡½æ•¸**             | ä¸éœ€è¦å‡½æ•¸     | `get_sqs_client()` | `get_redis_client()` |
| **æ¯æ¬¡å‘¼å«å»ºç«‹æ–°ç‰©ä»¶ï¼Ÿ** | å¦             | å¦                 | æ˜¯ï¼ˆå®¢æˆ¶ç«¯å¾ˆè¼•é‡ï¼‰   |
| **é€£ç·šç®¡ç†**             | boto3 å…§éƒ¨è™•ç† | boto3 å…§éƒ¨è™•ç†     | é€£ç·šæ± ç®¡ç†           |

#### ç‚ºä»€éº¼è¨­è¨ˆä¸åŒï¼Ÿ

| å·¥å…·      | ä½¿ç”¨é »ç‡           | é€£ç·šç‰¹æ€§     | è¨­è¨ˆé¸æ“‡                         |
| --------- | ------------------ | ------------ | -------------------------------- |
| **S3**    | è¼ƒä½ï¼ˆä¸Šå‚³æª”æ¡ˆï¼‰   | HTTP çŸ­é€£ç·š  | Eagerï¼šæ ¸å¿ƒåŠŸèƒ½ï¼Œä¸€å®šæœƒç”¨        |
| **SQS**   | è¼ƒä½ï¼ˆç™¼é€è¨Šæ¯ï¼‰   | HTTP çŸ­é€£ç·š  | Lazyï¼šæœ‰ fallbackï¼Œå¯èƒ½ä¸ç”¨      |
| **Redis** | å¾ˆé«˜ï¼ˆæ¯æ¬¡æŸ¥å¿«å–ï¼‰ | TCP æŒä¹…é€£ç·š | é€£ç·šæ± ï¼šé«˜é »æ“ä½œéœ€è¦é‡è¤‡ä½¿ç”¨é€£ç·š |

#### æµç¨‹æ¯”è¼ƒåœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ä¸‰ç¨®å·¥å…·çš„å»ºç«‹æ™‚æ©Ÿæ¯”è¼ƒ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  ã€S3 - Eager Singletonã€‘                                                       â”‚
â”‚                                                                                 â”‚
â”‚  import s3_utils                                                                â”‚
â”‚       â””â”€â”€ s3_client = boto3.client("s3", ...) â† å»ºç«‹å®¢æˆ¶ç«¯ç‰©ä»¶                  â”‚
â”‚                                                                                 â”‚
â”‚  s3_client.put_object(...)                                                      â”‚
â”‚       â””â”€â”€ å»ºç«‹ç¶²è·¯é€£ç·š â† é€™æ™‚æ‰é€£ç·š                                             â”‚
â”‚                                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                                 â”‚
â”‚  ã€SQS - Lazy Singletonã€‘                                                       â”‚
â”‚                                                                                 â”‚
â”‚  import sqs_utils                                                               â”‚
â”‚       â””â”€â”€ _sqs_client = None â† åªå®£å‘Šï¼Œä»€éº¼éƒ½æ²’å»ºç«‹                             â”‚
â”‚                                                                                 â”‚
â”‚  ç¬¬ä¸€æ¬¡ get_sqs_client()                                                        â”‚
â”‚       â””â”€â”€ _sqs_client = boto3.client("sqs", ...) â† å»ºç«‹å®¢æˆ¶ç«¯ç‰©ä»¶               â”‚
â”‚                                                                                 â”‚
â”‚  ç¬¬äºŒæ¬¡ get_sqs_client()                                                        â”‚
â”‚       â””â”€â”€ return _sqs_client â† ç›´æ¥å›å‚³ä¹‹å‰çš„                                   â”‚
â”‚                                                                                 â”‚
â”‚  sqs.send_message(...)                                                          â”‚
â”‚       â””â”€â”€ å»ºç«‹ç¶²è·¯é€£ç·š â† é€™æ™‚æ‰é€£ç·š                                             â”‚
â”‚                                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                                 â”‚
â”‚  ã€Redis - é€£ç·šæ± æ¨¡å¼ã€‘                                                          â”‚
â”‚                                                                                 â”‚
â”‚  import redis_utils                                                             â”‚
â”‚       â””â”€â”€ REDIS_POOL = redis.ConnectionPool(...) â† å»ºç«‹é€£ç·šæ± ï¼ˆç©ºçš„ï¼‰           â”‚
â”‚                                                                                 â”‚
â”‚  get_redis_client()                                                             â”‚
â”‚       â””â”€â”€ redis.Redis(connection_pool=REDIS_POOL) â† å»ºç«‹å®¢æˆ¶ç«¯ï¼ˆæ¯æ¬¡éƒ½æ–°çš„ï¼‰    â”‚
â”‚                                                                                 â”‚
â”‚  redis_client.get("key")                                                        â”‚
â”‚       â”œâ”€â”€ æ± æ˜¯ç©ºçš„ â†’ å»ºç«‹é€£ç·š â†’ ä½¿ç”¨ â†’ æ­¸é‚„                                     â”‚
â”‚       â””â”€â”€ æ± ä¸­æœ‰é€£ç·š â†’ å–å‡º â†’ ä½¿ç”¨ â†’ æ­¸é‚„ï¼ˆä¸å»ºç«‹æ–°é€£ç·šï¼‰                       â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å¸¸è¦‹å•é¡Œ

#### Q1ï¼šredis_utils æ˜¯ Singleton å—ï¼Ÿ

**ç­”**ï¼š

- **é€£ç·šæ± æ˜¯ Singleton**ï¼ˆæ¨¡çµ„å±¤ç´šè®Šæ•¸ `REDIS_POOL`ï¼‰
- **å®¢æˆ¶ç«¯ç‰©ä»¶ä¸æ˜¯ Singleton**ï¼ˆæ¯æ¬¡å‘¼å«éƒ½å»ºç«‹æ–°çš„ï¼‰
- å®¢æˆ¶ç«¯ç‰©ä»¶å¾ˆè¼•é‡ï¼ˆåªæ˜¯ Python ç‰©ä»¶ï¼‰ï¼Œæ‰€ä»¥æ¯æ¬¡å»ºç«‹æ–°çš„æ²’é—œä¿‚
- çœŸæ­£æ˜‚è²´çš„æ˜¯ç¶²è·¯é€£ç·šï¼Œç”±é€£ç·šæ± ç®¡ç†é‡è¤‡ä½¿ç”¨

#### Q2ï¼šRedis å’Œ S3ã€SQS çš„ Singleton æœ‰ä»€éº¼ä¸åŒï¼Ÿ

**ç­”**ï¼š

- S3/SQSï¼š**å®¢æˆ¶ç«¯ç‰©ä»¶**æ˜¯ Singleton
- Redisï¼š**é€£ç·šæ± **æ˜¯ Singletonï¼Œå®¢æˆ¶ç«¯ç‰©ä»¶ä¸æ˜¯
- åŸå› ï¼šRedis æ“ä½œé »ç‡é«˜ï¼Œéœ€è¦é€£ç·šæ± ç®¡ç† TCP æŒä¹…é€£ç·š
- S3/SQS æ˜¯ HTTP çŸ­é€£ç·šï¼Œboto3 å…§éƒ¨å·²æœ‰é€£ç·šæ± æ©Ÿåˆ¶

---

### ğŸ“ AAA æ¸¬è©¦æ¨¡å¼

### å–®å…ƒæ¸¬è©¦è¨­è¨ˆåŸå‰‡

### AAA æ¨¡å¼ï¼ˆArrange-Act-Assertï¼‰

```python
def test_verify_password_correct(self, sample_password):
    # Arrangeï¼ˆæº–å‚™ï¼‰- æº–å‚™æ¸¬è©¦éœ€è¦çš„è³‡æ–™
    hashed = hash_password(sample_password)

    # Actï¼ˆåŸ·è¡Œï¼‰- å‘¼å«è¦è¢«æ¸¬è©¦çš„å‡½æ•¸
    result = verify_password(sample_password, hashed)

    # Assertï¼ˆé©—è­‰ï¼‰- æª¢æŸ¥çµæœæ˜¯å¦ç¬¦åˆé æœŸ
    assert result is True
```

### æ¸¬è©¦é¡å‹

| é¡å‹         | èªªæ˜                       | ç¯„ä¾‹                     |
| ------------ | -------------------------- | ------------------------ |
| **æ­£å‘æ¸¬è©¦** | æ¸¬è©¦æ­£å¸¸æƒ…æ³æ˜¯å¦èƒ½æˆåŠŸ     | æ­£ç¢ºå¯†ç¢¼æ‡‰è©²é©—è­‰é€šé     |
| **è² å‘æ¸¬è©¦** | æ¸¬è©¦éŒ¯èª¤æƒ…æ³æ˜¯å¦è¢«æ­£ç¢ºæ‹’çµ• | éŒ¯èª¤å¯†ç¢¼æ‡‰è©²é©—è­‰å¤±æ•—     |
| **é‚Šç•Œæ¸¬è©¦** | æ¸¬è©¦æ¥µç«¯æˆ–é‚Šç•Œæƒ…æ³         | ç©ºå­—ä¸²ã€Noneã€éæœŸ Token |

### pytest.raises ç”¨æ³•

ç”¨ä¾†æ¸¬è©¦ã€Œé æœŸæœƒæ‹‹å‡ºä¾‹å¤–ã€çš„æƒ…æ³ï¼š

```python
def test_verify_invalid_token_raises_error(self):
    invalid_token = "this.is.not.valid"

    # with pytest.raises æ•æ‰ä¾‹å¤–
    with pytest.raises(HTTPException) as exc_info:
        verify_token(invalid_token)  # é€™è¡Œæ‡‰è©²æ‹‹å‡º HTTPException

    # exc_info.value æ˜¯æ•æ‰åˆ°çš„ä¾‹å¤–ç‰©ä»¶
    assert exc_info.value.status_code == 401
    assert "ç„¡æ•ˆ" in exc_info.value.detail
```

### æ¸¬è©¦ã€Œåœ¨å“ªè£¡è¢«æ“‹ä½ã€

ç•¶å¤šå€‹å‡½æ•¸éƒ½å¯èƒ½æ‹‹å‡ºç›¸åŒéŒ¯èª¤æ™‚ï¼Œæª¢æŸ¥éŒ¯èª¤è¨Šæ¯å¯ä»¥ç¢ºèªéŒ¯èª¤ç™¼ç”Ÿåœ¨æ­£ç¢ºçš„ä½ç½®ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           get_current_user çš„å…©é“é˜²ç·š                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  def get_current_user(authorization):                                           â”‚
â”‚      â”‚                                                                          â”‚
â”‚      â”‚  ç¬¬ä¸€é“é˜²ç·šï¼šæª¢æŸ¥ Header æ ¼å¼                                             â”‚
â”‚      â”œâ”€â”€ if authorization is None:                                              â”‚
â”‚      â”‚       raise 401 "Missing..."  â† æ¸¬è©¦ 2 æ‡‰è©²åœ¨é€™è£¡è¢«æ“‹ä½                  â”‚
â”‚      â”‚                                                                          â”‚
â”‚      â”‚  ç¬¬äºŒé“é˜²ç·šï¼šé©—è­‰ Token                                                   â”‚
â”‚      â””â”€â”€ return verify_token(token)                                             â”‚
â”‚              â”‚                                                                  â”‚
â”‚              â””â”€â”€ raise 401 "ç„¡æ•ˆçš„ token"  â† æ¸¬è©¦ 4 åœ¨é€™è£¡è¢«æ“‹ä½ä¹Ÿ OK            â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| æ¸¬è©¦   | å‚³å…¥å€¼      | æ¸¬è©¦ç›®çš„              | æ˜¯å¦æª¢æŸ¥éŒ¯èª¤è¨Šæ¯ |
| ------ | ----------- | --------------------- | ---------------- |
| æ¸¬è©¦ 2 | `None`      | ç¢ºèªç¬¬ä¸€é“é˜²ç·šæœ‰ä½œç”¨  | âœ“ æª¢æŸ¥ "Missing" |
| æ¸¬è©¦ 4 | `"Bearer "` | ç¢ºèªç©º token æœƒè¢«æ‹’çµ• | âœ— åªæª¢æŸ¥ 401     |

### Fixture çš„ä½¿ç”¨

Fixture æ˜¯ pytest æä¾›çš„ã€Œå¯é‡ç”¨æ¸¬è©¦è³‡æ–™ã€æ©Ÿåˆ¶ï¼š

```python
# conftest.py
@pytest.fixture
def sample_password():
    return "TestPassword123"

@pytest.fixture
def sample_user_data():
    return {"id": 1, "email": "test@example.com", "name": "Test User"}

# test_auth_utils.py
def test_hash_password(self, sample_password):  # â† è‡ªå‹•æ³¨å…¥ fixture
    result = hash_password(sample_password)
    assert result != sample_password
```

### JWT ç›¸é—œæ¸¬è©¦é‡é»

| æ¸¬è©¦é‡é»                | ç‚ºä»€éº¼é‡è¦                      |
| ----------------------- | ------------------------------- |
| **å¯†ç¢¼æœ‰è¢«åŠ å¯†**        | ç¢ºä¿ä¸æœƒæŠŠæ˜ç¢¼å­˜å…¥è³‡æ–™åº«        |
| **æ¯æ¬¡åŠ å¯†çµæœä¸åŒ**    | ç¢ºä¿æœ‰ä½¿ç”¨ saltï¼ˆé˜²å½©è™¹è¡¨æ”»æ“Šï¼‰ |
| **æ­£ç¢ºå¯†ç¢¼é€šéé©—è­‰**    | ç¢ºä¿ä½¿ç”¨è€…èƒ½æ­£å¸¸ç™»å…¥            |
| **éŒ¯èª¤å¯†ç¢¼è¢«æ‹’çµ•**      | ç¢ºä¿ä¸æœƒè®“ä»»ä½•å¯†ç¢¼éƒ½é€šé        |
| **Token åŒ…å«æ­£ç¢ºè³‡æ–™**  | ç¢ºä¿ä½¿ç”¨è€…èº«ä»½è³‡è¨Šæ­£ç¢º          |
| **éæœŸ Token è¢«æ‹’çµ•**   | ç¢ºä¿éæœŸæ©Ÿåˆ¶æœ‰ä½œç”¨              |
| **è¢«ç«„æ”¹ Token è¢«æ‹’çµ•** | ç¢ºä¿ç°½åé©—è­‰æœ‰ä½œç”¨ï¼ˆå®‰å…¨æ€§ï¼‰    |

### å®‰å…¨æ¸¬è©¦ï¼šè¢«ç«„æ”¹çš„ Token

```python
def test_verify_tampered_token_raises_error(self, sample_user_data):
    # å»ºç«‹æœ‰æ•ˆ token
    token = create_access_token(data=sample_user_data)

    # ç«„æ”¹ tokenï¼ˆä¿®æ”¹æœ€å¾Œ 5 å€‹å­—å…ƒï¼‰
    tampered_token = token[:-5] + "XXXXX"

    # è¢«ç«„æ”¹çš„ token æ‡‰è©²è¢«æ‹’çµ•
    with pytest.raises(HTTPException) as exc_info:
        verify_token(tampered_token)

    assert exc_info.value.status_code == 401
```

**åŸç†**ï¼šJWT çš„ Signature æ˜¯ç”¨ SECRET_KEY å° Header + Payload ç°½åã€‚å¦‚æœå…§å®¹è¢«ç«„æ”¹ï¼Œé‡æ–°è¨ˆç®—çš„ Signature æœƒèˆ‡åŸæœ¬ä¸åŒï¼Œ`jwt.decode()` æœƒæ‹‹å‡ºéŒ¯èª¤ã€‚

---

## 9. Future Improvements

### ğŸ”§ Router/Service åˆ†å±¤

**ç¾æ³ï¼š**

- Router å’Œ Service æœªåˆ†é–‹, å…¨éƒ¨å¯«åœ¨ Routes è³‡æ–™å¤¾ä¸­
- å°è‡´ Router å±¤ç„¡æ³•å°ˆè²¬è™•ç† HTTP è«‹æ±‚èˆ‡è½‰ç™¼ï¼Œè€Œæ˜¯åŒæ™‚é‚„è¦è™•ç†æ‡‰ç”± Service å±¤è™•ç†çš„å•†æ¥­é‚è¼¯

**TODOï¼š**

- [ ] é‡æ§‹ - å°‡ Router å±¤å’Œ Service å±¤åˆ†é–‹

---

### ğŸ”§ å‘½åçµ±ä¸€

### Token Payload èˆ‡ get_current_user çš„ Key å‘½å

**ç¾æ³ï¼š**

- `create_access_token` å‚³å…¥çš„ payload key æ˜¯ `"id"`

```python
  data={"id": user_id, "email": data.email, "name": data.name}
```

- `get_current_user` å›å‚³çš„ key æ˜¯ `"user_id"`

```python
  user["user_id"]
```

- å› ç‚º `get_current_user` å…§éƒ¨çš„`verify_token` æœ‰åšè½‰æ›ï¼Œæ‰€ä»¥ç›®å‰å¯æ­£å¸¸é‹ä½œ

**å•é¡Œï¼š**

- å‘½åä¸ä¸€è‡´ï¼Œå¢åŠ ç¶­è­·æ™‚çš„èªçŸ¥è² æ“”
- æ–°é–‹ç™¼è€…å®¹æ˜“æ··æ·†

**TODOï¼š**

- [ ] çµ±ä¸€å‘½åç‚º `id` æˆ– `user_id`ï¼ˆæ“‡ä¸€ï¼‰
- [ ] åŒæ­¥ä¿®æ”¹ `create_access_token` èˆ‡ `verify_token`

---

### GET /api/user/auth

**ç¾æ³ï¼š**

- `auth.py` çš„ `UserProfileOut` å¤šå®šç¾©äº† `avg_rating: Union[float, None] = None`
- å°è‡´ Response ä¸­å‡ºç¾ `avg_rating: null`ï¼ˆç„¡å¯¦éš›å½±éŸ¿ï¼‰

**è¨­è¨ˆæ„åœ–ï¼š**

- `/api/user/auth`ï¼šåƒ…ç”¨æ–¼èº«ä»½é©—è­‰ï¼Œä¸éœ€è¦ `avg_rating`
- `/api/user/profile`ï¼šæ¸²æŸ“å€‹äººè³‡æ–™é æ™‚æ‰æ’ˆå– `avg_rating`

**TODOï¼š**

- [ ] è€ƒæ…®å¾ `UserProfileOut` ç§»é™¤ `avg_rating`ï¼Œæˆ–å»ºç«‹ç¨ç«‹çš„ `AuthResponse` model

---

### GET /api/user/auth çš„ response_model

**ç¾æ³ï¼š**

- `response_model=Optional[UserProfileOut]` æš—ç¤ºå¯èƒ½å›å‚³ `None`

**å¯¦éš›è¡Œç‚ºï¼š**

- è‹¥ `get_current_user` é©—è­‰å¤±æ•— â†’ ç›´æ¥æ‹‹ `HTTPException 401`ï¼Œä¸æœƒé€²å…¥å‡½æ•¸
- åªæœ‰ç•¶ `get_member_row_by_id(user_id)` æŸ¥ç„¡è³‡æ–™æ™‚æ‰å›å‚³ `None`
- ä½†é€™å¹¾ä¹ä¸å¯èƒ½ç™¼ç”Ÿï¼Œå› ç‚º token ä¸­çš„ `user_id` ä¾†è‡ªæœ‰æ•ˆè¨»å†Š

**çµè«–ï¼š**

- `Optional` åœ¨æ­¤è™•èªæ„ä¸ç²¾ç¢ºï¼Œå¯¦éš›ä¸Šä¸æœƒå›å‚³ `None`

**TODOï¼š**

- [ ] ç§»é™¤ `Optional`ï¼Œæ”¹ç‚º `response_model=UserProfileOut`
- [ ] æŸ¥ç„¡è³‡æ–™æ™‚æ”¹æ‹‹ `HTTPException 404`

---

### GET /api/user/profile vs GET /api/user/auth

**è¨­è¨ˆå€åˆ¥ï¼š**

| API                 | ç”¨é€”                     | æ˜¯å¦åŒ…å« `avg_rating` |
| ------------------- | ------------------------ | --------------------- |
| `/api/user/auth`    | é©—è­‰ç™»å…¥ç‹€æ…‹ã€æ¸²æŸ“å°è¦½åˆ— | âœ— ä¸éœ€è¦              |
| `/api/user/profile` | æ¸²æŸ“å€‹äººè³‡æ–™é            | âœ“ éœ€è¦                |

**ç¾æ³ï¼š**

- å…©è€…éƒ½ä½¿ç”¨ `UserProfileOut`ï¼Œä½†å®šç¾©åœ¨ä¸åŒæª”æ¡ˆï¼ˆ`auth.py` å’Œ `users.py`ï¼‰
- é€ æˆé‡è¤‡å®šç¾©

**TODOï¼š**

- [ ] è€ƒæ…®å°‡ `UserProfileOut` é›†ä¸­åˆ° `schemas/user.py`
- [ ] æˆ–ç‚º `/api/user/auth` å»ºç«‹ç¨ç«‹çš„ `AuthResponse` model

---

### HTTPException çš„è™•ç†ä½ç½® (Model å±¤è¨­è¨ˆåŸå‰‡)

**ç¾æ³ï¼š**

- éƒ¨åˆ† Model å‡½æ•¸ç›´æ¥æ‹‹ `HTTPException`ï¼ˆå¦‚ `ensure_email_unique_for_update`ï¼‰
- éƒ¨åˆ† Model å‡½æ•¸å›å‚³ `None` è®“ Router è™•ç†ï¼ˆå¦‚ `get_user_profile`ï¼‰
- é¢¨æ ¼ä¸ä¸€è‡´

**ç†æƒ³åšæ³•ï¼š**

- Model å±¤åªåšè³‡æ–™åº«æ“ä½œï¼Œå›å‚³è³‡æ–™æˆ– `None`
- Router å±¤è² è²¬åˆ¤æ–·ä¸¦æ‹‹å‡º `HTTPException`

**ç›®å‰æ±ºå®šï¼š**

- æš«æ™‚ç¶­æŒç¾ç‹€ï¼ŒåŠŸèƒ½æ­£å¸¸é‹ä½œ
- æ—¥å¾Œæœ‰ç©ºå†çµ±ä¸€é‡æ§‹

**TODOï¼š**

- [ ] å°‡æ‰€æœ‰ Model å±¤çš„ `HTTPException` ç§»åˆ° Router å±¤

---

### ç¨‹å¼ç¢¼é‡æ§‹å»ºè­°

### é‡è¤‡çš„è³‡æ–™è™•ç†é‚è¼¯

`get_buyer_orders_api` å’Œ `get_seller_orders_api` æœ‰å¤§é‡é‡è¤‡çš„è³‡æ–™è™•ç†é‚è¼¯ï¼š

```python
# ä»¥ä¸‹é‚è¼¯åœ¨å…©å€‹ API ä¸­å®Œå…¨ç›¸åŒ
row["start_time"] = str(row["start_time"])[:5]
row["weekday"] = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"][row["game_date"].weekday()]
row["game_date"] = row["game_date"].strftime("%Y-%m-%d")
row["stadium_url"] = {...}.get(row["stadium"], "#")
row["image_urls"] = json.loads(row["image_urls"]) if row["image_urls"] else []
row["note"] = row["note"] if row["note"] else ""
```

#### å»ºè­°é‡æ§‹æ–¹å¼

**Step 1ï¼šå°‡çƒå ´ URL æŠ½åˆ° constants.py**

```python
# config/constants.py
STADIUM_URLS = {
    "å¤§å·¨è›‹": "https://maps.app.goo.gl/m53dt8TAUQkWXBvD9",
    "æ¨‚å¤©æ¡ƒåœ’": "https://maps.app.goo.gl/otKHfBHksTKJk8uV8",
    "å°å—": "https://maps.app.goo.gl/Y4SgmRbEBCehqaH89",
    "å¤©æ¯": "https://maps.app.goo.gl/WGsmw7y38Apdkcsm7",
    "æ–°èŠ": "https://maps.app.goo.gl/evnUECyJsLx3rkaE8",
    "æ¾„æ¸…æ¹–": "https://maps.app.goo.gl/T4wG6E4ED5jKnxaz6",
    "æ´²éš›": "https://maps.app.goo.gl/U6ZfbxwGp1t9APvN7",
    "å˜‰ç¾©å¸‚": "https://maps.app.goo.gl/rv8mNF2bnW5xuFcZ8",
    "èŠ±è“®": "https://maps.app.goo.gl/UCvKfG29V7uEUc4G6",
    "æ–—å…­": "https://maps.app.goo.gl/VmwmTQKSVQ5SBPVFA",
    "å°æ±": "https://maps.app.goo.gl/9yAJEH2JvA5utWfx5",
}
```

**Step 2ï¼šæŠ½å‡ºå…±ç”¨å‡½æ•¸**

```python
# utils/format_utils.py
import json
from datetime import date
from config.constants import STADIUM_URLS

def format_order_row(row: dict, rating_field: str = "rating") -> dict:
    """
    æ ¼å¼åŒ–è¨‚å–®è³‡æ–™ï¼Œè™•ç†æ™‚é–“ã€çƒå ´ URLã€è©•åˆ†ã€åœ–ç‰‡ç­‰æ¬„ä½

    Args:
        row: è³‡æ–™åº«å›å‚³çš„è¨‚å–®è³‡æ–™
        rating_field: è©•åˆ†æ¬„ä½åç¨±ï¼ˆbuyerOrders ç”¨ "seller_rating"ï¼ŒsellerOrders ç”¨ "rating"ï¼‰
    """
    # start_time: timedelta â†’ "HH:MM"
    row["start_time"] = str(row["start_time"])[:5]

    # game_date: date â†’ weekday + "YYYY-MM-DD"
    if isinstance(row["game_date"], date):
        row["weekday"] = ["ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "æ—¥"][row["game_date"].weekday()]
        row["game_date"] = row["game_date"].strftime("%Y-%m-%d")
    else:
        row["weekday"] = "--"

    # stadium â†’ stadium_url
    row["stadium_url"] = STADIUM_URLS.get(row["stadium"], "#")

    # rating: Decimal â†’ float
    if rating_field in row:
        row[rating_field] = float(row[rating_field]) if row[rating_field] is not None else None

    # image_urls: JSON å­—ä¸² â†’ list
    row["image_urls"] = json.loads(row["image_urls"]) if row["image_urls"] else []

    # note: None â†’ ç©ºå­—ä¸²
    row["note"] = row["note"] if row["note"] else ""

    return row
```

**Step 3ï¼šåœ¨ API ä¸­ä½¿ç”¨**

```python
# routes/orders.py
from utils.format_utils import format_order_row

@router.get("/buyerOrders")
async def get_buyer_orders_api(user: Dict[str, Any] = Depends(get_current_user)):
    try:
        buyer_id = user["user_id"]
        rows = get_buyer_orders(buyer_id)

        for row in rows:
            format_order_row(row, rating_field="seller_rating")

        return rows
    except Exception as e:
        print(f"æŸ¥è©¢è²·å®¶è¨‚å–®å¤±æ•—ï¼š{e}")
        raise HTTPException(status_code=500, detail="æŸ¥è©¢è²·å®¶è¨‚å–®å¤±æ•—")


@router.get("/sellerOrders")
async def get_seller_orders_api(user: Dict[str, Any] = Depends(get_current_user)):
    try:
        seller_id = user["user_id"]
        rows = get_seller_orders(seller_id)

        for row in rows:
            format_order_row(row, rating_field="rating")

        return rows
    except HTTPException:
        raise
    except Exception as e:
        print(f"æŸ¥è©¢è³£å®¶è¨‚å–®å¤±æ•—ï¼š{e}")
        raise HTTPException(status_code=500, detail="æŸ¥è©¢è³£å®¶è¨‚å–®å¤±æ•—")
```

#### é‡æ§‹çš„å¥½è™•

| å¥½è™•       | èªªæ˜                                 |
| ---------- | ------------------------------------ |
| DRY åŸå‰‡   | ä¸é‡è¤‡è‡ªå·±ï¼ˆDon't Repeat Yourselfï¼‰  |
| å–®ä¸€ä¿®æ”¹é» | ä¿®æ”¹æ ¼å¼é‚è¼¯æ™‚ï¼Œåªéœ€æ”¹ä¸€è™•           |
| æ˜“æ–¼æ¸¬è©¦   | å¯ä»¥å–®ç¨æ¸¬è©¦ `format_order_row` å‡½æ•¸ |
| å¯è®€æ€§     | API ç¨‹å¼ç¢¼æ›´ç°¡æ½”ï¼Œæ„åœ–æ›´æ¸…æ¥š         |

---

## 10. Development Notesï¼ˆåŸºç¤æ¦‚å¿µç­†è¨˜ï¼‰

### 10.1 SQL Design & Tips

### SQL å‹•æ…‹æŸ¥è©¢èˆ‡åƒæ•¸åŒ–

### å•é¡Œæƒ…å¢ƒ

ç•¶ä½¿ç”¨è€…åœ¨å‰ç«¯é¸æ“‡å¤šå€‹åº§ä½å€ï¼ˆå¦‚ã€Œå…§é‡ã€å’Œã€Œå¤–é‡ã€ï¼‰æ™‚ï¼Œå¾Œç«¯éœ€è¦çµ„å‡ºé€™æ¨£çš„ SQLï¼š

```sql
SELECT * FROM tickets WHERE seat_area IN ('å…§é‡', 'å¤–é‡')
```

ä½†æˆ‘å€‘ä¸èƒ½ç›´æ¥æŠŠä½¿ç”¨è€…è¼¸å…¥å¡é€² SQLï¼ˆæœƒæœ‰ SQL Injection é¢¨éšªï¼‰ï¼Œæ‰€ä»¥è¦ç”¨**åƒæ•¸åŒ–æŸ¥è©¢**ï¼š

```python
cursor.execute(
    "SELECT * FROM tickets WHERE seat_area IN (%s, %s)",
    ("å…§é‡", "å¤–é‡")
)
```

### å®Œæ•´æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: å‰ç«¯ç™¼é€ Request                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ URL: /api/browse_tickets?seat_areas=å…§é‡,å¤–é‡                    â”‚
â”‚                                      â†‘                          â”‚
â”‚                               é€—è™Ÿåˆ†éš”çš„ã€Œå­—ä¸²ã€                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: å¾Œç«¯æ”¶åˆ°å­—ä¸²                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ seat_areas = "å…§é‡,å¤–é‡"        # å‹åˆ¥: str                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: è½‰æˆ list                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ seat_filters = seat_areas.split(",")                            â”‚
â”‚ seat_filters = ["å…§é‡", "å¤–é‡"]  # å‹åˆ¥: list                    â”‚
â”‚                                                                 â”‚
â”‚ ç‚ºä»€éº¼è¦è½‰ listï¼Ÿ                                                â”‚
â”‚ â†’ éœ€è¦ç”¨ len() è¨ˆç®—æœ‰å¹¾å€‹å€¼ï¼Œæ‰çŸ¥é“è¦ç”¢ç”Ÿå¹¾å€‹ %s                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: ç”¢ç”Ÿ placeholder å­—ä¸²                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ["%s"] * len(seat_filters)      # ["%s", "%s"]                  â”‚
â”‚ ", ".join(["%s", "%s"])         # "%s, %s"                      â”‚
â”‚ placeholders = "%s, %s"          # å‹åˆ¥: str                    â”‚
â”‚                                                                 â”‚
â”‚ ç‚ºä»€éº¼è¦è½‰å­—ä¸²ï¼Ÿ                                                 â”‚
â”‚ â†’ å› ç‚ºè¦å¡é€² f-string çµ„æˆ SQL å­—ä¸²                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: çµ„æˆ SQL å­—ä¸²                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ query = f"SELECT * FROM t WHERE seat_area IN ({placeholders})"  â”‚
â”‚ query = "SELECT * FROM t WHERE seat_area IN (%s, %s)"           â”‚
â”‚                                              â†‘                  â”‚
â”‚                                     é€™æ˜¯ SQL èªæ³•çš„å°æ‹¬è™Ÿ        â”‚
â”‚                                     ä¸æ˜¯ Python tuple           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: åŸ·è¡ŒæŸ¥è©¢                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cursor.execute(query, tuple(seat_filters))                      â”‚
â”‚                       â†‘                                         â”‚
â”‚                       ("å…§é‡", "å¤–é‡")  # å‹åˆ¥: tuple            â”‚
â”‚                                                                 â”‚
â”‚ ç‚ºä»€éº¼æœ€å¾Œè¦è½‰ tupleï¼Ÿ                                           â”‚
â”‚ â†’ cursor.execute() çš„ç¬¬äºŒå€‹åƒæ•¸ç¿’æ…£ç”¨ tuple                      â”‚
â”‚ â†’ å…¶å¯¦ list ä¹Ÿå¯ä»¥ï¼Œä½† tuple æ˜¯æ…£ä¾‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: è³‡æ–™åº«å¯¦éš›åŸ·è¡Œçš„ SQL                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SELECT * FROM t WHERE seat_area IN ('å…§é‡', 'å¤–é‡')              â”‚
â”‚                                                                 â”‚
â”‚ è³‡æ–™åº«é©…å‹•ç¨‹å¼æœƒè‡ªå‹•ï¼š                                           â”‚
â”‚ 1. æŠŠ %s æ›¿æ›æˆåƒæ•¸å€¼                                           â”‚
â”‚ 2. è‡ªå‹•åŠ ä¸Šå¼•è™Ÿ                                                 â”‚
â”‚ 3. è‡ªå‹•è™•ç†è·³è„«å­—å…ƒï¼ˆé˜²æ­¢ SQL Injectionï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‹åˆ¥è½‰æ›ç¸½è¦½

| æ­¥é©Ÿ | è®Šæ•¸                | å‹åˆ¥  | å€¼                 |
| ---- | ------------------- | ----- | ------------------ |
| 1    | URL åƒæ•¸            | str   | `"å…§é‡,å¤–é‡"`      |
| 2    | seat_filters        | list  | `["å…§é‡", "å¤–é‡"]` |
| 3    | placeholders        | str   | `"%s, %s"`         |
| 4    | query               | str   | `"...IN (%s, %s)"` |
| 5    | tuple(seat_filters) | tuple | `("å…§é‡", "å¤–é‡")` |

### ç‚ºä»€éº¼éç¨‹ä¸­è¦ç”¨ list è€Œä¸æ˜¯ç›´æ¥ç”¨ tupleï¼Ÿ

```python
# list å¯ä»¥å‹•æ…‹å¢åŠ å…ƒç´ 
data_params = [game_id]              # å…ˆæ”¾ç¬¬ä¸€å€‹åƒæ•¸
data_params.extend(seat_filters)     # è¿½åŠ åº§ä½æ¢ä»¶
data_params.extend([per_page, offset])  # è¿½åŠ åˆ†é åƒæ•¸

# tuple ä¸èƒ½ä¿®æ”¹ï¼Œæ‰€ä»¥æœ€å¾Œæ‰è½‰
cursor.execute(query, tuple(data_params))
```

### ä¸‰ç¨®æ‹¬è™Ÿçš„å€åˆ¥

| ç¬¦è™Ÿ                  | å‡ºç¾ä½ç½®      | æ„ç¾©             |
| --------------------- | ------------- | ---------------- |
| `["å…§é‡", "å¤–é‡"]`    | Python ç¨‹å¼ç¢¼ | Python list      |
| `("å…§é‡", "å¤–é‡")`    | Python ç¨‹å¼ç¢¼ | Python tuple     |
| `IN ('å…§é‡', 'å¤–é‡')` | SQL èªæ³•      | SQL çš„é›†åˆè¡¨ç¤ºæ³• |

é€™ä¸‰ç¨®æ‹¬è™Ÿåªæ˜¯é•·å¾—åƒï¼Œä½†æ„ç¾©å®Œå…¨ä¸åŒã€‚

---

### SQL Injection é˜²ç¯„

### ä»€éº¼æ˜¯ SQL Injectionï¼Ÿ

æ”»æ“Šè€…åœ¨è¼¸å…¥æ¬„ä½æ’å…¥æƒ¡æ„ SQLï¼Œè©¦åœ–æ“æ§è³‡æ–™åº«ã€‚

### é˜²ç¯„æ–¹å¼ä¸€ï¼šåƒæ•¸åŒ–æŸ¥è©¢

```python
# âŒ å±éšªï¼šç›´æ¥æ‹¼æ¥
query = f"SELECT * FROM users WHERE name = '{user_input}'"

# âœ… å®‰å…¨ï¼šåƒæ•¸åŒ–æŸ¥è©¢
cursor.execute("SELECT * FROM users WHERE name = %s", (user_input,))
```

### é˜²ç¯„æ–¹å¼äºŒï¼šç™½åå–® Mapping

å°æ–¼ç„¡æ³•åƒæ•¸åŒ–çš„éƒ¨åˆ†ï¼ˆå¦‚ ORDER BY æ¬„ä½åï¼‰ï¼Œä½¿ç”¨ mappingï¼š

```python
# âŒ å±éšªï¼šç›´æ¥ä½¿ç”¨å‰ç«¯åƒæ•¸
query = f"ORDER BY {sort_by}"  # æ”»æ“Šè€…å¯å‚³å…¥ "id; DROP TABLE users"

# âœ… å®‰å…¨ï¼šç”¨ mapping å°æ‡‰
sort_column = {
    "created_at": "t.created_at",
    "price": "t.price",
    "rating": "IFNULL(avg_rating, 0)",
}[sort_by]
query = f"ORDER BY {sort_column}"
```

å³ä½¿æ”»æ“Šè€…å‚³å…¥æƒ¡æ„å­—ä¸²ï¼Œä¹Ÿåªæœƒå› ç‚º key ä¸å­˜åœ¨è€Œå ± KeyErrorï¼Œä¸æœƒè¢«åŸ·è¡Œã€‚

---

### IFNULL å‡½æ•¸

### èªæ³•

```sql
IFNULL(A, B)
-- å¦‚æœ A ä¸æ˜¯ NULL â†’ å›å‚³ A
-- å¦‚æœ A æ˜¯ NULL â†’ å›å‚³ B
```

### ç”¨é€”ï¼šæ’åºæ™‚è™•ç† NULL

```sql
ORDER BY IFNULL(avg_rating, 0) DESC
```

| è³£å®¶ | avg_rating | IFNULL çµæœ | æ’åº |
| ---- | ---------- | ----------- | ---- |
| A    | 4.5        | 4.5         | 1    |
| B    | 3.0        | 3.0         | 2    |
| C    | NULL       | 0           | 3    |

æ²’æœ‰è©•åˆ†çš„è³£å®¶æœƒè¢«ç•¶ä½œ 0 åˆ†ä¾†æ’åºã€‚

---

### 10.2 API Design Details

### PUT /api/user/profile çš„å›å‚³å€¼

**ç¾æ³ï¼š**

- æ›´æ–°å®Œæˆå¾Œå‘¼å« `await get_profile(user)` å–å¾—æœ€æ–°è³‡æ–™
- é€™æœƒå†æ¬¡æŸ¥è©¢è³‡æ–™åº«

**è¨è«–ï¼š**

- å„ªé»ï¼šç¢ºä¿å›å‚³çš„æ˜¯è³‡æ–™åº«ä¸­çš„æœ€æ–°ç‹€æ…‹
- ç¼ºé»ï¼šå¤šä¸€æ¬¡è³‡æ–™åº«æŸ¥è©¢

**çµè«–ï¼š**

- ç›®å‰åšæ³•å¯æ¥å—ï¼Œè³‡æ–™ä¸€è‡´æ€§å„ªå…ˆ

---

### è·¯ç”±å‰ç¶´é‡è¤‡

**ç¾æ³ï¼š**

- `auth.py` ä½¿ç”¨ `prefix="/api/user"`
- `users.py` ä¹Ÿä½¿ç”¨ `prefix="/api/user"`

**èªªæ˜ï¼š**

- é€™æ˜¯æ­£ç¢ºçš„è¨­è¨ˆï¼ŒFastAPI å…è¨±å¤šå€‹ router ä½¿ç”¨ç›¸åŒå‰ç¶´
- åœ¨ `main.py` ä¸­åˆ†åˆ¥ `include_router` å³å¯

---

### POST /api/ratings è©•åˆ†æ©Ÿåˆ¶

**æ¥­å‹™é‚è¼¯ï¼š**

- è²·å®¶åœ¨è¨‚å–®ã€Œå·²å‡ºè²¨ã€å¾Œï¼Œå¯å°è³£å®¶é€²è¡Œ 1-5 æ˜Ÿè©•åˆ†
- æ¯ç­†è¨‚å–®åªèƒ½è©•åˆ†ä¸€æ¬¡

**é©—è­‰è¦å‰‡ï¼ˆç”± Model å±¤ `create_rating` è™•ç†ï¼‰ï¼š**

| è¦å‰‡                         | é©—è­‰ä½ç½®                     | éŒ¯èª¤ä»£ç¢¼ |
| ---------------------------- | ---------------------------- | -------- |
| è©•åˆ†éœ€ä»‹æ–¼ 1-5               | Pydantic `Field(ge=1, le=5)` | 422      |
| éœ€ç™»å…¥æ‰èƒ½è©•åˆ†               | `Depends(get_current_user)`  | 401      |
| è¨‚å–®å¿…é ˆå­˜åœ¨ä¸”ç‚ºè©²è²·å®¶çš„è¨‚å–® | Model å±¤                     | 404      |
| è¨‚å–®å¿…é ˆç‚ºã€Œå·²å‡ºè²¨ã€ç‹€æ…‹     | Model å±¤                     | 400      |
| ä¸èƒ½å°è‡ªå·±è©•åˆ†               | Model å±¤                     | 400      |
| è¢«è©•åˆ†è€…å¿…é ˆæ˜¯è©²è¨‚å–®çš„è³£å®¶   | Model å±¤                     | 400      |
| åŒä¸€è¨‚å–®ä¸å¯é‡è¤‡è©•åˆ†         | Model å±¤                     | 400      |

**å¹³å‡è©•åˆ†è¨ˆç®—ï¼š**

- `avg_rating` åœ¨ `get_user_profile` ä¸­é€é `LEFT JOIN ratings` + `AVG(r.score)` å‹•æ…‹è¨ˆç®—
- ä¸é¡å¤–å„²å­˜æ¬„ä½ï¼Œæ¯æ¬¡æŸ¥è©¢æ™‚å³æ™‚è¨ˆç®—

---

### 10.3 Model Layer Design

### get_member_email ç‚ºä»€éº¼è¦å‚³å…¥ cursorï¼Ÿ

**è¨­è¨ˆåŸå› ï¼š**

- ç”¨æ–¼éœ€è¦ transaction ä¸€è‡´æ€§çš„å ´æ™¯
- ä¾‹å¦‚ï¼šã€Œæ›´æ–°è¨‚å–®ç‹€æ…‹ â†’ æŸ¥è©¢ email â†’ å¯„é€é€šçŸ¥ä¿¡ã€å¿…é ˆåœ¨åŒä¸€å€‹ transaction ä¸­åŸ·è¡Œ
- è‹¥ä¸­é€”å¤±æ•—ï¼Œæ•´å€‹æ“ä½œå¯ä»¥ rollback

**å‘¼å«æ–¹å¼ï¼š**

```python
notification_data = None

with get_connection() as conn:
    with conn.cursor(dictionary=True) as cursor:
        # 1. æ›´æ–°è¨‚å–®ç‹€æ…‹
        cursor.execute("UPDATE orders SET status = %s WHERE id = %s", ...)

        # 2. æŸ¥è©¢ emailï¼ˆæ²¿ç”¨åŒä¸€å€‹ cursorï¼‰
        buyer_email = get_member_email(cursor, buyer_id)

        # 3. æš«å­˜é€šçŸ¥è³‡æ–™
        notification_data = {"to": buyer_email, "subject": "...", "body": "..."}

    # 4. å…¨éƒ¨æˆåŠŸæ‰ commitï¼ˆåœ¨ cursor å€å¡Šå¤–ï¼‰
    conn.commit()

# 5. commit å¾Œå†å¯„ä¿¡ï¼ˆåœ¨ connection å€å¡Šå¤–ï¼Œç¢ºä¿é€£ç·šå·²é‡‹æ”¾ï¼‰
if notification_data:
    send_email_async(...)
```

**å°æ¯”å…¶ä»–å‡½æ•¸ï¼š**

- `get_user_profile` è‡ªå·±é–‹é€£ç·šï¼Œå› ç‚ºæ˜¯ç¨ç«‹æ“ä½œï¼Œä¸éœ€è¦èˆ‡å…¶ä»–æ“ä½œå…±ç”¨ transaction

---

---

### é ç´„åˆªé™¤çš„åŸå­æ€§è¨­è¨ˆ

### ç›®å‰å¯¦ä½œï¼šSELECT FOR UPDATE + DELETE

**ç¨‹å¼ç¢¼ä½ç½®**ï¼š`reservation_model.py` çš„ `delete_reservation_with_lock()`

**æµç¨‹**ï¼š

1. `SELECT ... FOR UPDATE`ï¼šæª¢æŸ¥é ç´„æ˜¯å¦å­˜åœ¨ä¸”å±¬æ–¼è©²æœƒå“¡ï¼ŒåŒæ™‚åŠ æ’ä»–é–
2. è‹¥å­˜åœ¨ â†’ åŸ·è¡Œ `DELETE`
3. `COMMIT` é‡‹æ”¾é–

**å„ªé»**ï¼š

- æ˜ç¢ºçš„é–å®šæ©Ÿåˆ¶ï¼Œèªæ„æ¸…æ¥š
- å¢é€²å° transaction çš„ç†è§£

**ç¼ºé»**ï¼š

- ç¨‹å¼ç¢¼è¼ƒé•·
- éœ€è¦æ‰‹å‹•ç®¡ç† transaction

---

### æ›¿ä»£æ–¹æ¡ˆï¼šå–®ä¸€ SQL åŸå­æ“ä½œ

```python
def delete_reservation_atomic(reservation_id: int, member_id: int) -> bool:
    """
    ç”¨å–®ä¸€ DELETE èªå¥åˆªé™¤é ç´„

    å›å‚³ï¼š
    - Trueï¼šrowcount == 1ï¼Œæœ‰åˆªåˆ°ä¸€ç­†
    - Falseï¼šrowcount == 0ï¼Œæ²’åˆªåˆ°ï¼ˆä¸å­˜åœ¨æˆ–ä¸å±¬æ–¼è©²æœƒå“¡ï¼‰
    """
    with get_connection() as conn:
        with conn.cursor() as cursor:
            cursor.execute(
                "DELETE FROM reservations WHERE id = %s AND member_id = %s",
                (reservation_id, member_id)
            )
            conn.commit()
            # rowcountï¼šé€™æ¬¡ SQL å½±éŸ¿çš„è³‡æ–™ç­†æ•¸
            # == 1 â†’ æœ‰åˆªåˆ°
            # == 0 â†’ æ²’åˆªåˆ°ï¼ˆè³‡æ–™ä¸å­˜åœ¨æˆ–æ¢ä»¶ä¸ç¬¦ï¼‰
            return cursor.rowcount == 1
```

**å„ªé»**ï¼š

- ç¨‹å¼ç¢¼ç°¡æ½”
- æª¢æŸ¥ + åˆªé™¤åœ¨åŒä¸€å€‹ SQLï¼Œå¤©ç„¶åŸå­åŒ–
- å¯¦å‹™ä¸Šå¸¸ç”¨

**ç¼ºé»**ï¼š

- ç„¡æ³•å€åˆ†ã€Œä¸å­˜åœ¨ã€å’Œã€Œä¸å±¬æ–¼è©²æœƒå“¡ã€å…©ç¨®æƒ…æ³

**çµè«–**ï¼š

- å…©ç¨®æ–¹å¼éƒ½å¯ä»¥ï¼Œç›®å‰æ¡ç”¨ `SELECT FOR UPDATE` æ–¹æ¡ˆ
- è‹¥éœ€è¦æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯ï¼Œç¶­æŒç¾æœ‰æ–¹æ¡ˆ
- è‹¥è¿½æ±‚ç°¡æ½”ï¼Œå¯è€ƒæ…®æ”¹ç”¨å–®ä¸€ SQL æ–¹æ¡ˆ

---

### cursor.rowcount çš„ç”¨æ³•

`cursor.rowcount` å›å‚³é€™æ¬¡ SQL æ“ä½œå½±éŸ¿çš„è³‡æ–™ç­†æ•¸ã€‚

| SQL é¡å‹ | rowcount æ„ç¾©                       |
| -------- | ----------------------------------- |
| INSERT   | æ’å…¥çš„ç­†æ•¸ï¼ˆé€šå¸¸æ˜¯ 1ï¼‰              |
| UPDATE   | è¢«æ›´æ–°çš„ç­†æ•¸                        |
| DELETE   | è¢«åˆªé™¤çš„ç­†æ•¸                        |
| SELECT   | -1 æˆ–æŸ¥è©¢çµæœç­†æ•¸ï¼ˆä¾é©…å‹•ç¨‹å¼è€Œå®šï¼‰ |

**å¸¸è¦‹æ‡‰ç”¨æ¨¡å¼**ï¼š

```python
# åˆªé™¤æ“ä½œ
cursor.execute("DELETE FROM table WHERE id = %s AND owner_id = %s", (id, owner_id))
if cursor.rowcount == 0:
    # æ²’åˆªåˆ° â†’ è³‡æ–™ä¸å­˜åœ¨ or ä¸å±¬æ–¼è©²ä½¿ç”¨è€…
    return False
else:
    # rowcount >= 1 â†’ æœ‰åˆªåˆ°
    return True

# æ›´æ–°æ“ä½œ
cursor.execute("UPDATE table SET status = %s WHERE id = %s", (status, id))
if cursor.rowcount == 0:
    # æ²’æ›´æ–°åˆ° â†’ è³‡æ–™å¯èƒ½ä¸å­˜åœ¨
    raise HTTPException(404, "è³‡æ–™ä¸å­˜åœ¨")
```

**ç‚ºä»€éº¼ç”¨ rowcount è€Œä¸æ˜¯å…ˆ SELECT å†åˆ¤æ–·ï¼Ÿ**

1. æ¸›å°‘ä¸€æ¬¡è³‡æ–™åº«æŸ¥è©¢
2. å¤©ç„¶åŸå­åŒ–ï¼Œä¸æœƒæœ‰ race condition
3. ç¨‹å¼ç¢¼æ›´ç°¡æ½”

---

### åŸå­å¯«æ³• vs SELECT FOR UPDATE çš„é¢¨éšªæ¯”è¼ƒ

| å¯«æ³•                       | Race Condition | æ­»é–é¢¨éšª   | ç¨‹å¼ç¢¼è¤‡é›œåº¦ |
| -------------------------- | -------------- | ---------- | ------------ |
| å–®ä¸€ SQL åŸå­æ“ä½œ          | âœ“ å®‰å…¨         | âœ“ å¹¾ä¹æ²’æœ‰ | ç°¡å–®         |
| SELECT FOR UPDATE + DELETE | âœ“ å®‰å…¨         | âš ï¸ è¼ƒé«˜    | è¼ƒè¤‡é›œ       |

**æ­»é–ç™¼ç”Ÿæƒ…å¢ƒ**ï¼š

ç•¶ä¸€å€‹ transaction æŒæœ‰é– A ä¸¦å˜—è©¦å–å¾—é– Bï¼ŒåŒæ™‚å¦ä¸€å€‹ transaction æŒæœ‰é– B ä¸¦å˜—è©¦å–å¾—é– Aï¼Œå°±æœƒç”¢ç”Ÿæ­»é–ã€‚

**å–®ä¸€ SQL ç‚ºä»€éº¼æ²’æœ‰æ­»é–é¢¨éšªï¼Ÿ**

åªåŸ·è¡Œä¸€å€‹æ“ä½œï¼Œä¸æœƒã€ŒæŒæœ‰é–çš„åŒæ™‚åˆå»ç­‰å¾…å¦ä¸€å€‹é–ã€ã€‚

**ç›®å‰å°ˆæ¡ˆçš„é¸æ“‡**ï¼š

æ¡ç”¨ `SELECT FOR UPDATE` æ–¹æ¡ˆï¼Œå› ç‚ºï¼š

1. å¯ä»¥å€åˆ†ã€Œä¸å­˜åœ¨ã€å’Œã€Œç„¡æ¬Šé™ã€å…©ç¨®éŒ¯èª¤
2. æ­¤å ´æ™¯åªé–å–®ä¸€ rowï¼Œæ­»é–é¢¨éšªæ¥µä½

---

### 10.4 Python Fundamentals

### Python Dict å–å€¼æ–¹å¼

### `dict["key"]` vs `dict.get("key")`

| å¯«æ³•              | key ä¸å­˜åœ¨æ™‚                | é©ç”¨æƒ…å¢ƒ          |
| ----------------- | --------------------------- | ----------------- |
| `dict["key"]`     | æ‹‹å‡º `KeyError`ï¼Œç¨‹å¼å´©æ½°   | ç¢ºå®š key ä¸€å®šå­˜åœ¨ |
| `dict.get("key")` | å›å‚³ `None`ï¼ˆæˆ–æŒ‡å®šé è¨­å€¼ï¼‰ | key å¯èƒ½ä¸å­˜åœ¨    |

**å°ˆæ¡ˆä¸­çš„é¸æ“‡**ï¼š

```python
# ä½¿ç”¨ dict["key"]
member_id = user["user_id"]
```

å› ç‚º `user` ä¾†è‡ª `get_current_user`ï¼Œè‹¥é©—è­‰é€šéï¼Œ`user_id` ä¸€å®šå­˜åœ¨ã€‚
è‹¥ key ä¸å­˜åœ¨ä»£è¡¨ç¨‹å¼é‚è¼¯æœ‰èª¤ï¼Œæ‡‰è©²è®“ç¨‹å¼å´©æ½°ä»¥ä¾¿ç™¼ç¾å•é¡Œã€‚

---

### æŸ¥è©¢åƒæ•¸ vs è·¯å¾‘åƒæ•¸

### å·®ç•°æ¯”è¼ƒ

| é …ç›®     | è·¯å¾‘åƒæ•¸ (Path Parameter) | æŸ¥è©¢åƒæ•¸ (Query Parameter)      |
| -------- | ------------------------- | ------------------------------- |
| URL æ ¼å¼ | `/api/events/2025/7`      | `/api/events?year=2025&month=7` |
| ç”¨é€”     | è­˜åˆ¥**ç‰¹å®šè³‡æº**          | ç¯©é¸/éæ¿¾/åˆ†é                   |
| å¿…å¡«æ€§   | é€šå¸¸å¿…å¡«                  | å¯é¸ï¼ˆæœ‰é è¨­å€¼ï¼‰                |
| èªæ„     | ã€Œå–å¾—é€™å€‹è³‡æºã€          | ã€Œç”¨é€™äº›æ¢ä»¶æŸ¥è©¢ã€              |

### æœ¬å°ˆæ¡ˆçš„é¸æ“‡

`/api/events` å’Œ `/api/schedule` ä½¿ç”¨**æŸ¥è©¢åƒæ•¸**ï¼š

```python
@router.get("/events")
async def get_events_api(year: int, month: int):  # æŸ¥è©¢åƒæ•¸
```

**åŸå› **ï¼š

1. **èªæ„æ­£ç¢º**ï¼šæŸ¥è©¢ã€Œ2025 å¹´ 7 æœˆçš„æ¯”è³½ã€æ˜¯ä¸€ç¨®ç¯©é¸è¡Œç‚ºï¼Œä¸æ˜¯å–å¾—ç‰¹å®šè³‡æº
2. **å½ˆæ€§æ›´é«˜**ï¼šæœªä¾†å¯è¼•é¬†æ–°å¢å…¶ä»–ç¯©é¸æ¢ä»¶ï¼ˆå¦‚ `team`ã€`stadium`ï¼‰
3. **å‰ç«¯ç¿’æ…£**ï¼šå‰ç«¯çµ„ URL æ™‚ï¼ŒæŸ¥è©¢åƒæ•¸æ›´ç›´è§€

```javascript
fetch(`/api/events?year=${y}&month=${m}`);
```

### ä½•æ™‚ç”¨è·¯å¾‘åƒæ•¸ï¼Ÿ

ç•¶ä½ è¦å–å¾—ã€Œç‰¹å®šä¸€ç­†è³‡æ–™ã€æ™‚ï¼š

```python
@router.get("/games/{game_id}")  # å–å¾—ç‰¹å®šæ¯”è³½
async def get_game(game_id: int):
```

---

### Python Logging æ©Ÿåˆ¶

### è¨­å®šæ–¹å¼

**Step 1ï¼šåœ¨ config/settings.py å®šç¾© LOG_LEVEL**

```python
# config/settings.py
ENV = os.getenv("ENV", "development")
DEBUG = ENV == "development"

# é–‹ç™¼ç’°å¢ƒé è¨­ DEBUGï¼Œæ­£å¼ç’°å¢ƒé è¨­ WARNING
LOG_LEVEL = os.getenv("LOG_LEVEL", "DEBUG" if DEBUG else "WARNING")
```

**Step 2ï¼šåœ¨ app.py è¨­å®šå…¨åŸŸ root logger**

```python
# app.py
import logging
from config.settings import LOG_LEVEL

logging.basicConfig(
    level=getattr(logging, LOG_LEVEL),
    format="%(asctime)s [%(levelname)s] %(name)s - %(message)s"
)
```

`getattr(logging, "INFO")` çš„ä½œç”¨æ˜¯æŠŠå­—ä¸² `"INFO"` è½‰æˆ `logging.INFO`ï¼ˆæ•¸å­— 20ï¼‰ï¼Œå› ç‚º `logging.basicConfig()` çš„ level åƒæ•¸éœ€è¦æ•¸å­—ã€‚

**Step 3ï¼šåœ¨å„æ¨¡çµ„å–å¾—å°ˆå±¬ logger**

```python
# routes/games.py
import logging
logger = logging.getLogger(__name__)
```

`__name__` æœƒæ˜¯æ¨¡çµ„çš„å®Œæ•´è·¯å¾‘ï¼Œä¾‹å¦‚ `routes.games`ï¼Œæ–¹ä¾¿å¾ log è¨Šæ¯ä¸­è¾¨è­˜ä¾†æºã€‚

---

### Log å±¤ç´š

| å±¤ç´š     | æ•¸å€¼ | ç”¨é€”                   | ç¯„ä¾‹                      |
| -------- | ---- | ---------------------- | ------------------------- |
| DEBUG    | 10   | é–‹ç™¼é™¤éŒ¯ç”¨             | è®Šæ•¸å€¼ã€æµç¨‹è¿½è¹¤          |
| INFO     | 20   | æ­£å¸¸é‹ä½œè³‡è¨Š           | è«‹æ±‚é–‹å§‹ã€å¿«å–å‘½ä¸­        |
| WARNING  | 30   | è­¦å‘Šä½†ä¸å½±éŸ¿åŠŸèƒ½       | Redis é€£ç·šå¤±æ•—ï¼Œé™ç´šæŸ¥ DB |
| ERROR    | 40   | éŒ¯èª¤ï¼ŒåŠŸèƒ½å—å½±éŸ¿       | è³‡æ–™åº«æŸ¥è©¢å¤±æ•—            |
| CRITICAL | 50   | åš´é‡éŒ¯èª¤ï¼Œç³»çµ±å¯èƒ½å´©æ½° | ç„¡æ³•å•Ÿå‹•æœå‹™              |

---

### å±¤ç´šéæ¿¾æ©Ÿåˆ¶

```
DEBUG(10) < INFO(20) < WARNING(30) < ERROR(40) < CRITICAL(50)
```

è¨­å®šçš„ level æ±ºå®šã€Œæœ€ä½é¡¯ç¤ºå±¤ç´šã€ï¼Œä½æ–¼æ­¤å±¤ç´šçš„è¨Šæ¯æœƒè¢«éæ¿¾ï¼š

```python
# è¨­å®š level=INFO (20)
logger.debug("ä¸æœƒé¡¯ç¤º")    # 10 < 20ï¼Œè¢«éæ¿¾
logger.info("æœƒé¡¯ç¤º")       # 20 >= 20ï¼Œé¡¯ç¤º
logger.warning("æœƒé¡¯ç¤º")    # 30 > 20ï¼Œé¡¯ç¤º
```

---

### æœ¬å°ˆæ¡ˆçš„ç’°å¢ƒè®Šæ•¸è¨­å®š

**config/settings.py**

```python
LOG_LEVEL = os.getenv("LOG_LEVEL", "DEBUG" if DEBUG else "WARNING")
```

**.envï¼ˆæœ¬æ©Ÿé–‹ç™¼ï¼‰**

```ini
ENV=development
LOG_LEVEL=DEBUG
```

**.envï¼ˆEC2 ç”Ÿç”¢ç’°å¢ƒï¼‰**

```ini
ENV=production
LOG_LEVEL=WARNING
```

**.env-exampleï¼ˆçµ¦å…¶ä»–é–‹ç™¼è€…åƒè€ƒï¼‰**

```ini
# Log è¨­å®š
# å¯é¸å€¼: DEBUG, INFO, WARNING, ERROR
# æœ¬æ©Ÿé–‹ç™¼: DEBUG
# EC2 ç”Ÿç”¢ç’°å¢ƒ: WARNING
LOG_LEVEL=DEBUG
```

| ç’°å¢ƒ | LOG_LEVEL | èªªæ˜                          |
| ---- | --------- | ----------------------------- |
| é–‹ç™¼ | DEBUG     | é¡¯ç¤ºæ‰€æœ‰è¨Šæ¯ï¼Œæ–¹ä¾¿é™¤éŒ¯        |
| æ­£å¼ | WARNING   | åªé¡¯ç¤ºè­¦å‘Šå’ŒéŒ¯èª¤ï¼Œæ¸›å°‘ log é‡ |

---

### Log è¼¸å‡ºä½ç½®ï¼ˆstdoutï¼‰

**stdoutï¼ˆStandard Outputï¼‰** æ˜¯ç¨‹å¼è¼¸å‡ºè¨Šæ¯çš„é è¨­å‡ºå£ï¼Œé¡¯ç¤ºåœ¨çµ‚ç«¯æ©Ÿç•«é¢ä¸Šã€‚

```python
print("Hello")           # è¼¸å‡ºåˆ° stdout
logger.info("Hello")     # é è¨­è¼¸å‡ºåˆ° stderrï¼ˆä¹Ÿé¡¯ç¤ºåœ¨çµ‚ç«¯æ©Ÿï¼‰
```

`logging.basicConfig()` ä¸æŒ‡å®š `filename` æ™‚ï¼Œé è¨­è¼¸å‡ºåˆ°çµ‚ç«¯æ©Ÿï¼š

```
2026-02-12 14:30:15 [INFO] routes.games - request start key=top_games:2026-02
2026-02-12 14:30:15 [INFO] routes.games - cache MISS key=top_games:2026-02
2026-02-12 14:30:16 [INFO] routes.games - DB query done rows=5
```

å¦‚éœ€è¼¸å‡ºåˆ°æª”æ¡ˆï¼Œå¯åŠ ä¸Š `filename` åƒæ•¸ï¼š

```python
logging.basicConfig(
    level=getattr(logging, LOG_LEVEL),
    format="%(asctime)s [%(levelname)s] %(name)s - %(message)s",
    filename="app.log"
)
```

æ³¨æ„ï¼šè‹¥ä½¿ç”¨æª”æ¡ˆè¼¸å‡ºï¼Œéœ€åœ¨ `.gitignore` ä¸­åŠ å…¥ `*.log`ã€‚

---

### æœ¬å°ˆæ¡ˆçš„ Log è¨­è¨ˆç¯„ä¾‹

```python
# è«‹æ±‚é–‹å§‹ï¼šè¨˜éŒ„ cache_keyï¼Œæ–¹ä¾¿è¿½è¹¤
logger.info(f"request start key={cache_key}")

# å¿«å–å‘½ä¸­ï¼šè¨˜éŒ„ bytes å¤§å°ï¼Œå¿«é€Ÿåˆ¤æ–·è³‡æ–™æ˜¯å¦ç•°å¸¸
logger.info(f"cache HIT key={cache_key} bytes={len(cached_data)}")

# å¿«å–æœªå‘½ä¸­ï¼šå€åˆ†ã€Œæ²’ keyã€å’Œã€ŒRedis å‡ºéŒ¯ã€
logger.info(f"cache MISS key={cache_key}")

# Redis éŒ¯èª¤ï¼šé™ç´šè™•ç†ï¼Œä¸ä¸­æ–·æœå‹™
logger.warning(f"Redis é€£ç·šéŒ¯èª¤ï¼Œé™ç´šæŸ¥è©¢è³‡æ–™åº«: err={e}")

# è³‡æ–™åº«éŒ¯èª¤ï¼šä¸­æ–·æœå‹™ï¼Œå›å‚³ 500
logger.error(f"æŸ¥è©¢è³‡æ–™åº«å¤±æ•—: {e}")

# é–‹ç™¼èª¿è©¦ç”¨ï¼šæ­£å¼ç’°å¢ƒ level=WARNING æ™‚ä¸æœƒé¡¯ç¤º
logger.debug(f"Recommended games: {[g['game_id'] for g in top_games[:5]]}")
```

**Log è¨­è¨ˆåŸå‰‡**ï¼š

| åŸå‰‡                | èªªæ˜                                         |
| ------------------- | -------------------------------------------- |
| è¨˜éŒ„ key/id         | æ–¹ä¾¿å®šä½æ˜¯å“ªç­†è³‡æ–™å‡ºå•é¡Œ                     |
| è¨˜éŒ„ bytes/rows     | å¿«é€Ÿåˆ¤æ–·è³‡æ–™é‡æ˜¯å¦ç•°å¸¸ï¼ˆç©ºã€å¤ªå¤§ï¼‰           |
| å€åˆ† hit/miss/error | å¾ log ä¸€çœ¼çœ‹å‡ºæ˜¯ã€Œæ²’è³‡æ–™ã€é‚„æ˜¯ã€Œç³»çµ±å‡ºéŒ¯ã€  |
| WARNING ä¸ä¸­æ–·      | è¼”åŠ©åŠŸèƒ½ï¼ˆå¿«å–ï¼‰å‡ºéŒ¯æ™‚é™ç´šï¼Œæ ¸å¿ƒåŠŸèƒ½ç¹¼çºŒé‹ä½œ |
| ERROR æ‰ä¸­æ–·        | æ ¸å¿ƒåŠŸèƒ½ï¼ˆè³‡æ–™åº«ï¼‰å‡ºéŒ¯æ™‚æ‰å›å‚³éŒ¯èª¤           |

---

### 10.5 MySQL Fundamentals

### MySQL cursor å›å‚³æ ¼å¼

### åŸºæœ¬è¦å‰‡

| æ–¹æ³•                | å›å‚³æ ¼å¼                      | ç„¡è³‡æ–™æ™‚        |
| ------------------- | ----------------------------- | --------------- |
| `cursor.fetchone()` | å–®ç­† dict æˆ– tuple            | `None`          |
| `cursor.fetchall()` | list of dict æˆ– list of tuple | `[]`ï¼ˆç©º listï¼‰ |

### dictionary=True çš„å·®ç•°

```python
# dictionary=Falseï¼ˆé è¨­ï¼‰
cursor.fetchone()   # (15,)
cursor.fetchall()   # [(15,), (20,)]

# dictionary=True
cursor.fetchone()   # {"total_trades": 15}
cursor.fetchall()   # [{"id": 1, "name": "A"}, {"id": 2, "name": "B"}]
```

### é‡è¦è§€å¿µ

```python
# fetchall() ç„¡è³‡æ–™æ™‚å›å‚³ç©º listï¼Œä¸æ˜¯ None
results = cursor.fetchall()  # []
for row in results:  # è¿´åœˆåŸ·è¡Œ 0 æ¬¡ï¼Œä¸æœƒå ±éŒ¯
    ...

# fetchone() ç„¡è³‡æ–™æ™‚å›å‚³ None
result = cursor.fetchone()  # None
result["key"]  # âŒ TypeError: 'NoneType' object is not subscriptable
```

### COUNT(\*) vs SUM() çš„å·®ç•°

```sql
-- ç„¡è³‡æ–™æ™‚
SELECT COUNT(*) FROM orders WHERE 1=0  -- å›å‚³ 0ï¼ˆæ•¸å­—ï¼‰
SELECT SUM(amount) FROM orders WHERE 1=0  -- å›å‚³ NULL
```

```python
# COUNT(*) ä¸éœ€è¦é¡å¤–æª¢æŸ¥
return result["total_trades"]

# SUM() éœ€è¦è™•ç† NULL
return result["total_amount"] or 0
```

---

### Python date ç‰©ä»¶èˆ‡ JSON åºåˆ—åŒ–

### å•é¡ŒèƒŒæ™¯

MySQL çš„ `DATE` æ¬„ä½åœ¨ Python ä¸­æœƒè¢«è½‰æ›æˆ `date` ç‰©ä»¶ï¼š

```python
row["game_date"] = date(2026, 2, 24)  # ä¸æ˜¯å­—ä¸²ï¼Œæ˜¯ date ç‰©ä»¶
```

### ç‚ºä»€éº¼éœ€è¦æ‰‹å‹•è½‰æ›ï¼Ÿ

JSON åªæ”¯æ´åŸºæœ¬å‹åˆ¥ï¼ˆå­—ä¸²ã€æ•¸å­—ã€å¸ƒæ—ã€nullã€é™£åˆ—ã€ç‰©ä»¶ï¼‰ï¼Œä¸æ”¯æ´ Python çš„ `date` ç‰©ä»¶ã€‚

```python
# âŒ date ç‰©ä»¶ç„¡æ³•ç›´æ¥åºåˆ—åŒ–æˆ JSON
json.dumps({"game_date": date(2026, 2, 24)})
# TypeError: Object of type date is not JSON serializable

# âœ… å­—ä¸²å¯ä»¥
json.dumps({"game_date": "2026-02-24"})
```

### è½‰æ›æ–¹å¼

```python
if isinstance(row["game_date"], date):
    row["game_date"] = row["game_date"].strftime("%Y-%m-%d")
    # date(2026, 2, 24) â†’ "2026-02-24"
```

### timedelta ä¹Ÿéœ€è¦è½‰æ›

MySQL çš„ `TIME` æ¬„ä½æœƒè¢«è½‰æ›æˆ `timedelta`ï¼š

```python
row["start_time"] = timedelta(seconds=66900)  # 18:35:00

# è½‰æ›æ–¹å¼
total_seconds = int(row["start_time"].total_seconds())  # 66900
hours = total_seconds // 3600                            # 18
minutes = (total_seconds % 3600) // 60                   # 35
row["start_time"] = f"{hours:02}:{minutes:02}"           # "18:35"
```

---

### MySQL æ¬„ä½è¨­è¨ˆèˆ‡ NULL è™•ç†

### INSERT æ™‚æ²’æŒ‡å®šæ¬„ä½æœƒç™¼ç”Ÿä»€éº¼ï¼Ÿ

ç•¶ INSERT èªå¥æ²’æœ‰æŒ‡å®šæŸå€‹æ¬„ä½æ™‚ï¼ŒMySQL æŒ‰ä»¥ä¸‹å„ªå…ˆé †åºæ±ºå®šè©²æ¬„ä½çš„å€¼ï¼š

| å„ªå…ˆé †åº | æ¢ä»¶                         | çµæœ            |
| -------- | ---------------------------- | --------------- |
| 1        | æœ‰è¨­å®š `DEFAULT` å€¼          | ä½¿ç”¨ DEFAULT å€¼ |
| 2        | æ¬„ä½å…è¨± `NULL`              | å¡«å…¥ `NULL`     |
| 3        | æ¬„ä½ `NOT NULL` ä¸”ç„¡ DEFAULT | **å ±éŒ¯**        |

**ç¯„ä¾‹**ï¼š

```sql
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    payment_status VARCHAR(20) DEFAULT 'æœªä»˜æ¬¾',  -- æœ‰ DEFAULT
    paid_at DATETIME NULL,                         -- å…è¨± NULLï¼Œç„¡ DEFAULT
    buyer_id INT NOT NULL                          -- NOT NULL ä¸”ç„¡ DEFAULT
);
```

```sql
INSERT INTO orders (buyer_id) VALUES (123);
```

| æ¬„ä½             | çµæœ                       |
| ---------------- | -------------------------- |
| `payment_status` | `'æœªä»˜æ¬¾'`ï¼ˆä½¿ç”¨ DEFAULTï¼‰ |
| `paid_at`        | `NULL`ï¼ˆå…è¨± NULLï¼‰        |
| `buyer_id`       | `123`ï¼ˆæœ‰æŒ‡å®šï¼‰            |

å¦‚æœ `buyer_id` æ²’æŒ‡å®šï¼š

```sql
INSERT INTO orders (payment_status) VALUES ('å·²ä»˜æ¬¾');
-- Error: Field 'buyer_id' doesn't have a default value
```

---

### æ²’æœ‰æŒ‡å®š NULL æˆ– NOT NULL çš„é è¨­è¡Œç‚º

**MySQL é è¨­å…è¨± NULL**ï¼š

```sql
-- é€™å…©è¡Œæ•ˆæœç›¸åŒ
note TEXT
note TEXT NULL
```

é©—è­‰æ–¹å¼ï¼š

```sql
DESCRIBE orders;
```

| Field | Type | Null | Key | Default |
| ----- | ---- | ---- | --- | ------- |
| note  | text | YES  |     | NULL    |

`Null` æ¬„ä½é¡¯ç¤º `YES`ï¼Œè¡¨ç¤ºå…è¨± NULLã€‚

---

### NULL å›å‚³å‰ç«¯ç‚ºä»€éº¼ä¸æœƒå ±éŒ¯ï¼Ÿ

**JSON åŸç”Ÿæ”¯æ´ null**ï¼š

```python
# Python å¾Œç«¯
data = {"paid_at": None}

# FastAPI å›å‚³çš„ JSON
{"paid_at": null}
```

`null` æ˜¯ JSON çš„åˆæ³•å€¼ï¼ˆèˆ‡ stringã€numberã€booleanã€arrayã€object ä¸¦åˆ—ï¼‰ï¼Œå‰ç«¯ JavaScript å¯ä»¥æ­£å¸¸æ¥æ”¶ã€‚

**å‰ç«¯è™•ç† null çš„æƒ…æ³**ï¼š

```javascript
const data = await res.json();
console.log(data.paid_at); // nullï¼Œä¸æœƒå ±éŒ¯

// æ­£ç¢ºè™•ç†ï¼šå…ˆæª¢æŸ¥å†ä½¿ç”¨
const paidTime = data.paid_at ? formatDateTime(data.paid_at) : "--";
```

**æœƒå ±éŒ¯çš„æƒ…æ³**ï¼š

```javascript
// âŒ å° null å‘¼å«æ–¹æ³•
data.paid_at.toUpperCase();
// TypeError: Cannot read property 'toUpperCase' of null

// âŒ å° null å–å±¬æ€§
data.paid_at.length;
// TypeError: Cannot read property 'length' of null

// âœ“ å…ˆæª¢æŸ¥å†ä½¿ç”¨
data.paid_at ? data.paid_at.toUpperCase() : "--";
```

**ç¸½çµ**ï¼š

| æƒ…æ³                           | çµæœ                  |
| ------------------------------ | --------------------- |
| å¾Œç«¯å›å‚³ `null`                | æ­£å¸¸ï¼ŒJSON æ”¯æ´       |
| å‰ç«¯æ¥æ”¶ `null`                | æ­£å¸¸ï¼ŒJavaScript æ”¯æ´ |
| å‰ç«¯å° `null` å‘¼å«æ–¹æ³•æˆ–å–å±¬æ€§ | **å ±éŒ¯**              |
| å‰ç«¯å…ˆæª¢æŸ¥ `null` å†æ“ä½œ       | æ­£å¸¸                  |

---

### è³‡æ–™åº«æ¬„ä½è¨­è¨ˆåŸå‰‡

#### åŸå‰‡ 1ï¼šæ±ºå®šæ¬„ä½æ˜¯å¦å…è¨± NULL

| æƒ…å¢ƒ         | è¨­è¨ˆ        | ç¯„ä¾‹                    |
| ------------ | ----------- | ----------------------- |
| å¿…å¡«æ¬„ä½     | `NOT NULL`  | `buyer_id INT NOT NULL` |
| é¸å¡«æ¬„ä½     | å…è¨± `NULL` | `note TEXT NULL`        |
| æœªä¾†æ‰æœƒæœ‰å€¼ | å…è¨± `NULL` | `paid_at DATETIME NULL` |

#### åŸå‰‡ 2ï¼šç‹€æ…‹æ¬„ä½çµ¦ DEFAULT å€¼

**ç‚ºä»€éº¼ç‹€æ…‹æ¬„ä½å»ºè­°çµ¦ DEFAULTï¼Ÿ ( æœ¬è™•ä»¥ã€Œåª’åˆä¸­ã€èˆ‰ä¾‹, ä½†æœ¬å°ˆæ¡ˆç•¶åˆè¨­è¨ˆæ™‚ç–å¿½æ²’æŠŠ status è¨­ç‚º NOT NULL DEFAULT 'åª’åˆä¸­', å¿…é ˆè¨˜å¾—é ç¨‹å¼ç¢¼æ‰‹å‹•æ’å…¥status )**

**åŸå›  1ï¼šæ¥­å‹™é‚è¼¯ä¸Šï¼Œæ–°è³‡æ–™ä¸€å®šæœ‰åˆå§‹ç‹€æ…‹**

```sql
-- è¨‚å–®çš„ç”Ÿå‘½é€±æœŸ
åª’åˆä¸­ â†’ åª’åˆæˆåŠŸ â†’ å·²ä»˜æ¬¾ â†’ å·²å‡ºè²¨

-- æ–°è¨‚å–®ä¸€å®šæ˜¯å¾ã€Œåª’åˆä¸­ã€é–‹å§‹ï¼Œä¸å¯èƒ½æ˜¯ NULL
```

**åŸå›  2ï¼šæ¸›å°‘ç¨‹å¼ç¢¼é‡è¤‡ï¼Œé¿å…äººç‚ºç–å¿½**

```python
# âŒ æ²’æœ‰ DEFAULTï¼šæ¯æ¬¡ INSERT éƒ½è¦æ‰‹å‹•å¯«
cursor.execute("""
    INSERT INTO orders (ticket_id, buyer_id, status, payment_status, shipment_status)
    VALUES (%s, %s, 'åª’åˆä¸­', 'æœªä»˜æ¬¾', 'æœªå‡ºè²¨')
""", (ticket_id, buyer_id))
# å¦‚æœæŸæ¬¡å¿˜è¨˜å¯«ï¼Œå°±æœƒæ˜¯ NULLï¼Œé€ æˆ bug

# âœ“ æœ‰ DEFAULTï¼šåªéœ€æŒ‡å®šå¿…è¦æ¬„ä½
cursor.execute("""
    INSERT INTO orders (ticket_id, buyer_id)
    VALUES (%s, %s)
""", (ticket_id, buyer_id))
# statusã€payment_statusã€shipment_status è‡ªå‹•å¡«å…¥ DEFAULT å€¼
```

**åŸå›  3ï¼šç¢ºä¿è³‡æ–™ä¸€è‡´æ€§**

```sql
-- æœ‰ DEFAULT + NOT NULLï¼šç‹€æ…‹æ¬„ä½æ°¸é æœ‰å€¼
status VARCHAR(20) NOT NULL DEFAULT 'åª’åˆä¸­'

-- ä¸å¯èƒ½å‡ºç¾ NULL
SELECT * FROM orders WHERE status IS NULL;  -- æ°¸é æ˜¯ 0 ç­†
```

**åŸå›  4ï¼šæ–¹ä¾¿ç¶­è­·**

```python
# å¦‚æœåˆå§‹ç‹€æ…‹è¦æ”¹åï¼ˆä¾‹å¦‚ã€Œåª’åˆä¸­ã€æ”¹æˆã€Œå¾…ç¢ºèªã€ï¼‰

# âŒ æ²’æœ‰ DEFAULTï¼šè¦æ‰¾å‡ºæ‰€æœ‰ INSERT èªå¥é€ä¸€ä¿®æ”¹

# âœ“ æœ‰ DEFAULTï¼šåªéœ€æ”¹è³‡æ–™åº«ä¸€è™•
# ALTER TABLE orders ALTER COLUMN status SET DEFAULT 'å¾…ç¢ºèª';
```

#### åŸå‰‡ 3ï¼šNOT NULL + ç„¡ DEFAULT = INSERT æ™‚å¿…å¡«

```sql
-- é€™äº›æ¬„ä½ INSERT æ™‚å¿…é ˆæŒ‡å®šï¼Œå¦å‰‡å ±éŒ¯
ticket_id INT NOT NULL,
buyer_id INT NOT NULL,
seller_id INT NOT NULL
```

---

### å®Œæ•´è¨­è¨ˆç¯„ä¾‹

```sql
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT,

    -- å¿…å¡«æ¬„ä½ï¼ˆINSERT æ™‚å¿…é ˆæŒ‡å®šï¼Œå¦å‰‡å ±éŒ¯ï¼‰
    ticket_id INT NOT NULL,
    buyer_id INT NOT NULL,
    seller_id INT NOT NULL,

    -- ç‹€æ…‹æ¬„ä½ï¼ˆæœ‰ DEFAULTï¼ŒINSERT å¯ä¸æŒ‡å®šï¼‰
    status VARCHAR(20) NOT NULL DEFAULT 'åª’åˆä¸­',
    payment_status VARCHAR(20) NOT NULL DEFAULT 'æœªä»˜æ¬¾',
    shipment_status VARCHAR(20) NOT NULL DEFAULT 'æœªå‡ºè²¨',

    -- æ™‚é–“æ¬„ä½ï¼ˆNULL è¡¨ç¤ºäº‹ä»¶å°šæœªç™¼ç”Ÿï¼‰
    match_requested_at DATETIME NOT NULL,   -- å¿…å¡«ï¼šè¨‚å–®å»ºç«‹æ™‚ä¸€å®šæœ‰
    paid_at DATETIME NULL,                   -- ä»˜æ¬¾å¾Œæ‰å¡«å…¥
    shipped_at DATETIME NULL,                -- å‡ºè²¨å¾Œæ‰å¡«å…¥

    -- å»ºç«‹æ™‚é–“ï¼ˆè‡ªå‹•å¡«å…¥ç•¶å‰æ™‚é–“ï¼‰
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    -- é¸å¡«æ¬„ä½
    note TEXT NULL
);
```

**å°æ‡‰çš„ç¨‹å¼ç¢¼**ï¼š

```python
# å¾Œç«¯ INSERTï¼ˆåªéœ€æŒ‡å®šå¿…è¦æ¬„ä½ï¼‰
cursor.execute("""
    INSERT INTO orders (ticket_id, buyer_id, seller_id, match_requested_at)
    VALUES (%s, %s, %s, %s)
""", (ticket_id, buyer_id, seller_id, utc_now()))
# status = 'åª’åˆä¸­'ï¼ˆDEFAULTï¼‰
# payment_status = 'æœªä»˜æ¬¾'ï¼ˆDEFAULTï¼‰
# paid_at = NULLï¼ˆå…è¨± NULLï¼‰
```

```javascript
// å‰ç«¯è™•ç† null æ¬„ä½
const paidTime = data.paid_at ? formatDateTime(data.paid_at) : "--";
const note = data.note || "ç„¡å‚™è¨»"; // null æˆ–ç©ºå­—ä¸²éƒ½é¡¯ç¤ºã€Œç„¡å‚™è¨»ã€
```

---

### è¨­è¨ˆæ±ºç­–æ•´ç†

| æ¬„ä½é¡å‹         | è¨­è¨ˆå»ºè­°                             | ç¯„ä¾‹                                                     |
| ---------------- | ------------------------------------ | -------------------------------------------------------- |
| å¤–éµ / ID        | `NOT NULL`                           | `buyer_id INT NOT NULL`                                  |
| ç‹€æ…‹æ¬„ä½         | `NOT NULL DEFAULT 'åˆå§‹ç‹€æ…‹'`        | `status VARCHAR(20) NOT NULL DEFAULT 'åª’åˆä¸­'`           |
| å»ºç«‹æ™‚é–“         | `NOT NULL DEFAULT CURRENT_TIMESTAMP` | `created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP` |
| æœªä¾†æ‰ç™¼ç”Ÿçš„æ™‚é–“ | `NULL`                               | `paid_at DATETIME NULL`                                  |
| é¸å¡«æ–‡å­—         | `NULL` æˆ– `DEFAULT ''`               | `note TEXT NULL`                                         |
| é¸å¡«æ•¸å€¼         | `NULL` æˆ– `DEFAULT 0`                | `discount INT NULL`                                      |

---

### è³‡æ–™åº«å›å‚³å€¼çš„å‹åˆ¥è½‰æ›

### ç‚ºä»€éº¼éœ€è¦æ‰‹å‹•è½‰æ›ï¼Ÿ

è³‡æ–™åº«å›å‚³çš„æŸäº›å‹åˆ¥ç„¡æ³•ç›´æ¥ JSON åºåˆ—åŒ–ï¼Œæˆ–è½‰æ›å¾Œçš„æ ¼å¼ä¸ç¬¦åˆå‰ç«¯éœ€æ±‚ã€‚

### å¸¸è¦‹æƒ…æ³èˆ‡è™•ç†æ–¹å¼

#### 1. Decimal â†’ float

| æƒ…æ³   | è³‡æ–™åº«å›å‚³å€¼     | å•é¡Œ                            | è™•ç†æ–¹å¼     |
| ------ | ---------------- | ------------------------------- | ------------ |
| æœ‰è©•åˆ† | `Decimal('4.5')` | Decimal ç„¡æ³•ç›´æ¥ JSON åºåˆ—åŒ–    | è½‰æˆ `float` |
| ç„¡è©•åˆ† | `None`           | ç¶­æŒ `None`ï¼ˆJSON ä¸­æ˜¯ `null`ï¼‰ | ä¸è™•ç†       |

```python
# è™•ç†æ–¹å¼
row["rating"] = float(row["rating"]) if row["rating"] is not None else None
```

**è£œå……èªªæ˜**ï¼š

- FastAPI å…§éƒ¨æœƒä½¿ç”¨ `jsonable_encoder` è‡ªå‹•æŠŠ `Decimal` è½‰æˆ `float`
- ä½†æ‰‹å‹•è½‰æ›çš„å¥½è™•ï¼šç¨‹å¼ç¢¼æ„åœ–æ˜ç¢ºã€ä¸ä¾è³´æ¡†æ¶éš±æ€§è¡Œç‚ºã€æ›æ¡†æ¶æ™‚ä¸æœƒå‡ºéŒ¯

#### 2. JSON å­—ä¸² â†’ list

| æƒ…æ³   | è³‡æ–™åº«å›å‚³å€¼                 | å•é¡Œ                       | è™•ç†æ–¹å¼    |
| ------ | ---------------------------- | -------------------------- | ----------- |
| æœ‰åœ–ç‰‡ | `'["url1", "url2"]'`ï¼ˆå­—ä¸²ï¼‰ | å‰ç«¯æ”¶åˆ°å­—ä¸²ï¼Œç„¡æ³•ç›´æ¥ä½¿ç”¨ | è½‰æˆ `list` |
| ç„¡åœ–ç‰‡ | `None` æˆ– `""`               | å‰ç«¯éœ€è¦ç©ºé™£åˆ—             | è½‰æˆ `[]`   |

```python
# è™•ç†æ–¹å¼
row["image_urls"] = json.loads(row["image_urls"]) if row["image_urls"] else []
```

**ç‚ºä»€éº¼è³‡æ–™åº«å­˜ JSON å­—ä¸²ï¼Ÿ**

- MySQL çš„ `TEXT` æˆ– `VARCHAR` æ¬„ä½å­˜çš„æ˜¯å­—ä¸²
- å³ä½¿ç”¨ `JSON` å‹åˆ¥ï¼ŒPython mysql-connector å›å‚³çš„ä»æ˜¯å­—ä¸²
- å¿…é ˆç”¨ `json.loads()` è§£ææˆ Python list

#### 3. None â†’ ç©ºå­—ä¸²

| æƒ…æ³   | è³‡æ–™åº«å›å‚³å€¼ | å•é¡Œ                  | è™•ç†æ–¹å¼  |
| ------ | ------------ | --------------------- | --------- |
| æœ‰å‚™è¨» | `"è«‹é¢äº¤"`   | æ­£å¸¸                  | ä¸è™•ç†    |
| ç„¡å‚™è¨» | `None`       | å‰ç«¯éœ€é¡å¤–è™•ç† `null` | è½‰æˆ `""` |

```python
# è™•ç†æ–¹å¼
row["note"] = row["note"] if row["note"] else ""
```

**é€™è¡Œæ˜¯å¿…è¦çš„å—ï¼Ÿ**

- éå¿…è¦ï¼Œä½†å»ºè­°ä¿ç•™
- å¥½è™•ï¼šå‰ç«¯ä¸ç”¨å¯« `data.note || ""`ï¼Œç¨‹å¼ç¢¼æ›´ç°¡æ½”
- å¾Œç«¯çµ±ä¸€è™•ç†ï¼Œæ‰€æœ‰å‰ç«¯ï¼ˆWebã€Appï¼‰éƒ½å—ç›Š

### å®Œæ•´è™•ç†ç¯„ä¾‹

```python
for row in rows:
    # 1. Decimal â†’ floatï¼ˆè©•åˆ†ï¼‰
    row["rating"] = float(row["rating"]) if row["rating"] is not None else None

    # 2. JSON å­—ä¸² â†’ listï¼ˆåœ–ç‰‡ï¼‰
    row["image_urls"] = json.loads(row["image_urls"]) if row["image_urls"] else []

    # 3. None â†’ ç©ºå­—ä¸²ï¼ˆå‚™è¨»ï¼‰
    row["note"] = row["note"] if row["note"] else ""
```

### è¨­è¨ˆåŸå‰‡

| åŸå‰‡             | èªªæ˜                                   |
| ---------------- | -------------------------------------- |
| å¾Œç«¯è² è²¬å‹åˆ¥è½‰æ› | API å›å‚³æ­£ç¢ºå‹åˆ¥ï¼Œä»»ä½•å‰ç«¯éƒ½èƒ½ç›´æ¥ä½¿ç”¨ |
| å‰ç«¯åšé˜²ç¦¦æ€§è™•ç† | è¬ä¸€å¾Œç«¯å‡ºéŒ¯ï¼Œå‰ç«¯ä¹Ÿèƒ½è™•ç†             |
| æ˜ç¢ºå„ªæ–¼éš±æ€§     | æ‰‹å‹•è½‰æ›æ¯”ä¾è³´æ¡†æ¶è‡ªå‹•è½‰æ›æ›´å¯é        |

---

### 10.6 FastAPI Internals

### éœæ…‹é é¢è·¯ç”±æ©Ÿåˆ¶

### é é¢è·¯ç”± vs API è·¯ç”±

| é¡å‹     | ç¯„ä¾‹             | å›å‚³å…§å®¹  | ç”¨é€”                       |
| -------- | ---------------- | --------- | -------------------------- |
| é é¢è·¯ç”± | `GET /buy`       | HTML æª”æ¡ˆ | çµ¦ç€è¦½å™¨æ¸²æŸ“æˆç¶²é          |
| API è·¯ç”± | `GET /api/games` | JSON      | çµ¦ JavaScript fetch() ä½¿ç”¨ |

### Router èˆ‡ App çš„é—œä¿‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å•Ÿå‹•æ™‚çš„è¼‰å…¥æµç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. uvicorn app:app å•Ÿå‹•                                            â”‚
â”‚                                                                     â”‚
â”‚  2. åŸ·è¡Œ app.py                                                     â”‚
â”‚     from routes import pages  â† è¼‰å…¥ pages.py                       â”‚
â”‚                      â”‚                                              â”‚
â”‚                      â–¼                                              â”‚
â”‚     pages.py è¢«åŸ·è¡Œï¼š                                                â”‚
â”‚     â€¢ router = APIRouter()  â† å»ºç«‹è·¯ç”±æ”¶é›†å™¨                         â”‚
â”‚     â€¢ @router.get("/") ...  â† æŠŠè·¯ç”±ã€Œç™»è¨˜ã€åˆ° router                â”‚
â”‚     â€¢ @router.get("/buy") ...                                       â”‚
â”‚                                                                     â”‚
â”‚  3. app.include_router(pages.router)                                â”‚
â”‚     æŠŠ pages.router è£¡ç™»è¨˜çš„æ‰€æœ‰è·¯ç”±ã€Œè¤‡è£½ã€åˆ° app ä¸Š                 â”‚
â”‚                                                                     â”‚
â”‚  4. app çš„è·¯ç”±è¡¨è®Šæˆï¼š                                               â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚     â”‚ GET /           â†’ pages.index()                 â”‚             â”‚
â”‚     â”‚ GET /buy        â†’ pages.buy_page()              â”‚             â”‚
â”‚     â”‚ GET /sell       â†’ pages.sell()                  â”‚             â”‚
â”‚     â”‚ GET /api/games  â†’ games.get_games() â† å…¶ä»–è·¯ç”±  â”‚             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è«‹æ±‚è™•ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è«‹æ±‚æ™‚çš„è™•ç†æµç¨‹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. ä½¿ç”¨è€…åœ¨ç¶²å€åˆ—è¼¸å…¥ https://example.com/buy                       â”‚
â”‚                                                                     â”‚
â”‚  2. ç€è¦½å™¨ç™¼é€ GET /buy                                             â”‚
â”‚                                                                     â”‚
â”‚  3. uvicorn æ”¶åˆ°è«‹æ±‚ï¼Œäº¤çµ¦ app                                       â”‚
â”‚                                                                     â”‚
â”‚  4. app æŸ¥è·¯ç”±è¡¨ï¼šGET /buy â†’ buy_page()                             â”‚
â”‚                                                                     â”‚
â”‚  5. åŸ·è¡Œ buy_page()ï¼š                                                â”‚
â”‚     return FileResponse("./static/buy.html", ...)                   â”‚
â”‚                                                                     â”‚
â”‚  6. FastAPI è®€å– buy.html æª”æ¡ˆå…§å®¹                                  â”‚
â”‚                                                                     â”‚
â”‚  7. å›å‚³ HTML çµ¦ç€è¦½å™¨                                               â”‚
â”‚                                                                     â”‚
â”‚  8. ç€è¦½å™¨æ¸²æŸ“æˆç¶²é é¡¯ç¤ºçµ¦ä½¿ç”¨è€…                                      â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç‚ºä»€éº¼ Router å¿…é ˆä½µå…¥ Appï¼Ÿ

```
uvicorn app:app
       â”‚
       â””â”€â”€ æ„æ€æ˜¯ï¼šå» app.py æ‰¾ app è®Šæ•¸ï¼ŒåŸ·è¡Œå®ƒ
```

**ä¼ºæœå™¨åªèªè­˜ appï¼Œä¸èªè­˜ routerã€‚** å¦‚æœ router æ²’æœ‰ç”¨ `app.include_router()` ä½µå…¥ appï¼Œé€™äº›è·¯ç”±å°±ä¸æœƒè¢«åŸ·è¡Œã€‚

### async vs æ™®é€šå‡½æ•¸

| å¯«æ³•        | é©åˆå ´æ™¯                                      |
| ----------- | --------------------------------------------- |
| `async def` | æœ‰ I/O æ“ä½œï¼ˆè®€æª”æ¡ˆã€æŸ¥è³‡æ–™åº«ã€å‘¼å«å¤–éƒ¨ APIï¼‰ |
| `def`       | ç´”é‹ç®—ã€æ²’æœ‰ç­‰å¾…çš„æ“ä½œ                        |

```python
# å…©ç¨®éƒ½èƒ½é‹ä½œ
async def index():           # â† éåŒæ­¥å‡½æ•¸ï¼ˆå»ºè­°ï¼‰
    return FileResponse(...)

def index():                 # â† æ™®é€šå‡½æ•¸ï¼ˆä¹Ÿå¯ä»¥ï¼‰
    return FileResponse(...)
```

**å»ºè­°**ï¼šçµ±ä¸€ç”¨ `async`ï¼Œå› ç‚º FastAPI å®˜æ–¹æ¨è–¦ï¼Œä¸” FileResponse å…§éƒ¨æœƒè®€å–æª”æ¡ˆï¼ˆI/O æ“ä½œï¼‰ã€‚

### æª”æ¡ˆè·¯å¾‘èªªæ˜

```python
FileResponse("./static/index.html", media_type="text/html")
             â”‚
             â””â”€â”€ ç›¸å°è·¯å¾‘ï¼Œç›¸å°æ–¼åŸ·è¡Œ uvicorn çš„å·¥ä½œç›®éŒ„
```

| è·¯å¾‘éƒ¨åˆ†      | èªªæ˜                               |
| ------------- | ---------------------------------- |
| `.`           | åŸ·è¡ŒæŒ‡ä»¤æ™‚çš„å·¥ä½œç›®éŒ„ï¼ˆå°ˆæ¡ˆæ ¹ç›®éŒ„ï¼‰ |
| `/static`     | static è³‡æ–™å¤¾                      |
| `/index.html` | ç›®æ¨™æª”æ¡ˆ                           |

**æ³¨æ„**ï¼šå¿…é ˆå¾å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œ `uvicorn app:app`ï¼Œå¦å‰‡è·¯å¾‘æœƒå‡ºéŒ¯ã€‚

---

---

### FastAPI ä¾è³´æ³¨å…¥ï¼šHeader()

```python
def get_current_user(authorization: str = Header(None)) -> Dict[str, Any]:
```

```
def get_current_user(authorization: str = Header(None)) -> Dict[str, Any]:
                                â”‚     â”‚           â”‚
                                â”‚     â”‚           â””â”€â”€ Header(None)ï¼šå‘Šè¨´ FastAPIã€Œå¾ HTTP Header å–å€¼ã€
                                â”‚     â”‚                             å¦‚æœæ²’æœ‰é€™å€‹ Headerï¼Œå›å‚³ None
                                â”‚     â”‚
                                â”‚     â””â”€â”€ strï¼šæœŸæœ›çš„å‹åˆ¥
                                â”‚
                                â””â”€â”€ authorizationï¼šåƒæ•¸åç¨±ï¼ŒFastAPI æœƒè‡ªå‹•å°æ‡‰åˆ° HTTP Header çš„ "Authorization"

```

**é‹ä½œåŸç†**ï¼š

```

HTTP Request
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /api/orders HTTP/1.1                â”‚
â”‚ Host: example.com                       â”‚
â”‚ Authorization: Bearer eyJhbGciOi...     â”‚ â† FastAPI è‡ªå‹•å–å‡ºé€™å€‹å€¼
â”‚ Content-Type: application/json          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
        FastAPI ä¾è³´æ³¨å…¥ç³»çµ±
                â”‚
                â”‚ åƒæ•¸åç¨± "authorization"
                â”‚ å°æ‡‰åˆ° Header "Authorization"ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
                â–¼
   authorization = "Bearer eyJhbGciOi..."

```

| èªæ³•           | èªªæ˜                                        |
| -------------- | ------------------------------------------- |
| `Header(None)` | å¾ HTTP Header å–å€¼ï¼Œè‹¥ä¸å­˜åœ¨å‰‡å›å‚³ None    |
| `Header(...)`  | å¾ HTTP Header å–å€¼ï¼Œè‹¥ä¸å­˜åœ¨å‰‡å ±éŒ¯ï¼ˆå¿…å¡«ï¼‰ |
| `Query(None)`  | å¾ URL Query String å–å€¼                    |
| `Body(...)`    | å¾ Request Body å–å€¼                        |

---
