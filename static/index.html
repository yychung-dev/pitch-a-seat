<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>首頁 | Pitch-A-Seat</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans TC", sans-serif;
        background: #f8f9fa;
        padding-top: 60px;
      }

      /* 導覽列 */
      .navigation {
        display: flex;
        justify-content: center;
        height: 35px;
        padding: 10px 0;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 100;
        background-color: black;
        border-bottom: 1px solid #e0e0e0;
      }

      .navlist {
        display: flex;
        justify-content: space-between;
        width: 1200px;
        height: 34px;
      }

      .webtitle {
        width: 300px;
        height: 34px;
        font-weight: 700;
        font-size: 30px;
        color: #ffffff;
        line-height: 34px;
        cursor: pointer;
      }

      .nav-item {
        display: flex;
        height: 34px;
      }

      .cart-link,
      .memberpage-link {
        padding: 10px;
        font-size: 16px;
        font-weight: 500;
        color: #ffffff;
        cursor: pointer;
      }

      /* 月曆區塊 */
      .calendar-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px 0 10px 0;
        gap: 10px;
      }

      .calendar-controls button {
        font-size: 20px;
        padding: 0 10px;
        cursor: pointer;
      }

      .calendar-title {
        font-size: 24px;
        font-weight: bold;
      }

      .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #ccc;
        max-width: 1200px;
        margin: 0 auto;
      }

      .day,
      .weekday {
        background: white;
        padding: 10px;
        min-height: 100px;
        box-sizing: border-box;
      }

      .weekday {
        background: #333;
        color: white;
        font-weight: bold;
        text-align: center;
      }

      .date-num {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .event {
        font-size: 12px;
        background: #ffecb3;
        padding: 2px 4px;
        border-radius: 4px;
        margin-top: 3px;
        line-height: 1.2;
        cursor: pointer;
        transition: background 0.2s;
      }

      .event.selected {
        background: #ffc107; /* selected時呈現深黃色 */
        color: #000;
      }

      /* 按鈕區 */
      .sell-buy-button {
        margin-top: 40px;
        display: flex;
        justify-content: center;
        gap: 20px;
      }

      .btn-sell,
      .btn-buy {
        padding: 10px 20px;
        font-size: 16px;
        font-weight: bold;
        border: none;
        background-color: #007bff;
        color: white;
        border-radius: 4px;
        cursor: pointer;
      }

      .btn-sell:hover,
      .btn-buy:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="navigation">
        <div class="navlist">
          <div class="webtitle">Pitch-A-Seat</div>
          <div class="nav-item">
            <!-- <div class="cart-link">購物車</div> -->
            <div class="memberpage-link">會員中心</div>
          </div>
        </div>
      </div>
    </header>

    <!-- 月曆控制列 -->
    <div class="calendar-controls">
      <button id="prevMonth">←</button>
      <div class="calendar-title" id="monthLabel">2025年6月</div>
      <button id="nextMonth">→</button>
    </div>

    <!-- 賽程月曆 -->
    <div class="calendar" id="calendar"></div>

    <!-- 賣票買票按鈕 -->
    <div class="sell-buy-button">
      <button type="button" class="btn-sell">我要賣票</button>
      <button type="button" class="btn-buy">我要買票</button>
    </div>

    <script>
      // 顯示初始月曆
      const calendar = document.getElementById("calendar");
      const monthLabel = document.getElementById("monthLabel");
      const now = new Date();
      let currentYear = now.getFullYear();
      let currentMonth = now.getMonth() + 1;

      const weekdays = ["日", "一", "二", "三", "四", "五", "六"];

      // 存放「目前使用者在首頁選到哪一筆 game」
      let selectedGame = null;

      function renderCalendar(year, month) {
        calendar.innerHTML = "";

        const firstDay = new Date(year, month - 1, 1);
        const daysInMonth = new Date(year, month, 0).getDate();
        const startDay = firstDay.getDay();

        monthLabel.textContent = `${year}年${month}月`;

        // 先渲染「星期」列
        weekdays.forEach((day) => {
          const w = document.createElement("div");
          w.className = "weekday";
          w.textContent = day;
          calendar.appendChild(w);
        });

        // 補空格
        for (let i = 0; i < startDay; i++) {
          const blank = document.createElement("div");
          blank.className = "day";
          calendar.appendChild(blank);
        }

        // 撈當月所有賽程
        fetch(`/api/schedule?year=${year}&month=${month}`)
          .then((res) => res.json())
          .then((games) => {
            // 先把所有場次按日期分組
            const gameMap = {};
            games.forEach((game) => {
              const dayNum = new Date(game.game_date).getDate();
              if (!gameMap[dayNum]) gameMap[dayNum] = [];
              gameMap[dayNum].push(game);
            });

            // 將每一天（1～daysInMonth）畫出來
            for (let i = 1; i <= daysInMonth; i++) {
              const dayBox = document.createElement("div");
              dayBox.className = "day";

              const dateLabel = document.createElement("div");
              dateLabel.className = "date-num";
              dateLabel.textContent = i;
              dayBox.appendChild(dateLabel);

              if (gameMap[i]) {
                gameMap[i].forEach((g) => {
                  const e = document.createElement("div");
                  e.className = "event";
                  e.innerHTML = `
                  <div>${g.stadium} (${g.game_number})</div>
                  <div>${g.team_away} vs ${g.team_home}</div>
                  <div>${g.start_time.slice(0, 5)}</div>
                `;
                  // 把這筆賽程的重要資訊都綁到 DOM element 的 data-attributes：
                  e.dataset.gameId = g.id; // 後端 SELECT id AS id
                  e.dataset.date = g.game_date; // yyyy-mm-dd
                  e.dataset.time = g.start_time; // HH:MM
                  e.dataset.stadium = g.stadium;
                  e.dataset.teamHome = g.team_home;
                  e.dataset.teamAway = g.team_away;
                  e.dataset.gameNumber = g.game_number;

                  // 點擊某個 “event” 卡片時：先把之前的 selected 樣式移掉，再把新卡片標記為 selected，最後把該筆資料存進 selectedGame
                  e.addEventListener("click", () => {
                    // 1. 移除先前被選到的所有 .event.selected
                    document
                      .querySelectorAll(".event.selected")
                      .forEach((old) => {
                        old.classList.remove("selected");
                      });
                    // 2. 將自己標成 selected
                    e.classList.add("selected");

                    // 3. 把該筆資料存在 selectedGame
                    selectedGame = {
                      game_id: e.dataset.gameId,
                      date: e.dataset.date,
                      time: e.dataset.time,
                      stadium: e.dataset.stadium,
                      team_home: e.dataset.teamHome,
                      team_away: e.dataset.teamAway,
                      game_number: e.dataset.gameNumber,
                    };
                  });
                  dayBox.appendChild(e);
                });
              }

              calendar.appendChild(dayBox);
            }
          });
      }

      // 上下月切換
      document.getElementById("prevMonth").addEventListener("click", () => {
        currentMonth--;
        if (currentMonth === 0) {
          currentMonth = 12;
          currentYear--;
        }
        renderCalendar(currentYear, currentMonth);
      });

      document.getElementById("nextMonth").addEventListener("click", () => {
        currentMonth++;
        if (currentMonth === 13) {
          currentMonth = 1;
          currentYear++;
        }
        renderCalendar(currentYear, currentMonth);
      });

      // 首頁導覽按鈕
      document.querySelector(".webtitle").addEventListener("click", () => {
        location.reload();
      });

      // 「我要賣票」按鈕：若沒選到 selectedGame，就跳 alert；有選到就做成 query string 並跳轉
      document.querySelector(".btn-sell").addEventListener("click", () => {
        if (!selectedGame) {
          alert("請先在月曆上點選一筆您要賣票的賽程");
          return;
        }
        // 把 selectedGame 變成 query string
        const params = new URLSearchParams({
          game_id: selectedGame.game_id,
          date: selectedGame.date,
          time: selectedGame.time,
          stadium: selectedGame.stadium,
          team_home: selectedGame.team_home,
          team_away: selectedGame.team_away,
          game_number: selectedGame.game_number,
        }).toString();

        window.location.href = `/sell?${params}`;
      });

      // 「我要買票」按鈕：導到 /events
      document.querySelector(".btn-buy").addEventListener("click", () => {
        fetch("/events", { method: "GET" }).then((res) => {
          window.location.href = res.url;
        });
      });

      // 點擊導頁至會員中心
      document
        .querySelector(".memberpage-link")
        .addEventListener("click", () => {
          fetch("/membership", { method: "GET" }).then((res) => {
            window.location.href = res.url;
          });
        });

      // 首次載入
      renderCalendar(currentYear, currentMonth);
    </script>
  </body>
</html>
