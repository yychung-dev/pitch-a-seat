<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>會員中心 | Pitch-A-Seat</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans TC", sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 60px 20px 20px;
      }
      .navigation {
        display: flex;
        justify-content: center;
        height: 50px;
        padding: 10px 0;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 100;
        background-color: black;
        border-bottom: 1px solid #e0e0e0;
      }
      .navlist {
        display: flex;
        justify-content: space-between;
        width: 1200px;
        align-items: center;
      }
      .webtitle {
        font-weight: 700;
        font-size: 30px;
        color: #ffffff;
        cursor: pointer;
      }
      .nav-item {
        display: flex;
        align-items: center;
        gap: 20px;
        color: white;
        position: relative;
      }
      .notifications {
        cursor: pointer;
      }
      .notifications .badge {
        position: absolute;
        top: -5px;
        right: -10px;
        background: red;
        color: #fff;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
      }
      .notif-dropdown {
        position: absolute;
        right: 0;
        top: 120%;
        width: 300px;
        max-height: 400px;
        overflow-y: auto;
        background: black;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: none;
        z-index: 150;
      }
      .notif-dropdown ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .notif-dropdown li {
        padding: 10px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
        cursor: pointer;
      }
      .notif-dropdown li:hover {
        background-color: #f0f0f0;
      }
      .section-title {
        margin-top: 30px;
        font-size: 20px;
        font-weight: bold;
        border-bottom: 2px solid #ccc;
        padding-bottom: 5px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 6px;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }
      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      button {
        cursor: pointer;
      }
      .tabs {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .tabs button {
        padding: 8px 16px;
        border: none;
        background-color: #e0e0e0;
        cursor: pointer;
        border-radius: 5px;
        font-weight: bold;
      }
      .tabs button.active {
        background-color: #007bff;
        color: white;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 10px;
        text-align: center;
      }
      th {
        background-color: #f0f0f0;
      }
      .status-success {
        color: green;
        font-weight: bold;
      }
      .status-shipped {
        color: #007bff;
        font-weight: bold;
      }
      .btn-accept {
        background-color: #28a745;
        color: #fff;
        margin: 0 4px;
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
      }
      .btn-reject {
        background-color: #dc3545;
        color: #fff;
        margin: 0 4px;
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
      }
      .btn-detail {
        background-color: #007bff;
        color: #fff;
        margin: 0 4px;
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
      }
      .modal-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
      }
      .modal {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .close-btn {
        cursor: pointer;
        font-size: 20px;
      }
      .btn-pay {
        background-color: #ffc107;
        color: #fff;
        margin: 0 4px;
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
      }
      .btn-ship {
        background-color: #17a2b8;
        color: #fff;
        margin: 0 4px;
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="navigation">
        <div class="navlist">
          <div class="webtitle" onclick="location.href='/'">Pitch-A-Seat</div>
          <div class="nav-item">
            <div class="cart-link" onclick="location.href='/browse'">
              購物車
            </div>
            <div class="memberpage-link" onclick="location.href='/membership'">
              會員中心
            </div>
            <div class="notifications" id="notifBell">
              🔔<span class="badge" id="notifCount">0</span>
              <div class="notif-dropdown" id="notifDropdown">
                <ul id="notifList"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="section-title">測試身份切換</div>
    <div class="form-group">
      <label for="userSwitch">模擬使用者</label>
      <select id="userSwitch">
        <option value="1">買方 (memberId=1)</option>
        <option value="2">賣方 (memberId=2)</option>
      </select>
    </div>

    <div class="section-title">個人資訊</div>
    <form id="profileForm">
      <div class="form-group">
        <label for="name">姓名</label><input type="text" id="name" required />
      </div>
      <div class="form-group">
        <label for="phone">手機</label
        ><input type="tel" id="phone" placeholder="例如：0912345678" required />
      </div>
      <div class="form-group">
        <label for="email">信箱</label
        ><input type="email" id="email" required />
      </div>
      <div class="form-group">
        <label for="favoriteTeam">喜愛球隊</label
        ><select id="favoriteTeam" required>
          <option value="">請選擇</option>
          <option>中信兄弟</option>
          <option>富邦悍將</option>
          <option>樂天桃猿</option>
          <option>統一獅</option>
          <option>味全龍</option>
          <option>台鋼雄鷹</option>
        </select>
      </div>
      <div class="form-group checkbox-group">
        <input type="checkbox" id="subscribe" /><label for="subscribe"
          >訂閱電子報</label
        >
      </div>
      <div class="form-group"><button type="submit">儲存資訊</button></div>
    </form>

    <div class="section-title">訂單紀錄</div>
    <div class="tabs">
      <button id="buyerTab" class="active">買方訂單</button>
      <button id="sellerTab">賣方訂單</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>訂單編號</th>
          <th>賽事</th>
          <th>媒合狀態</th>
          <th>付款狀態</th>
          <th>出貨狀態</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="orderTableBody">
        <tr>
          <td colspan="6">載入中...</td>
        </tr>
      </tbody>
    </table>

    <div class="modal-bg" id="modalBg">
      <div class="modal">
        <div class="modal-header">
          <h3>訂單詳情</h3>
          <span class="close-btn" id="modalClose">&times;</span>
        </div>
        <div class="modal-body" id="modalBody"></div>
      </div>
    </div>

    <script>
      let memberId = 1;
      let currentTab = "buyer";

      const userSwitch = document.getElementById("userSwitch");
      // 2) 把所有呼叫 loadAll 的地方，都用 async callback，並 await 它
      userSwitch.addEventListener("change", async () => {
        memberId = parseInt(userSwitch.value);
        await loadAll();
      });

      document.getElementById("profileForm").addEventListener("submit", (e) => {
        e.preventDefault();
        alert("個人資訊已儲存！(Demo)");
      });
      document
        .getElementById("modalClose")
        .addEventListener(
          "click",
          () => (document.getElementById("modalBg").style.display = "none")
        );
      document
        .getElementById("notifBell")
        .addEventListener("click", toggleNotif);
      document.addEventListener("click", (e) => {
        const d = document.getElementById("notifDropdown");
        if (!document.getElementById("notifBell").contains(e.target))
          d.style.display = "none";
      });

      document
        .getElementById("buyerTab")
        .addEventListener("click", () => switchTab("buyer"));
      document
        .getElementById("sellerTab")
        .addEventListener("click", () => switchTab("seller"));

      // 3) 把 switchTab 也改成 async，保證切 tab 時也是先訂單、後通知
      async function switchTab(tab) {
        currentTab = tab;
        document
          .getElementById("buyerTab")
          .classList.toggle("active", tab === "buyer");
        document
          .getElementById("sellerTab")
          .classList.toggle("active", tab === "seller");
        await loadAll();
      }
      // 1) 把 loadAll 改成 async，並在裡面用 await
      async function loadAll() {
        // 等 fetchOrders 拿完資料、畫面更新後，才接著 loadNotifications
        await fetchOrders();
        await loadNotifications();
      }

      async function fetchOrders() {
        const endpoint =
          currentTab === "buyer" ? "/api/buyerOrders" : "/api/sellerOrders";
        const res = await fetch(`${endpoint}?member_id=${memberId}`);
        const orders = await res.json();
        renderOrders(orders);
      }

      function renderOrders(orders) {
        const tbody = document.getElementById("orderTableBody");
        tbody.innerHTML = "";
        if (!orders || orders.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6">目前沒有訂單</td></tr>';
          return;
        }
        orders.forEach((o) => {
          const tr = document.createElement("tr");
          const info = `${o.game_date} ${o.start_time} ${o.team_home} vs ${o.team_away}`;
          tr.innerHTML = `
          <td>#${o.order_id}</td>
          <td>${info}</td>
          <td class="${
            o.order_status === "媒合成功" ? "status-success" : ""
          }">${o.order_status}</td>
          <td>${o.payment_status}</td>
          <td class="${
            o.shipment_status === "已出貨" ? "status-shipped" : ""
          }">${o.shipment_status}</td>
        `;
          const actionTd = document.createElement("td");
          if (currentTab === "seller") {
            // 已付款的訂單顯示「出貨」
            if (
              o.payment_status === "已付款" &&
              o.shipment_status === "未出貨"
            ) {
              actionTd.append(btn("出貨", "btn-ship", () => ship(o.order_id)));
            }
            // 拒絕／接受按鈕保留
            actionTd.append(
              btn("接受", "btn-accept", () => upd(o.order_id, "accept")),
              btn("拒絕", "btn-reject", () => upd(o.order_id, "reject"))
            );
          } else {
            // buyer
            // 媒合成功且未付款 -> 顯示付款按鈕
            if (
              o.order_status === "媒合成功" &&
              o.payment_status === "未付款"
            ) {
              actionTd.append(btn("付款", "btn-pay", () => pay(o.order_id)));
            } else {
              actionTd.append(btn("詳情", "btn-detail", () => showModal(o)));
            }
          }
          tr.appendChild(actionTd);
          tbody.appendChild(tr);
        });
      }

      // 買家付款
      async function pay(orderId) {
        try {
          const res = await fetch("/api/pay_order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ order_id: orderId, buyer_id: memberId }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "付款失敗");
          loadAll();
        } catch (err) {
          alert(`${err.message}`);
        }
      }
      // buyer_id:memberId的效果？

      // 賣家出貨
      async function ship(orderId) {
        try {
          const res = await fetch("/api/mark_shipped", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ order_id: orderId, seller_id: memberId }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "出貨失敗");
          loadAll();
        } catch (err) {
          alert(`${err.message}`);
        }
      }

      function btn(text, cls, fn) {
        const b = document.createElement("button");
        b.className = cls;
        b.innerText = text;
        b.onclick = fn;
        return b;
      }

      async function upd(id, act) {
        try {
          // 1. 發送更新訂單狀態的請求
          const res = await fetch("/api/order_status", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              order_id: id,
              action: act,
              seller_id: memberId, // 帶上目前模擬的賣家 ID，後端用來檢查
            }),
          });

          // 2. 解析回應
          const data = await res.json();
          if (!res.ok) {
            // 如果狀態碼不是 2xx，就丟錯誤並顯示後端回傳的訊息
            throw new Error(data.detail || "操作失敗");
          }

          // 3. 成功後，重新抓訂單列表和通知清單
          await fetchOrders();
          await loadNotifications();
        } catch (err) {
          // 4. 失敗時彈出提示
          alert(`${err.message}`);
        }
      }
      // 舊版的upd function
      // async function upd(id, act) {
      //   await fetch("/api/order_status", {
      //     method: "POST",
      //     headers: { "Content-Type": "application/json" },
      //     body: JSON.stringify({ order_id: id, action: act }),
      //   });
      //   fetchOrders();
      //   loadNotifications();
      // }

      function showModal(o) {
        document.getElementById("modalBody").innerHTML = `
        <p>訂單編號：#${o.order_id}</p>
        <p>賽事：${o.game_date} ${o.start_time} ${o.team_home} vs ${o.team_away}</p>
        <p>媒合狀態：${o.order_status}</p>
        <p>付款狀態：${o.payment_status}</p>
        <p>出貨狀態：${o.shipment_status}</p>
      `;
        document.getElementById("modalBg").style.display = "flex";
      }

      async function loadNotifications() {
        const res = await fetch(`/api/notifications?member_id=${memberId}`);
        const notes = await res.json();
        let c = 0;
        const ul = document.getElementById("notifList");
        ul.innerHTML = "";
        notes.forEach((n) => {
          const li = document.createElement("li");
          li.innerText = n.message;
          li.onclick = () => (location.href = n.url);
          ul.appendChild(li);
          if (!n.is_read) c++;
        });
        document.getElementById("notifCount").innerText = c;
      }

      async function toggleNotif(e) {
        e.stopPropagation();
        const dd = document.getElementById("notifDropdown");
        // 如果從隱藏轉到顯示，就標記已讀
        if (dd.style.display !== "block") {
          // 1) 標記已讀
          await fetch(`/api/mark_notifications_read?member_id=${memberId}`, {
            method: "POST",
          });
          // 2) 重新抓一次通知列表
          await loadNotifications();
        }
        dd.style.display = dd.style.display === "block" ? "none" : "block";
      }
      // 每次開下拉選單就把 is_read=false 的通知全部改成 true。
      // 再重新跑一次 loadNotifications() 更新紅點和列表。

      document.addEventListener("DOMContentLoaded", async () => {
        await loadAll();
      });
    </script>
  </body>
</html>
