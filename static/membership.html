<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æœƒå“¡ä¸­å¿ƒ | Pitch-A-Seat</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans TC", sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 60px 20px 20px;
      }
      .navigation {
        display: flex;
        justify-content: center;
        height: 50px;
        padding: 10px 0;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 100;
        background-color: black;
        border-bottom: 1px solid #e0e0e0;
      }
      .navlist {
        display: flex;
        justify-content: space-between;
        width: 1200px;
        align-items: center;
      }
      .webtitle {
        font-weight: 700;
        font-size: 30px;
        color: #ffffff;
        cursor: pointer;
      }
      .nav-item {
        display: flex;
        align-items: center;
        gap: 20px;
        color: white;
        position: relative;
      }
      .notifications {
        cursor: pointer;
      }
      .notifications .badge {
        position: absolute;
        top: -5px;
        right: -10px;
        background: red;
        color: #fff;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
      }
      .notif-dropdown {
        position: absolute;
        right: 0;
        top: 120%;
        width: 300px;
        max-height: 400px;
        overflow-y: auto;
        background: black;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: none;
        z-index: 150;
      }
      .notif-dropdown ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .notif-dropdown li {
        padding: 10px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
        cursor: pointer;
      }
      .notif-dropdown li:hover {
        background-color: #f0f0f0;
      }
      .section-title {
        margin-top: 30px;
        font-size: 20px;
        font-weight: bold;
        border-bottom: 2px solid #ccc;
        padding-bottom: 5px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        font-weight: bold;
        margin-bottom: 6px;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }
      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      button {
        cursor: pointer;
      }
      .tabs {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .tabs button {
        padding: 8px 16px;
        border: none;
        background-color: #e0e0e0;
        cursor: pointer;
        border-radius: 5px;
        font-weight: bold;
      }
      .tabs button.active {
        background-color: #007bff;
        color: white;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 10px;
        text-align: center;
      }
      th {
        background-color: #f0f0f0;
      }
      .status-success {
        color: green;
        font-weight: bold;
      }
      .status-shipped {
        color: #007bff;
        font-weight: bold;
      }
      .btn-accept {
        background-color: #28a745;
        color: #fff;
        margin: 0 4px;
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
      }
      .btn-reject {
        background-color: #dc3545;
        color: #fff;
        margin: 0 4px;
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
      }
      .btn-detail {
        background-color: #007bff;
        color: #fff;
        margin: 0 4px;
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
      }
      .modal-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
      }
      .modal {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .close-btn {
        cursor: pointer;
        font-size: 20px;
      }
      .btn-pay {
        background-color: #ffc107;
        color: #fff;
        margin: 0 4px;
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
      }
      .btn-ship {
        background-color: #17a2b8;
        color: #fff;
        margin: 0 4px;
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="navigation">
        <div class="navlist">
          <div class="webtitle" onclick="location.href='/'">Pitch-A-Seat</div>
          <div class="nav-item">
            <div class="cart-link" onclick="location.href='/browse'">
              è³¼ç‰©è»Š
            </div>
            <div class="memberpage-link" onclick="location.href='/membership'">
              æœƒå“¡ä¸­å¿ƒ
            </div>
            <div class="notifications" id="notifBell">
              ğŸ””<span class="badge" id="notifCount">0</span>
              <div class="notif-dropdown" id="notifDropdown">
                <ul id="notifList"></ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="section-title">æ¸¬è©¦èº«ä»½åˆ‡æ›</div>
    <div class="form-group">
      <label for="userSwitch">æ¨¡æ“¬ä½¿ç”¨è€…</label>
      <select id="userSwitch">
        <option value="1">è²·æ–¹ (memberId=1)</option>
        <option value="2">è³£æ–¹ (memberId=2)</option>
      </select>
    </div>

    <div class="section-title">å€‹äººè³‡è¨Š</div>
    <form id="profileForm">
      <div class="form-group">
        <label for="name">å§“å</label><input type="text" id="name" required />
      </div>
      <div class="form-group">
        <label for="phone">æ‰‹æ©Ÿ</label
        ><input type="tel" id="phone" placeholder="ä¾‹å¦‚ï¼š0912345678" required />
      </div>
      <div class="form-group">
        <label for="email">ä¿¡ç®±</label
        ><input type="email" id="email" required />
      </div>
      <div class="form-group">
        <label for="favoriteTeam">å–œæ„›çƒéšŠ</label
        ><select id="favoriteTeam" required>
          <option value="">è«‹é¸æ“‡</option>
          <option>ä¸­ä¿¡å…„å¼Ÿ</option>
          <option>å¯Œé‚¦æ‚å°‡</option>
          <option>æ¨‚å¤©æ¡ƒçŒ¿</option>
          <option>çµ±ä¸€ç…</option>
          <option>å‘³å…¨é¾</option>
          <option>å°é‹¼é›„é·¹</option>
        </select>
      </div>
      <div class="form-group checkbox-group">
        <input type="checkbox" id="subscribe" /><label for="subscribe"
          >è¨‚é–±é›»å­å ±</label
        >
      </div>
      <div class="form-group"><button type="submit">å„²å­˜è³‡è¨Š</button></div>
    </form>

    <div class="section-title">è¨‚å–®ç´€éŒ„</div>
    <div class="tabs">
      <button id="buyerTab" class="active">è²·æ–¹è¨‚å–®</button>
      <button id="sellerTab">è³£æ–¹è¨‚å–®</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>è¨‚å–®ç·¨è™Ÿ</th>
          <th>è³½äº‹</th>
          <th>åª’åˆç‹€æ…‹</th>
          <th>ä»˜æ¬¾ç‹€æ…‹</th>
          <th>å‡ºè²¨ç‹€æ…‹</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="orderTableBody">
        <tr>
          <td colspan="6">è¼‰å…¥ä¸­...</td>
        </tr>
      </tbody>
    </table>

    <div class="modal-bg" id="modalBg">
      <div class="modal">
        <div class="modal-header">
          <h3>è¨‚å–®è©³æƒ…</h3>
          <span class="close-btn" id="modalClose">&times;</span>
        </div>
        <div class="modal-body" id="modalBody"></div>
      </div>
    </div>

    <script>
      let memberId = 1;
      let currentTab = "buyer";

      const userSwitch = document.getElementById("userSwitch");
      // 2) æŠŠæ‰€æœ‰å‘¼å« loadAll çš„åœ°æ–¹ï¼Œéƒ½ç”¨ async callbackï¼Œä¸¦ await å®ƒ
      userSwitch.addEventListener("change", async () => {
        memberId = parseInt(userSwitch.value);
        await loadAll();
      });

      document.getElementById("profileForm").addEventListener("submit", (e) => {
        e.preventDefault();
        alert("å€‹äººè³‡è¨Šå·²å„²å­˜ï¼(Demo)");
      });
      document
        .getElementById("modalClose")
        .addEventListener(
          "click",
          () => (document.getElementById("modalBg").style.display = "none")
        );
      document
        .getElementById("notifBell")
        .addEventListener("click", toggleNotif);
      document.addEventListener("click", (e) => {
        const d = document.getElementById("notifDropdown");
        if (!document.getElementById("notifBell").contains(e.target))
          d.style.display = "none";
      });

      document
        .getElementById("buyerTab")
        .addEventListener("click", () => switchTab("buyer"));
      document
        .getElementById("sellerTab")
        .addEventListener("click", () => switchTab("seller"));

      // 3) æŠŠ switchTab ä¹Ÿæ”¹æˆ asyncï¼Œä¿è­‰åˆ‡ tab æ™‚ä¹Ÿæ˜¯å…ˆè¨‚å–®ã€å¾Œé€šçŸ¥
      async function switchTab(tab) {
        currentTab = tab;
        document
          .getElementById("buyerTab")
          .classList.toggle("active", tab === "buyer");
        document
          .getElementById("sellerTab")
          .classList.toggle("active", tab === "seller");
        await loadAll();
      }
      // 1) æŠŠ loadAll æ”¹æˆ asyncï¼Œä¸¦åœ¨è£¡é¢ç”¨ await
      async function loadAll() {
        // ç­‰ fetchOrders æ‹¿å®Œè³‡æ–™ã€ç•«é¢æ›´æ–°å¾Œï¼Œæ‰æ¥è‘— loadNotifications
        await fetchOrders();
        await loadNotifications();
      }

      async function fetchOrders() {
        const endpoint =
          currentTab === "buyer" ? "/api/buyerOrders" : "/api/sellerOrders";
        const res = await fetch(`${endpoint}?member_id=${memberId}`);
        const orders = await res.json();
        renderOrders(orders);
      }

      function renderOrders(orders) {
        const tbody = document.getElementById("orderTableBody");
        tbody.innerHTML = "";
        if (!orders || orders.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6">ç›®å‰æ²’æœ‰è¨‚å–®</td></tr>';
          return;
        }
        orders.forEach((o) => {
          const tr = document.createElement("tr");
          const info = `${o.game_date} ${o.start_time} ${o.team_home} vs ${o.team_away}`;
          tr.innerHTML = `
          <td>#${o.order_id}</td>
          <td>${info}</td>
          <td class="${
            o.order_status === "åª’åˆæˆåŠŸ" ? "status-success" : ""
          }">${o.order_status}</td>
          <td>${o.payment_status}</td>
          <td class="${
            o.shipment_status === "å·²å‡ºè²¨" ? "status-shipped" : ""
          }">${o.shipment_status}</td>
        `;
          const actionTd = document.createElement("td");
          if (currentTab === "seller") {
            // å·²ä»˜æ¬¾çš„è¨‚å–®é¡¯ç¤ºã€Œå‡ºè²¨ã€
            if (
              o.payment_status === "å·²ä»˜æ¬¾" &&
              o.shipment_status === "æœªå‡ºè²¨"
            ) {
              actionTd.append(btn("å‡ºè²¨", "btn-ship", () => ship(o.order_id)));
            }
            // æ‹’çµ•ï¼æ¥å—æŒ‰éˆ•ä¿ç•™
            actionTd.append(
              btn("æ¥å—", "btn-accept", () => upd(o.order_id, "accept")),
              btn("æ‹’çµ•", "btn-reject", () => upd(o.order_id, "reject"))
            );
          } else {
            // buyer
            // åª’åˆæˆåŠŸä¸”æœªä»˜æ¬¾ -> é¡¯ç¤ºä»˜æ¬¾æŒ‰éˆ•
            if (
              o.order_status === "åª’åˆæˆåŠŸ" &&
              o.payment_status === "æœªä»˜æ¬¾"
            ) {
              actionTd.append(btn("ä»˜æ¬¾", "btn-pay", () => pay(o.order_id)));
            } else {
              actionTd.append(btn("è©³æƒ…", "btn-detail", () => showModal(o)));
            }
          }
          tr.appendChild(actionTd);
          tbody.appendChild(tr);
        });
      }

      // è²·å®¶ä»˜æ¬¾
      async function pay(orderId) {
        try {
          const res = await fetch("/api/pay_order", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ order_id: orderId, buyer_id: memberId }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "ä»˜æ¬¾å¤±æ•—");
          loadAll();
        } catch (err) {
          alert(`${err.message}`);
        }
      }
      // buyer_id:memberIdçš„æ•ˆæœï¼Ÿ

      // è³£å®¶å‡ºè²¨
      async function ship(orderId) {
        try {
          const res = await fetch("/api/mark_shipped", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ order_id: orderId, seller_id: memberId }),
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "å‡ºè²¨å¤±æ•—");
          loadAll();
        } catch (err) {
          alert(`${err.message}`);
        }
      }

      function btn(text, cls, fn) {
        const b = document.createElement("button");
        b.className = cls;
        b.innerText = text;
        b.onclick = fn;
        return b;
      }

      async function upd(id, act) {
        try {
          // 1. ç™¼é€æ›´æ–°è¨‚å–®ç‹€æ…‹çš„è«‹æ±‚
          const res = await fetch("/api/order_status", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              order_id: id,
              action: act,
              seller_id: memberId, // å¸¶ä¸Šç›®å‰æ¨¡æ“¬çš„è³£å®¶ IDï¼Œå¾Œç«¯ç”¨ä¾†æª¢æŸ¥
            }),
          });

          // 2. è§£æå›æ‡‰
          const data = await res.json();
          if (!res.ok) {
            // å¦‚æœç‹€æ…‹ç¢¼ä¸æ˜¯ 2xxï¼Œå°±ä¸ŸéŒ¯èª¤ä¸¦é¡¯ç¤ºå¾Œç«¯å›å‚³çš„è¨Šæ¯
            throw new Error(data.detail || "æ“ä½œå¤±æ•—");
          }

          // 3. æˆåŠŸå¾Œï¼Œé‡æ–°æŠ“è¨‚å–®åˆ—è¡¨å’Œé€šçŸ¥æ¸…å–®
          await fetchOrders();
          await loadNotifications();
        } catch (err) {
          // 4. å¤±æ•—æ™‚å½ˆå‡ºæç¤º
          alert(`${err.message}`);
        }
      }
      // èˆŠç‰ˆçš„upd function
      // async function upd(id, act) {
      //   await fetch("/api/order_status", {
      //     method: "POST",
      //     headers: { "Content-Type": "application/json" },
      //     body: JSON.stringify({ order_id: id, action: act }),
      //   });
      //   fetchOrders();
      //   loadNotifications();
      // }

      function showModal(o) {
        document.getElementById("modalBody").innerHTML = `
        <p>è¨‚å–®ç·¨è™Ÿï¼š#${o.order_id}</p>
        <p>è³½äº‹ï¼š${o.game_date} ${o.start_time} ${o.team_home} vs ${o.team_away}</p>
        <p>åª’åˆç‹€æ…‹ï¼š${o.order_status}</p>
        <p>ä»˜æ¬¾ç‹€æ…‹ï¼š${o.payment_status}</p>
        <p>å‡ºè²¨ç‹€æ…‹ï¼š${o.shipment_status}</p>
      `;
        document.getElementById("modalBg").style.display = "flex";
      }

      async function loadNotifications() {
        const res = await fetch(`/api/notifications?member_id=${memberId}`);
        const notes = await res.json();
        let c = 0;
        const ul = document.getElementById("notifList");
        ul.innerHTML = "";
        notes.forEach((n) => {
          const li = document.createElement("li");
          li.innerText = n.message;
          li.onclick = () => (location.href = n.url);
          ul.appendChild(li);
          if (!n.is_read) c++;
        });
        document.getElementById("notifCount").innerText = c;
      }

      async function toggleNotif(e) {
        e.stopPropagation();
        const dd = document.getElementById("notifDropdown");
        // å¦‚æœå¾éš±è—è½‰åˆ°é¡¯ç¤ºï¼Œå°±æ¨™è¨˜å·²è®€
        if (dd.style.display !== "block") {
          // 1) æ¨™è¨˜å·²è®€
          await fetch(`/api/mark_notifications_read?member_id=${memberId}`, {
            method: "POST",
          });
          // 2) é‡æ–°æŠ“ä¸€æ¬¡é€šçŸ¥åˆ—è¡¨
          await loadNotifications();
        }
        dd.style.display = dd.style.display === "block" ? "none" : "block";
      }
      // æ¯æ¬¡é–‹ä¸‹æ‹‰é¸å–®å°±æŠŠ is_read=false çš„é€šçŸ¥å…¨éƒ¨æ”¹æˆ trueã€‚
      // å†é‡æ–°è·‘ä¸€æ¬¡ loadNotifications() æ›´æ–°ç´…é»å’Œåˆ—è¡¨ã€‚

      document.addEventListener("DOMContentLoaded", async () => {
        await loadAll();
      });
    </script>
  </body>
</html>
